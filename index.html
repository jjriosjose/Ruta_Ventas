<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>üìà KPI ‚Äî Resumen Semanal (v3)</title>
<style>
:root{--bg:#0b1220;--card:#131c2b;--muted:#90a0b7;--text:#e8eef9;--chip:#1f2a40;--accent:#12d3b7}
*{box-sizing:border-box} body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;background:linear-gradient(180deg,#0b1220 0%,#0e1626 100%);color:var(--text)}
.container{max-width:1200px;margin:0 auto;padding:16px}
.card{background:rgba(19,28,43,.95);border:1px solid #22304a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:12px}
.hbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.title{margin:0 0 8px}
.badge{padding:2px 8px;border-radius:999px;background:var(--chip);color:#a7b3c8;font-size:12px}
.filters{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
select,input{width:100%;padding:10px;border-radius:10px;border:1px solid #314463;background:#0f1726;color:var(--text);outline:none}
.btn{border:1px solid #28405f;background:#0f1726;color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;transition:.15s;font-weight:600;font-size:12px}
.btn:hover{transform:translateY(-1px)} .btn-primary{background:linear-gradient(135deg,#1aa27f,#2dd4bf);border:0;color:#072018}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.col{flex:1 1 320px;min-width:280px}
.kpi{display:grid;place-items:center;text-align:center;padding:12px}
.kpi .lbl{color:var(--muted);font-size:12px} .kpi .val{font-size:28px;font-weight:800}
.table{width:100%;border-collapse:collapse;font-size:13px;border:1px solid #22304a;border-radius:12px;overflow:hidden}
.table th,.table td{padding:8px 10px;border-bottom:1px solid #22304a}
.table th{position:sticky;top:0;background:#0f182a;color:#9fb1cc;z-index:1}
.pills{display:flex;gap:8px;margin:6px 0}
.pill{background:#101a2e;border:1px solid #2c3d5d;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px}
.pill.active{background:#1f2a40;border-color:#39527a}
.mono{font-variant-numeric:tabular-nums}
.footer{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.note{color:var(--muted);font-size:12px}
a{color:#2dd4bf;text-decoration:none}
</style>
</head>
<body>
  <div class="container">
    <div class="hbar">
      <h2 class="title">üìà KPI ‚Äî Resumen Semanal</h2>
      <span class="badge">v3</span>
      <span class="badge">Single-file</span>
      <span class="badge">Fuente: Google Sheets (CSV)</span>
      <div style="flex:1"></div>
      <button class="btn" id="btnExport">‚¨á Exportar CSV</button>
    </div>

    <div class="card">
      <div class="filters">
        <div><label>Semana</label><select id="fSemana"><option value="">Todas</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
        <div><label>Vendedor</label><select id="fVendedor"><option value="">Todos</option></select></div>
        <div><label>Gestor</label><select id="fGestor"><option value="">Todos</option></select></div>
        <div><label>Buscar</label><input id="fBuscar" placeholder="Cliente / C√≥digo / Empresa"/></div>
        <div style="display:flex;align-items:end"><button id="btnReset" class="btn">Limpiar</button></div>
        <div style="display:flex;align-items:end;justify-content:flex-end"><a href="index.html" class="btn">‚Üê Volver a la app</a></div>
      </div>

      <div class="row">
        <div class="col card kpi"><div class="lbl">A realizar (Itinerarios)</div><div id="kpiPlan" class="val mono">0</div></div>
        <div class="col card kpi"><div class="lbl">Realizadas (Llamadas)</div><div id="kpiDone" class="val mono">0</div></div>
        <div class="col card kpi"><div class="lbl">% Cobertura</div><div id="kpiCov" class="val mono">0%</div></div>
      </div>

      <div class="pills">
        <div id="tabResumen" class="pill active">Resumen por Gestor √ó Semana</div>
        <div id="tabPend" class="pill">Pendientes (Agenda)</div>
        <div id="tabReal" class="pill">Realizadas (Historial)</div>
      </div>

      <div id="viewResumen" style="max-height:60vh;overflow:auto;border-radius:10px;">
        <table class="table" id="tblResumen">
          <thead><tr>
            <th>Gestor</th><th>Semana</th><th>A realizar</th><th>Realizadas</th><th>% Cobertura</th><th>√öltima llamada</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="viewPend" style="display:none;max-height:60vh;overflow:auto;border-radius:10px;">
        <table class="table" id="tblPend">
          <thead><tr><th>Gestor</th><th>Semana</th><th>Cod</th><th>Cliente</th><th>Vendedor</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="viewReal" style="display:none;max-height:60vh;overflow:auto;border-radius:10px;">
        <table class="table" id="tblReal">
          <thead><tr><th>Fecha/Hora</th><th>Semana</th><th>Cliente</th><th>Cod</th><th>Vendedor</th><th>Gestor</th><th>Resultado</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer">
        <span class="note">Tip: Las llamadas se cuentan desde <code>localStorage.llamadas_records</code> (las que registres en la app).</span>
      </div>
    </div>
  </div>

<script>
// === Config: URLs de Google Sheets (CSV) ===
const CFG = {
  usuarios: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv",
  clientes: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1016315198&single=true&output=csv",
  calendario: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv"
};

// === Utils ===
function csvParse(text){
  const out=[], lines=text.split(/\\r?\\n/).filter(Boolean);
  if(!lines.length) return out;
  const split=(line)=>{const r=[];let cur="",q=false;for(let i=0;i<line.length;i++){const c=line[i],n=line[i+1];if(c=='"'){if(q&&n=='"'){cur+='"';i++;}else q=!q;}else if(c==","&&!q){r.push(cur);cur="";}else cur+=c;}r.push(cur);return r;};
  const headers=split(lines[0]).map(h=>h.trim());
  for(let i=1;i<lines.length;i++){const vals=split(lines[i]);const row={};headers.forEach((h,idx)=>row[h]=vals[idx]??"");out.push(row);}
  return out;
}
async function getCSV(url){const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return csvParse(await r.text());}
function norm(s){return String(s||"").trim();}
function toLower(s){return String(s||"").normalize("NFD").replace(/[\\u0300-\\u036f]/g,"").toLowerCase();}
function groupBy(arr, keyFn){
  const m=new Map(); for(const x of arr){const k=keyFn(x); m.set(k,(m.get(k)||[]).concat([x]));} return m;
}
function sum(arr, fn){let t=0; for(const x of arr) t+= (fn? fn(x): x); return t; }
function latest(arr, fn){let best=null; for(const x of arr){const v=fn?fn(x):x; if(v && (!best || new Date(v)>new Date(best))) best=v;} return best; }
function fmtPct(x){return (isFinite(x)? x.toFixed(0):"0")+"%";}
function csvEscape(v){if(v==null)return""; const s=String(v); return (/[",\\n]/.test(s))?('"'+s.replace(/"/g,'""')+'"'):s;}

// === Flexible getters for columns (calendario/clientes) ===
function getVal(row, keys){for(const k of keys){if(k in row && row[k]!=="") return row[k]; const kk=Object.keys(row).find(h=>toLower(h)===toLower(k)); if(kk) return row[kk];} return "";}
const K = {
  cod: ["Cod Empresa","codigo","C√≥digo","Cod","ID","Id","codigo_npg","Cod_Empresa"],
  nombre: ["RazonSocial","Cliente","Nombre","razonsocial"],
  vendedor: ["vendedor","Vendedor","VENDEDOR"],
  gestor: ["gestor_servicio","Gestor","gestor"],
  semana: ["SEMANA","Semana","semana"],
  dia: ["DIA","D√≠a","Dia","d√≠a"]
};

// === Global data ===
let DATA = {clientes:[], calendario:[], calls:[]};

// === Load ===
async function loadAll(){
  const [clientes, calendario] = await Promise.all([getCSV(CFG.clientes), getCSV(CFG.calendario)]);
  let calls = []; try{ calls = JSON.parse(localStorage.getItem("llamadas_records")||"[]"); }catch(_){ calls=[]; }
  DATA = {clientes, calendario, calls};
  buildFilters(); render();
}

// === Filters UI ===
function uniq(sortedArr){return [...new Set(sortedArr.filter(Boolean))].sort((a,b)=> String(a).localeCompare(String(b),"es",{numeric:true}));}
function buildFilters(){
  const vSel=document.getElementById("fVendedor"), gSel=document.getElementById("fGestor");
  const vVals=uniq(DATA.calendario.map(r=> norm(getVal(r,K.vendedor)) ));
  const gVals=uniq(DATA.calendario.map(r=> norm(getVal(r,K.gestor)) ));
  vSel.innerHTML = '<option value="">Todos</option>'+vVals.map(v=>`<option>${v}</option>`).join("");
  gSel.innerHTML = '<option value="">Todos</option>'+gVals.map(v=>`<option>${v}</option>`).join("");
}
function getFilters(){
  return {
    semana: norm(document.getElementById("fSemana").value),
    vendedor: norm(document.getElementById("fVendedor").value),
    gestor: norm(document.getElementById("fGestor").value),
    search: toLower(document.getElementById("fBuscar").value)
  };
}

// === Core aggregation ===
function filteredCalendario(){
  const f=getFilters();
  return DATA.calendario.filter(r=>{
    const sem=norm(getVal(r,K.semana));
    const vend=norm(getVal(r,K.vendedor));
    const ges=norm(getVal(r,K.gestor));
    const cod=norm(getVal(r,K.cod));
    const cli=norm(getVal(r,K.nombre));
    if(f.semana && sem!==f.semana) return false;
    if(f.vendedor && vend!==f.vendedor) return false;
    if(f.gestor && ges!==f.gestor) return false;
    if(f.search && !(toLower(cli).includes(f.search) || toLower(cod).includes(f.search))) return false;
    return true;
  });
}
function filteredCalls(){
  const f=getFilters();
  return DATA.calls.filter(r=>{
    const wk = String(r.semana||"");
    const vend=norm(r.vendedor||"");
    const ges=norm(r.gestor_servicio||"");
    if(f.semana && wk!==f.semana) return false;
    if(f.vendedor && vend!==f.vendedor) return false;
    if(f.gestor && ges!==f.gestor) return false;
    return true;
  });
}

// Build summary rows Gestor √ó Semana
function buildResumen(){
  const cal = filteredCalendario();
  const calls = filteredCalls();
  const planMap = new Map(); // key: gestor|semana -> count
  for(const r of cal){
    const g=norm(getVal(r,K.gestor)), w=norm(getVal(r,K.semana)); const key=g+"|"+w;
    planMap.set(key, (planMap.get(key)||0)+1);
  }
  const doneMap = new Map(); const lastMap=new Map();
  for(const c of calls){
    const g=norm(c.gestor_servicio||""), w=String(c.semana||""); const key=g+"|"+w;
    doneMap.set(key, (doneMap.get(key)||0)+1);
    const cur = lastMap.get(key); const now = c.fecha_hora||"";
    if(!cur || (new Date(now)>new Date(cur))) lastMap.set(key, now);
  }
  const keys = new Set([...planMap.keys(), ...doneMap.keys()]);
  const rows=[];
  for(const k of keys){
    const [gestor, semana] = k.split("|");
    const asign = planMap.get(k)||0;
    const real = doneMap.get(k)||0;
    const pct = asign ? (real/asign*100) : (real?100:0);
    rows.push({gestor, semana, asign, real, pct, last:lastMap.get(k)||""});
  }
  rows.sort((a,b)=> a.gestor.localeCompare(b.gestor,"es",{numeric:true}) || String(a.semana).localeCompare(String(b.semana),"es",{numeric:true}));
  return rows;
}

// Build pendientes detail
function buildPendientes(){
  const cal = filteredCalendario();
  const grouped = groupBy(cal, r=> norm(getVal(r,K.gestor))+"|"+norm(getVal(r,K.semana)));
  const rows=[];
  for(const [key,items] of grouped.entries()){
    const [gestor, semana] = key.split("|");
    for(const r of items){
      rows.push({
        gestor, semana,
        cod: norm(getVal(r,K.cod)),
        nombre: norm(getVal(r,K.nombre)),
        vendedor: norm(getVal(r,K.vendedor))
      });
    }
  }
  rows.sort((a,b)=> a.gestor.localeCompare(b.gestor,"es",{numeric:true}) || a.semana.localeCompare(b.semana,"es",{numeric:true}) || a.nombre.localeCompare(b.nombre,"es",{numeric:true}));
  return rows;
}

// Build realizadas detail
function buildRealizadas(){
  const calls = filteredCalls().slice().sort((a,b)=> new Date(b.fecha_hora||0)-new Date(a.fecha_hora||0));
  return calls.map(c=>({
    fecha: c.fecha_hora||"", semana: String(c.semana||""), cliente:c.cliente||"", cod:c.cod_empresa||"", vendedor:c.vendedor||"", gestor:c.gestor_servicio||"", res:c.resultado||""
  }));
}

// === Render ===
function render(){
  // resumen
  const rows = buildResumen();
  const tb = document.querySelector("#tblResumen tbody");
  tb.innerHTML = rows.map(r=>`<tr>
    <td>${r.gestor||"-"}</td>
    <td>${r.semana||"-"}</td>
    <td class="mono">${r.asign}</td>
    <td class="mono">${r.real}</td>
    <td class="mono">${r.pct.toFixed(0)}%</td>
    <td>${r.last ? new Date(r.last).toLocaleString() : "-"}</td>
  </tr>`).join("");

  // KPIs
  const plan = sum(rows, r=>r.asign);
  const done = sum(rows, r=>r.real);
  const cov = plan ? (done/plan*100) : (done?100:0);
  document.getElementById("kpiPlan").textContent = plan;
  document.getElementById("kpiDone").textContent = done;
  document.getElementById("kpiCov").textContent = cov.toFixed(0)+"%";

  // pendientes
  const pend = buildPendientes();
  const tbP = document.querySelector("#tblPend tbody");
  tbP.innerHTML = pend.map(r=>`<tr>
    <td>${r.gestor}</td><td>${r.semana}</td><td>${r.cod}</td><td>${r.nombre}</td><td>${r.vendedor}</td>
  </tr>`).join("");

  // realizadas
  const real = buildRealizadas();
  const tbR = document.querySelector("#tblReal tbody");
  tbR.innerHTML = real.map(r=>`<tr>
    <td>${r.fecha? new Date(r.fecha).toLocaleString():""}</td><td>${r.semana}</td><td>${r.cliente}</td><td>${r.cod}</td>
    <td>${r.vendedor}</td><td>${r.gestor}</td><td>${r.res}</td>
  </tr>`).join("");
}

// === Events ===
["fSemana","fVendedor","fGestor"].forEach(id=>document.getElementById(id).addEventListener("change", render));
document.getElementById("fBuscar").addEventListener("input", ()=>{ clearTimeout(window.__t); window.__t=setTimeout(render,150); });
document.getElementById("btnReset").addEventListener("click", ()=>{
  document.getElementById("fSemana").value="";
  document.getElementById("fVendedor").value="";
  document.getElementById("fGestor").value="";
  document.getElementById("fBuscar").value="";
  render();
});
function showTab(tab){
  document.getElementById("viewResumen").style.display = tab==="resumen"?"block":"none";
  document.getElementById("viewPend").style.display    = tab==="pend"?"block":"none";
  document.getElementById("viewReal").style.display    = tab==="real"?"block":"none";
  document.getElementById("tabResumen").classList.toggle("active", tab==="resumen");
  document.getElementById("tabPend").classList.toggle("active", tab==="pend");
  document.getElementById("tabReal").classList.toggle("active", tab==="real");
}
document.getElementById("tabResumen").addEventListener("click", ()=>showTab("resumen"));
document.getElementById("tabPend").addEventListener("click", ()=>showTab("pend"));
document.getElementById("tabReal").addEventListener("click", ()=>showTab("real"));

document.getElementById("btnExport").addEventListener("click", ()=>{
  const rows=[...document.querySelectorAll("#tblResumen tbody tr")].map(tr=>[...tr.children].map(td=>td.textContent));
  const headers=["Gestor","Semana","A realizar","Realizadas","% Cobertura","√öltima llamada"];
  const csv=[headers, ...rows].map(r=>r.map(csvEscape).join(",")).join("\\n");
  const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8;"}));
  a.download="kpi_resumen_semanal.csv"; a.click(); URL.revokeObjectURL(a.href);
});

// === Go! ===
loadAll().catch(err=>{
  alert("Error cargando datos: "+err.message+"\\nPuedes editar las URLs en el bloque CFG del archivo.");
});
</script>

</body>
</html>
