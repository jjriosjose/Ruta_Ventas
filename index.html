<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestión de Llamadas — LLAMADAS v1.6.0</title>
<style>
  :root{
    --bg:#0b1220;--panel:#0e1726;--card:#111c2e;--muted:#94a3b8;--txt:#e2e8f0;
    --brand:#00c2a8;--accent:#38bdf8;--red:#ef4444;--green:#10b981;--border:#1e293b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--txt)}
  header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
  header h1{font-size:20px;margin:0;font-weight:700}
  .badge{font-size:12px;padding:4px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--border);color:var(--muted)}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
  .btn{padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--txt);cursor:pointer}
  .btn.primary{background:var(--brand);border-color:transparent;color:#001514;font-weight:700}
  .btn.ghost{background:transparent}
  .btn.small{padding:7px 10px;font-size:13px}
  select,input[type="search"]{background:var(--panel);color:var(--txt);border:1px solid var(--border);padding:9px 10px;border-radius:10px}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:10px 0 18px}
  .kpi{background:var(--card);border:1px solid var(--border);padding:16px;border-radius:14px}
  .kpi h3{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:600}
  .kpi .val{font-size:36px;font-weight:800;letter-spacing:.5px}
  .kpi.center{grid-column:1/-1;text-align:center}
  .kpi .percent{font-size:42px;color:var(--brand)}
  .board{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
  .col{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px;min-height:120px}
  .col h4{margin:0 0 10px 0;font-size:12px;color:var(--muted);letter-spacing:.6px}
  .card{border:1px solid var(--border);background:var(--card);border-radius:12px;padding:10px;margin:8px 0}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle}
  .dot.red{background:var(--red)} .dot.green{background:var(--green)}
  .title{font-weight:800}
  .meta{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
  th{background:var(--card);color:var(--muted);font-weight:700}
  tfoot td{background:var(--card);font-weight:800}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:18px}
  .muted{color:var(--muted)}
  .right{display:flex;gap:8px;margin-left:auto}
  dialog{border:1px solid var(--border);background:var(--panel);color:var(--txt);border-radius:12px;padding:16px;max-width:680px;width:90%}
  dialog::backdrop{background:rgb(2 6 23 / .4)}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .row label{font-size:12px;color:var(--muted);display:block}
  .row input{width:100%}
  .pill{padding:3px 8px;border-radius:999px;background:var(--card);border:1px solid var(--border);font-size:12px;color:var(--muted)}
  .link{color:var(--accent);cursor:pointer}
  @media (max-width:930px){.board{grid-template-columns:repeat(2,1fr)} .kpis{grid-template-columns:1fr} .grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <img src="https://dummyimage.com/36x36/00c2a8/001514&text=K" width="36" height="36" alt="Logo" style="border-radius:8px">
  <h1>Gestión de Llamadas</h1>
  <span class="badge">LLAMADAS v1.6.0</span>
  <span class="badge">Single‑File</span>
  <span class="pill" id="pillMode">modo: demo</span>
  <div class="right">
    <button class="btn small" id="btnConfig">⚙️ Configurar</button>
    <button class="btn small" id="btnReload">↻ Recargar</button>
  </div>
</header>

<div class="wrap">

  <div class="toolbar">
    <select id="fSemana">
      <option value="todas">Semana: Todas</option>
      <option value="1">Semana 1</option>
      <option value="2">Semana 2</option>
      <option value="3">Semana 3</option>
      <option value="4">Semana 4</option>
    </select>
    <select id="fVendedor"><option value="todos">Vendedor: Todos</option></select>
    <select id="fGestor"><option value="todos">Gestor: Todos</option></select>
    <input id="fBuscar" type="search" placeholder="Buscar nombre o código…">
    <button class="btn" id="btnExportAgenda">Exportar Excel — Agenda</button>
    <button class="btn" id="btnExportResumen">Exportar Excel — Resumen</button>
  </div>

  <div class="kpis">
    <div class="kpi">
      <h3>A realizar (Itinerarios)</h3>
      <div class="val" id="kpiRealizar">0</div>
    </div>
    <div class="kpi">
      <h3>Realizadas (Llamadas)</h3>
      <div class="val" id="kpiRealizadas">0</div>
    </div>
    <div class="kpi">
      <h3>Llamadas (Total)</h3>
      <div class="val" id="kpiTotal">0</div>
    </div>
    <div class="kpi center">
      <h3>% Cobertura</h3>
      <div class="percent" id="kpiCobertura">0%</div>
    </div>
  </div>

  <h3 class="muted" style="margin:4px 0 10px">Detalle de llamadas — Clientes</h3>
  <div class="board" id="board">
    <!-- columnas lunes..domingo -->
  </div>

  <div class="grid2">
    <div>
      <h3 class="muted" style="margin:10px 0">Resumen por gestor / semana</h3>
      <table id="tblResumen">
        <thead>
          <tr>
            <th>Gestor</th>
            <th>Semana</th>
            <th>A realizar</th>
            <th>Realizadas</th>
            <th>% Cobertura</th>
            <th>Última llamada</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div>
      <h3 class="muted" style="margin:10px 0">Leyenda</h3>
      <div class="card"><span class="dot red"></span> No gestionado (no hay llamada registrada para el cliente en la semana)</div>
      <div class="card"><span class="dot green"></span> Gestionado (existe llamada registrada para el cliente en la misma semana)</div>
      <div class="card">La cobertura se calcula como <strong>clientes gestionados del itinerario / clientes del itinerario</strong> bajo los filtros activos.</div>
      <div class="card">Los KPIs superiores y esta tabla usan <strong>exactamente la misma función de agregación</strong> (no hay duplicación de lógica).</div>
    </div>
  </div>
</div>

<dialog id="dlgConfig">
  <h3>Configuración de fuentes (CSV publicados de Google Sheets)</h3>
  <p class="muted">Deja en blanco para usar datos de <em>demo</em>. Cuando completes, se guardará en tu navegador y la app trabajará en modo <strong>cloud</strong>.</p>
  <div class="row">
    <div style="flex:1 1 100%">
      <label>URL CSV — Agenda (itinerarios por cliente, con <code>cod</code>, <code>cliente</code>, <code>vendedor</code>, <code>gestor</code>, <code>semana</code>, <code>dia</code>)</label>
      <input id="cfgAgenda" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
    </div>
    <div style="flex:1 1 100%">
      <label>URL CSV — Llamadas (histórico, con <code>cod</code>, <code>cliente</code>, <code>vendedor</code>, <code>gestor</code>, <code>semana</code>, <code>fecha</code>)</label>
      <input id="cfgCalls" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
    </div>
  </div>
  <div class="row">
    <button class="btn primary" id="cfgSave">Guardar & Recargar</button>
    <button class="btn ghost" id="cfgClear">Borrar configuración</button>
    <button class="btn" id="cfgClose">Cerrar</button>
  </div>
</dialog>

<script>
/* ---------- utilidades ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmtPct = n => isNaN(n)? '0%' : (Math.round(n*1000)/10)+'%';
const groupBy = (arr, keyFn) => arr.reduce((m,it)=>{
  const k = keyFn(it); (m[k]??=[]).push(it); return m;
}, {});
const toWeekNumber = v => {
  const n = parseInt(v,10);
  if (!Number.isFinite(n) || n<1) return 1;
  return Math.min(4, Math.max(1,n));
};
const normalize = r => ({
  cod:(r.cod||r.codigo||r.COD||'').toString().trim(),
  cliente:(r.cliente||r.Cliente||r.nombre||'').toString().trim(),
  vendedor:(r.vendedor||r.Vendedor||'').toString().trim().toUpperCase(),
  gestor:(r.gestor||r.Gestor||'').toString().trim().toUpperCase(),
  semana: toWeekNumber(r.semana||r['N Semana']||r.n_semana||r.N_Semana||r.ns||1),
  dia: (r.dia||r.Dia||r.Día||r.DIA||'').toString().trim().toUpperCase(),
  fecha: r.fecha || r['Fecha/Hora'] || r['Fecha'] || r.datetime || ''
});

/* ---------- demo data (se carga si no hay config) ---------- */
const DEMO = {
  agenda: [
    {cod:'1001', cliente:'CASA MIREYA', vendedor:'CARLOS', gestor:'EVELYN', semana:1, dia:'LUNES'},
    {cod:'1004', cliente:'CASA CONSUELO', vendedor:'CARLOS', gestor:'RYAN', semana:2, dia:'MARTES'},
    {cod:'1002', cliente:'ALMACENES EL CANAL', vendedor:'JOSE', gestor:'RYAN', semana:1, dia:'JUEVES'},
    {cod:'1003', cliente:'ACCESORIOS INKA', vendedor:'CESAR', gestor:'DIOGENES', semana:2, dia:'VIERNES'},
    {cod:'1005', cliente:'ALMACENES CCN', vendedor:'CARLOS', gestor:'EVELYN', semana:3, dia:'VIERNES'}
  ],
  calls: [
    {cod:'1001', cliente:'CASA MIREYA', vendedor:'CARLOS', gestor:'MANUEL', semana:1, fecha:'2025-09-21T10:00:00'},
    {cod:'1002', cliente:'ALMACENES EL CANAL', vendedor:'JOSE', gestor:'RYAN', semana:1, fecha:'2025-09-26T09:01:00'},
    {cod:'1003', cliente:'ACCESORIOS INKA', vendedor:'CESAR', gestor:'DIOGENES', semana:2, fecha:'2025-09-25T15:53:00'}
  ]
};

/* ---------- estado ---------- */
let agendaRows = [];
let callRows = [];
let state = { semana:'todas', vendedor:'todos', gestor:'todos', search:'' };

/* ---------- carga de datos ---------- */
async function fetchCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  const text = await res.text();
  // parse simple CSV (no comillas anidadas)
  const [head,...lines] = text.split(/\r?\n/).filter(Boolean);
  const cols = head.split(',').map(h=>h.trim());
  return lines.map(line=>{
    const vals = line.split(','); const o={};
    cols.forEach((k,i)=> o[k]= (vals[i]??'').trim() );
    return o;
  });
}
async function loadData(){
  const cfg = JSON.parse(localStorage.getItem('llamadas_cfg')||'{}');
  if (cfg.agenda && cfg.calls){
    $('#pillMode').textContent = 'usuarios: online • modo cloud';
    try{
      const [a,c] = await Promise.all([fetchCSV(cfg.agenda), fetchCSV(cfg.calls)]);
      agendaRows = a.map(normalize);
      callRows = c.map(normalize);
    }catch(e){
      console.error(e);
      alert('No se pudieron cargar las hojas. Se usará modo demo.');
      agendaRows = DEMO.agenda.map(normalize);
      callRows = DEMO.calls.map(normalize);
      $('#pillMode').textContent = 'modo: demo';
    }
  }else{
    $('#pillMode').textContent = 'modo: demo';
    agendaRows = DEMO.agenda.map(normalize);
    callRows = DEMO.calls.map(normalize);
  }
  hydrateFilters();
  renderAll();
}
function hydrateFilters(){
  const uniq = (arr, k) => Array.from(new Set(arr.map(r=>r[k]).filter(Boolean))).sort();
  const vend = uniq(agendaRows.concat(callRows),'vendedor');
  const gest = uniq(agendaRows.concat(callRows),'gestor');
  const fV = $('#fVendedor'); fV.innerHTML = '<option value="todos">Vendedor: Todos</option>'+vend.map(v=>`<option>${v}</option>`).join('');
  const fG = $('#fGestor'); fG.innerHTML = '<option value="todos">Gestor: Todos</option>'+gest.map(v=>`<option>${v}</option>`).join('');
}

/* ---------- filtros ---------- */
function passesFilters(row){
  if (state.semana!=='todas' && row.semana !== Number(state.semana)) return false;
  if (state.vendedor!=='todos' && row.vendedor !== state.vendedor) return false;
  if (state.gestor!=='todos' && row.gestor !== state.gestor) return false;
  if (state.search){
    const s = state.search.toLowerCase();
    if (!row.cliente.toLowerCase().includes(s) && !row.cod.toLowerCase().includes(s)) return false;
  }
  return true;
}

/* ---------- motor unificado de KPIs + tabla ---------- */
function computeModel(){
  // Filtrar agenda y llamadas con los mismos criterios
  const A = agendaRows.filter(passesFilters);
  const C = callRows.filter(passesFilters);

  // Mapa de llamadas por (cod|semana) para match 1:1 con itinerario
  const key = (r)=> `${r.cod}|${r.semana}`;
  const callByKey = new Map();
  C.forEach(r=> callByKey.set(key(r), (callByKey.get(key(r))||[]).concat(r)) );

  // En agenda, considerar "gestionado" si hay al menos 1 call con misma semana
  const gestionados = new Set();
  A.forEach(r => { if (callByKey.has(key(r))) gestionados.add(key(r)); });

  // Totales KPI
  const kpiARealizar = A.length;
  const kpiRealizadas = gestionados.size; // clientes gestionados (únicos por cod|semana)
  const kpiLlamadasTotal = C.length;      // total de llamadas (no único)

  const cobertura = kpiARealizar ? (kpiRealizadas / kpiARealizar) : 0;

  // Resumen por gestor / semana
  const groups = groupBy(A, r=> `${r.gestor}|${r.semana}`);
  const rows = [];
  Object.entries(groups).forEach(([gk, items])=>{
    const [gestor, semanaStr] = gk.split('|');
    const semana = Number(semanaStr);
    const realizar = items.length;
    let realizadas = 0;
    let ultima = '';
    items.forEach(it=>{
      const ks = key(it);
      if (callByKey.has(ks)){
        realizadas += 1;
        // tomar la fecha más reciente de esas llamadas
        const last = callByKey.get(ks).map(x=>x.fecha).filter(Boolean).sort().pop();
        if (last && last > ultima) ultima = last;
      }
    });
    const pct = realizar? (realizadas/realizar) : 0;
    rows.push({gestor, semana, realizar, realizadas, pct, ultima});
  });
  // Orden
  rows.sort((a,b)=> a.gestor.localeCompare(b.gestor)||a.semana-b.semana);

  return {kpiARealizar, kpiRealizadas, kpiLlamadasTotal, cobertura, rows, agenda:A, calls:C, callByKey};
}

/* ---------- render ---------- */
function renderAll(){
  const model = computeModel();
  // KPIs
  $('#kpiRealizar').textContent = model.kpiARealizar.toLocaleString('es');
  $('#kpiRealizadas').textContent = model.kpiRealizadas.toLocaleString('es');
  $('#kpiTotal').textContent = model.kpiLlamadasTotal.toLocaleString('es');
  $('#kpiCobertura').textContent = fmtPct(model.cobertura);

  // Calendario
  const days = ['LUNES','MARTES','MIERCOLES','JUEVES','VIERNES','SABADO','DOMINGO'];
  const board = $('#board'); board.innerHTML='';
  const colEls = {};
  days.forEach(d=>{
    const el = document.createElement('div'); el.className='col';
    el.innerHTML = `<h4>${d}</h4>`;
    board.appendChild(el); colEls[d]=el;
  });
  // Cards por día
  model.agenda.forEach(r=>{
    const managed = model.callByKey.has(`${r.cod}|${r.semana}`);
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div><span class="dot ${managed?'green':'red'}"></span><span class="title">${r.cliente}</span></div>
      <div class="meta">${r.cod} • ${r.vendedor} • ${r.gestor}</div>
      <div class="meta">Semana ${r.semana} — ${r.dia}</div>
    `;
    const day = colEls[r.dia] || colEls['LUNES'];
    day.appendChild(card);
  });

  // Tabla resumen
  const tb = $('#tblResumen tbody'); tb.innerHTML='';
  model.rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.gestor}</td>
      <td>${r.semana}</td>
      <td>${r.realizar}</td>
      <td>${r.realizadas}</td>
      <td>${fmtPct(r.pct)}</td>
      <td>${r.ultima? new Date(r.ultima).toLocaleString('es-DO') : ''}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ---------- exportación Excel (tabla → xls simple) ---------- */
function exportTableToExcel(tableId, filename='reporte.xls'){
  const table = document.getElementById(tableId);
  const html = table.outerHTML.replace(/ /g, '%20');
  const dataUri = 'data:application/vnd.ms-excel,' + html;
  const a = document.createElement('a');
  a.href = dataUri; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
}
$('#btnExportAgenda').addEventListener('click', ()=> exportTableToExcel('tblResumen','resumen.xls'));
$('#btnExportResumen').addEventListener('click', ()=> exportTableToExcel('tblResumen','resumen.xls'));

/* ---------- eventos UI ---------- */
$('#fSemana').addEventListener('change', e=>{ state.semana = e.target.value; renderAll(); });
$('#fVendedor').addEventListener('change', e=>{ state.vendedor = e.target.value; renderAll(); });
$('#fGestor').addEventListener('change', e=>{ state.gestor = e.target.value; renderAll(); });
$('#fBuscar').addEventListener('input', e=>{ state.search = e.target.value.trim(); renderAll(); });
$('#btnReload').addEventListener('click', loadData);

/* ---------- config ---------- */
const dlg = $('#dlgConfig');
$('#btnConfig').addEventListener('click', ()=>{
  const cfg = JSON.parse(localStorage.getItem('llamadas_cfg')||'{}');
  $('#cfgAgenda').value = cfg.agenda||'';
  $('#cfgCalls').value = cfg.calls||'';
  dlg.showModal();
});
$('#cfgSave').addEventListener('click', ()=>{
  const cfg = { agenda: $('#cfgAgenda').value.trim(), calls: $('#cfgCalls').value.trim() };
  localStorage.setItem('llamadas_cfg', JSON.stringify(cfg));
  dlg.close(); loadData();
});
$('#cfgClear').addEventListener('click', ()=>{
  localStorage.removeItem('llamadas_cfg'); dlg.close(); loadData();
});
$('#cfgClose').addEventListener('click', ()=> dlg.close());

/* ---------- inicio ---------- */
loadData();
</script>
</body>
</html>
