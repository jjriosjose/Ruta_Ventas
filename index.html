<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Llamadas - LLAMADAS v1.4.0</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root{ --bg:#0b1220; --card:#131c2b; --muted:#90a0b7; --text:#e8eef9; --primary:#2dd4bf; --danger:#ef4444; --chip:#1f2a40;}
    *{box-sizing:border-box;} body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg,#0b1220 0%,#0e1626 100%); color:var(--text);}
    a{ color: var(--primary); text-decoration: none;} .container{ max-width:1200px; margin:0 auto; padding:16px;}
    .app-title{ display:flex; align-items:center; gap:10px; margin:8px 0 16px;} .badge{ padding:2px 8px; border-radius:999px; background:var(--chip); color:#a7b3c8; font-size:12px;}
    .row{ display:flex; gap:16px; flex-wrap:wrap;} .col{ flex:1 1 320px; min-width:320px;}
    .card{ background:rgba(19,28,43,0.9); border:1px solid #22304a; border-radius:16px; padding:12px; box-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .title{ font-size:18px; margin:0 0 6px;} .muted{ color:#90a0b7; font-size:12px;}
    .grid{ display:grid; gap:8px;} .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr)); } .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr));}
    .filters{ display:grid; grid-template-columns: repeat(6,minmax(0,1fr)); gap:8px;}
    select,input[type="text"],input[type="password"],input[type="url"],textarea,input[type="number"],input[type="datetime-local"],input[type="date"],input[type="time"]{ width:100%; padding:10px; border-radius:10px; border:1px solid #314463; background:#0f1726; color:var(--text); outline:none;}
    textarea{ min-height:96px; resize:vertical; }
    .btn{ border:1px solid #28405f; background:#0f1726; color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; transition:.15s; font-weight:600; font-size:12px;}
    .btn:hover{ transform: translateY(-1px); } .btn[disabled]{ opacity:.6; cursor:not-allowed;}
    .btn-primary{ background: linear-gradient(135deg, #1aa27f, #2dd4bf); border:0; color:#072018;} .btn-danger{ background: linear-gradient(135deg, #c2410c, #ef4444); border:0; color:#fff;}
    .btn-soft{ background:#101a2e; border:1px solid #2c3d5d;} .chip{ padding:2px 8px; font-size:11px; border-radius:999px; background:var(--chip); color:#a7b3c8; border:1px solid #2a3a59;}
    #map{ width:100%; height:62vh; border-radius:14px; overflow:hidden; border:1px solid #20314f; background:#0b1220;}
    .table{ width:100%; border-collapse: collapse; font-size:12px; border:1px solid #22304a; border-radius:12px; overflow:hidden;}
    .table th,.table td{ padding:8px 10px; border-bottom:1px solid #22304a;} .table th{ color:#9fb1cc; background:#0f182a; position:sticky; top:0; z-index:1;}
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center;} .errbar{ position:fixed; left:8px; right:8px; bottom:8px; background:#2a1220; border:1px solid #6b273d; color:#ffd0df; padding:8px 10px; border-radius:12px; display:none;}
    .hidden{ display:none !important; } 
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:16px; z-index:10000; backdrop-filter: blur(2px);}
    .modal.hidden{ display:none !important; }
    details{ background:#0e1626; border:1px solid #22304a; border-radius:10px; padding:8px; }
    details > summary{ cursor:pointer; color:#b7c7e3; }
    .no-scroll{ overflow:hidden; }
    .modal .card{ max-height:90vh; overflow:auto; }
    /* Agenda styles */
    .kanban{ display:flex; gap:12px; }
    .kcol{ flex:1 1 0; background:#0e1626; border:1px solid #22304a; border-radius:12px; padding:10px; min-height:320px; }
    .kcol h4{ margin:0 0 8px; }
    .kcard{ background:#0f1726; border:1px solid #293a59; border-radius:12px; padding:10px; margin-bottom:8px; }
    .khead{ font-weight:700; margin-bottom:2px; }
    .kmeta{ color:#9fb1cc; font-size:12px; }
  
/* --- Calendar call status dot --- */
.cal-dot{display:inline-block;width:10px;height:10px;border-radius:9999px;margin-right:8px;vertical-align:middle;background:#d1d5db;}
.cal-dot.ok{background:#10b981;box-shadow:0 0 0 2px #a7f3d0 inset;}
.cal-dot.miss{background:#ef4444;box-shadow:0 0 0 2px #fecaca inset;}

</style>
<style id="theme-override-light">
/* === Light, professional theme override (no logic changes) === */
:root{
  --bg:#f6f8fc;
  --card:#ffffff;
  --muted:#64748b;
  --text:#0b1220;
  --primary:#14b8a6;
  --danger:#ef4444;
  --chip:#eef2f7;
}
body{
  background:linear-gradient(180deg,#f6f8fc 0%, #eef2f7 100%);
  color:var(--text);
}
.badge{
  background:var(--chip);
  color:#5b6779;
}
.card{
  background:var(--card);
  border:1px solid #e5e9f2;
  box-shadow: 0 6px 16px rgba(15,23,42,.06);
}
.muted{ color: var(--muted); }
select,
input[type="text"],
input[type="password"],
input[type="url"],
textarea,
input[type="number"],
input[type="datetime-local"],
input[type="date"],
input[type="time"]{
  background:#ffffff;
  border:1px solid #d7dde8;
  color:var(--text);
}
.btn{
  border:1px solid #dbe1ea;
  background:#ffffff;
  color:#0b1220;
}
.btn-soft{
  background:#f4f7fb;
  border:1px solid #e1e7f0;
  color:#0b1220;
}
.btn-primary{
  background: linear-gradient(135deg, #10b981, #14b8a6);
  border:0;
  color:#ffffff;
}
.btn-danger{
  background: linear-gradient(135deg, #dc2626, #ef4444);
  border:0;
  color:#ffffff;
}
.chip{
  background:var(--chip);
  color:#475569;
  border:1px solid #e2e8f0;
}
#map{
  border:1px solid #dbe1ea;
  background:#eef2f7;
}
.table{
  border:1px solid #e5e9f2;
}
.table th, .table td{
  border-bottom:1px solid #eef2f7;
}
.table th{
  color:#64748b;
  background:#f4f7fb;
}
.errbar{
  background:#fde8e8;
  border:1px solid #f8b4b4;
  color:#7f1d1d;
}
.modal{
  background:rgba(0,0,0,.35);
}
details{
  background:#f7fafc;
  border:1px solid #e2e8f0;
}
details > summary{
  color:#334155;
}
.kanban{ gap:12px; }
.kcol{
  background:#f7fafc;
  border:1px solid #e2e8f0;
}
.kcard{
  background:#ffffff;
  border:1px solid #e5e9f2;
}
.kmeta{
  color:#64748b;
}
</style>


<style id="safe-override-resumen">
/* Hide duplicated Reporte (Resumen) buttons only inside LOGIN */
#login #btnReporteResumen { display: none !important; }
/* Hide the standalone launcher button */
#btnOpenResumenSem { display: none !important; }
/* Force the Resumen (Sem) screen to stay hidden in main layout */
#screenResumenSem { display: none !important; }
/* Show Resumen as a full-screen overlay when body has the flag */
body.show-resumen #screenResumenSem {
  display: block !important;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 10000;
  overflow: auto;
  padding: 16px;
  backdrop-filter: blur(2px);
}
body.show-resumen #screenResumenSem > .card {
  width: min(1180px, 96vw);
  margin: 12px auto;
  max-height: 90vh;
  overflow: auto;
}
</style>

</head>
<body>
  <div class="container">
    <div class="app-title"><img alt="Almacenes Karaka" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANgAAABbCAMAAAAm2rupAAACfFBMVEX////dEyHuiZDlTVj2xMf74eP509X98PHfIi/qbHXwmJ7hMT3yp6zjP0vse4P0trroXWf//wD/8gD/+AD/7gD/+QDWACTlQiD/5wD0eSD//fPYCSExX9XjOSDwcx9JbL/eICCOm3j/9eD7t1TnSyDqWh/iMiP2lBj3gyL/3Jb2ihv/9NntZB8AAADubR//8ND8xWkAXS3/7sY4Y9D91ItCasVQc7fKyzj05Q2bpGr+3J47Zcvr3hZkfqNMb7v5oi7Fvz3vHST+9ej9z371kzf+46372wf93Kf8xG72ugzzpg/0bwz6rUD2jwrJpjzGADnCdUF8Vo1PgLvSbzH7sBH9zAvs/xV0oZNbe62psVvg1SKwtlNrg5mCk4X3nhX6hBrQkSuVfI67waf+/E+zpADRhAurfGWyw+jM3Oucn652dX6IhFrb12D/+XPd2qugXj6RdFt3mNa6urN8eXSXk4wlJi9UV3G3clOfmFjY1tKjvvFBPzw6SlV8VTmkc1xYa404VYfacBVykcWAkK9VWlyPNwDj7Pult8q1flGoo5aLw/KSmaBBT2rzn2DRWg3KnnrUucDHbo/0AAfxPwbYpL6oVRyzKg+jcHfdOQCGg7mff0DCICT/ZAOka4SvXhNZExOIFhlnEhNCDhDJTk24O1HB5Pt2su++rslGYypubSakfnmpvv1rjpnssp2uu3q3xtyqdCOJjx5CYyoAVDG+j07evijG1QqLsRMgdCZ/aBjCTS+tIVONYShOfJOZ6/99VlhsaZz/0LK9IETgRWSbM2hZWq3eqCSvUVSCexUDGTQ9SwC+ciOxjx8tTZ4gN3IlMQNelB+lewuoyxGk2Q/C7A9LAAASF0lEQVR4nN1ci3tTx5XX6C3LtixLyL6+SLq29UIIY4wtv5GvDcKyRJb6EWxZlpIGaif7goR2N95uGkMRaWgINY+m6+zWTWETWLemzULXKbtl04amDd12s//Qzr26dx73YbNJvnXdw/eB7535zZzfzDlnzswdYzBoyt6+PR1N2kU7WVpGDifCsfaO7dbji5YjqRDLcWxD9Mh2a/LFykg8wkbT6SjL/UkwOzra2to6OtLZ2c4ANuP2eNxjPn9q/3ar9XmlpZUJ+SP+hlA4HAK+MXdjY6PXnfWFcnu3W7PPJy25MMuyEX+EA6yPP+ZpFIk99WcgnNvRwXG4FfIKRYuxGBPLHP9Sj7u+vt7j7R2f4NlQrHVPy3br95mlvU3gNVlkoEw9fWJ6pjvfPTsY7HZHWR/rb8v1bbeCn1H6YoANMfGxOOQVyGYaZwvTyUPJuQF3ejIcaoiwkdjIdqv4maQl52fDsVgR8gqUis88++XnPPnu7oGek6eYABOLxcKAi+3ZbiU/i/QF4IoFvSsab2NKX5lfeP6FP/+L5577y78q/HWWiQl/2thIaidGx/YQy4zBySllmeLpMy++dPbsV78GXz//wqWJbJGJTgZiYV+ic7u1/L9LU2uEm4xGS/G/mTj2t2fWz75sWLS9DN9/9e++/veQarQYZRgQye28qD+ci0QyxWjpK4cGXzm0YDCsf+PVBeH9y4bCvqVodHIMrgIN4PDOs8WmVj83ViwxD+fP/e6cYWH+/L5vLwrvF87Mf/NCfCwajcZiITZGpvpWsyg26lEutJglEZ9s1JMaK2FcRihmK/zRjMUqN0ZCLao6YlE1xFeJhVjaw2w4no2fn0+Or68vlF/Y9+rrFoth4fzXzl987e3sZDEQjUMvJPJhmx2IUis9m8QnudQIJBH7rJafdLDCK6NTrmQ0GAAWk9yYkehH+JmuAxuwEw1g2RNgQZg59q3Fc/ML6/OvX/r6udpIQ9WtS3Dmmt64nC3GizE/IGdMVta+ObEq4alOQUyJNRhcSCtdYqB6M2K2GqoBLHtTfph4HHtzcRz61pXvnH/dvLx8dfnapX3n5xcMZ69n41GG46KEj6GGqjclViM8Ia11sHhKNyNWqa1DzEQ3QEh7GLAgsTSdnDdcunHVuWBz8sv8tYWLi+WFW+vXSzEm7GtoxVHRLDYotapDTNTfUqlbQxSrsOaKQnYH9BGHUyZWI/uPTMxuVRGT69gqFUTfq60iecHowQI2PFk4lCx/962s02awuaqt84vf+956eeHFU9FYgGPbiHXMITRkBZLq2sRqpWEW/nUQxTrYOimW2CSlTarpF5jRxOQ6ZkxMIU2tDWxxKu3pDSYXrDzvqDKZamEgMvJOq6H8D5NMLMFGonjHaRHacVacx7gpsbqK5RlxsQorvgBOIkZWXghB0mghiAG7TUEM1ZEqOFwqZtAU0+7G+tn+8bLBtLxyYxlKnaXm7bf+sbz+T/EYw7GBdly7onjFN5x6xIyi/dkEvesIYipsxcOIEEn6j1m2azFq1ti0fMxcsQqJKr2IGDoT3JTXmy+MnysbrMvc999ZXeG4GvvyjRfnX4uVEhwbzg3j2mIvLmmsXXrEqsRSQe9qgpgKS4VzPWImqxiCTDrEMDPgtFLERsJc2jPwrcWF9XPz5aplfuUH77zzA27Zbr41fT0BI2aYPPoQx1gI1uKc1OkRE3V3CDZnwcTUWOOTzJhJDjE6xAxmB2JGzllHlPNPefLny+Vy8tA5wy9uLPM8DIsO28L4wg85FrTlyKyDDK6gEgK0iIm6m5xC0MfE1FjJ85U+ViNnJxIxYlEwqupUxltqu5pQFWYeidKxzKWywXCuq2vB8NL3V1ecN6+Vb525BQ3KH28l00QrrZvYjyYx2e1rMTEtbGWdc1ayJqtZMyoKT1UqYrhOhZwTFUvSkuJAgMlmnzWUy+u9J2AAKb/48mLXP996t9rEcW0pesPioHUTQ0CFmFGKUhIxmYUVE9PCygo7TSaTHS3QlYhnJIghsCIqCgi7o9psrq4MEREa98a5lfduM9k70BQX7k2dPgPf/cvamz/6kZ3nuHg7fbJYSfUqVuCQWyItzCwTk0bQbkDENLE0WzrzACQxuaLCxwD9VEPo2pLiVw68x2RfWV84cz6QLf54fv3LT42lJ49lQxzLHKV4SQNcRVhlnR6xSqxyYGKaWHKp2pyYlBJuSqyGjIrDOb/v9l0mOzE9HnwlO1bf030vXT+VaWyMMrFIQzvFS5oGaZW3Sw/axCq6uzAxTSwUS62c3de4NiEmMVMTc8hwUzWla0sqwk/c3li6/eCV49lU/ezMrvRUfX06nUlAYv6c4f9FiK3VFwbviLH+nxz46caBjVL27TuFg83uqcxUPO1pnIz52cTo51F3e6Uz4Ut4H088eP9AWzTzVNfuufxa4V+PlcYyxbAvsoO/SsDc3sd4jyWe+clG1OvxDswUgrvHu92ZRJhj2UT71g38scr+w4ALpDOl9NSdmYGeek/9wMzcvampxkwM7tL8qT0d+/fvzLP7Pob1M8XM5L1CMJhcm8lDbp7GeACm+5Mw/Y0kAkzs8Ojw1u380UlngA0xTPGZ5MH+YDDYBbl197in2tI99392N3uVF4RLtO68U0XDHgZuI9Pege6h3rVksKurvytZmJkqPf63A+9vlD75oObmd24CLr4Dv7PvP8z5Eh6vt77e25OH5KaDXR/9vKEUeHDgwOmHF9enL956F4C2PphfSFJZBW3yo6kOt+VALx1kFyZKjC7FdhBKrTZQfq3fpQ5QkKbWEPige6BHoCaS6z7t5NkHp9pe+vfkYrl8/jWDg+NiR/ByX8mf8T6C2ExRCYHma1HsDuUBhQ5QTmkqXbpQHYcWUDVcfQH+ZnJ6rXlmKA/p1de7JwG/8v7Gu7fgNubKs/Pr1TwXEHyMJobOCwFWktgOAjPRg5IYpEafT+gBaWI4XUZJhlUHKEpHjHd29ff3dwWTg3O9QwPuNAdubJydP7e+vvjs5Tv/cY33p1oMSmKoPSKfJtNZ8hxMTUyhRpUOkCaGjihrNIH0kSKUIwwAp9cGk8F+QYKDvd1+Lv7G/PPH5+/84szzV67UgfAoqZ7YADYLIvGsI7ohTV6LGLlppoCEy9LEcJeYu0MHKEpn2NfQ6B3ID800F6YPdR08+JDj/rOcPL60ePzy/K1ry5w/elRFDLVIKkicVUvnV/rEqAF26gApYpiEbUugIMKp4uWBRi/MOeph0J/tXfuQ52quvFZ6M7lUujhv4kKpPko9I8WBmBkLpbjyGEMp9icAUsQ0urTpAUViuQj/4XRhrndWCB71Hrf3Kgs459GW8sU3Oox2EM4dodUTesFmQfgKdQpPFmgSIyq49IAkMRwnXDpAxYHpcCoC+C+J7pUcFGLj/UcsrPXLXzprq+s4LlSU12aSGD7uIlqqpbohTE2bmHFrIEkMH4vicqMeUJTRBMvfHJxOCu61e/fu/mCB40Hkrbc4KIF4Cp0NkHhk22QMkz6kSCZD+LJc2WE2V2E/xBZlooAmg7KA7lJNXA0UZW/K72vz5PNDQzO9zXOFweSveMBFW1NMhGtrPYIze6JhbBbkSiuXqwaWVMmKmJl0gITzEcQ0u9QFiiJsyMbcQuyA0cPr7elpAyxMNZpGovFWMqsn1ENmQYZYM90NoQA11ghr2hpIEDOqYJisGihKy+EI+PUJMe/ogYmVd5c3DHeYI3Aq6d0zoR4yC9JfpeZN1aoyihjKMpCG0iprcqmABDHVB0MMrHGpi0RiMHr4Ptrdn5wurM0JcuI0AAH19SmsHjILavKlVdaBJuBJiekDMTG0IpBdSiGsTgaSnwCgNLUHAIweyS4hdIjyK15rn4LVQ4kM1ZLkPEZ5cVH5kIIYMmOnLhATQ12SGY0MNKiAFWnJNbBhT75bCB7Nzb2z3WEAEu2qrSVWD5kFadTymJplhnYNpIFYe4x6QJzgY2KoS+KQTR4IF3INhcbCp9rL9xvFbYsgnvyK1tYSKYTMgjxPRsszPj+1qJDCA1oCZVdyqYBIeURMs0sXqq4CysRCwP5wHCYfM4I0F5I3eTamuueM1ENmQTmrHO3wT9UqpIFMn2xbAxExlNSQ66YRAY1KoCSdDOA/RD7WNdhsB2xIdcyB1JO7oxJ02VhMeC9Rq0LCCI1sCjmLCc2FCoiIofSf7BIDq5VtSjKcCrH8o/tDs0OC5HvcJZhUxZS2KLeNFiKHVrEDhweTEuk0Edm4WVFapwFExDS7VAMp3xCkL86xRbdHkF27PI099+CUtSlvlcqNozGn9opErEY5txJJSu2TAGViqEty3bRuAkTS3gZW5k7MwZjYPLdWSH7EcqxfeV9WpRuVTcuDKrCVo5tVDylcAZCBVURrdqIRkhgS0ok2AyJpyYX4n8Mk+KB4QlB4hQcwrTqsnXmg4aO2rLIX4G/S2NPVvEw2FdCqAVTNGLlSOTYBYmlvY/lfN/fOzA5153s8u4qc2svkxvFOllzGyDVI9kKHAimLkxx45yZAWV+8r7FsDlQdDxyNcYB92y0kwsLR6eyPv8sDwNBpldy2UWvPIkdxcUhlI6lRING4W9XAGi0gCh5oynC6ZdMCKo8HDDk/3DUfF3ct08lg/8GDH/E866dvOKO2tbZ8VMBFWZMOscqVr4rIq2wdBbQpiGl0uSkQEwuxXGDpYfDQoWRyfHBtrvepq4Bl26hL6YgY3hphX5V7Fj7+m5RxU0WMWAI3BSJiGucCxs2ASI5GQ2yotHRvYKBH+K0WaI5nnUCPGN614GWFuAtJSJUeMdXyrBAjXajV5aZAglkqzIayxwYG8t2zvXODwa5ChKfu8pHEkGHggdfsRfZlpBRxuGF5EiAmhpG2JwES0pELs+HSnUNCyA8WZvLuDFzKqDvpmBg2DDm8mTV7kT0CI/FBVtWTADExqxKovOUjifJ4AMp+uHlJTJyunOB7B2Z7fwhYZoRghtXDhiGHL6N2N9LwEkhkQBKyShsnAYkdtLJLPaDGfczRBAsSpYw3PzQDbbE/ucKzkUDuCKJGqKdaV+o0O5F9mUDiGbJsCnQpiWEilYiqvL5EAylpbQAsCC8Vuvph7tE71DMZ4n2gIdaqca6I7UBK+eyanSg/YBjJmhUrdmrjqKur4hPe7jieAEhKU84PANdw+exst/Aduic/+3Gc97EgFB/dr1IPNVuxaYt2J3IKRCLRSDueAEieK6K4K3Zp08GpjgfEGWO50tSjBx/vqu+Gxnio6ze/fZRgIbVEJYaQ6mFbFKe+WrMPxJtEoqpifHBpw2QgSQzbYvXWQEpGwyz/yeOxRxu/fzXY1d//u//6zb7f5yf9gJWuHZHqYVsU4yviaZQExQiLPtKyNZAkhidXmBSjLlB9cakT5sHXbzOl4qONb7/6zd/e/vhkPj/wdIZlK5/H6JMLbOIWwkzQcKHhdamQlJMhdVRA/BsEMhDnAJYtgZQcZQCb+OTCBMOcOnUv7XW73U+77/9hEmZWGp+RcHyvIopUh7uVytQDUsmxKbBWRQzbonFLICX74TY6fH1l5YOJn949+Yeek4//+/pjjyfqk7cvlHrYMJxajVqojrWHhASiRMlGASliZJfWLYCUDKcibGgC8GDl7tLJT0+urvh8K3fdMR8X36smRhiGWfFrOlRloEKSKxl10VcDSH+Dxl26tgLSAsNiw9IKz/M3mPTAKhDu5Kz2tPnkxIpuCxuGA6+yOLemfJlC4kBdvSWQJkZ06dgEqDoegGHR5xeJrSylu1fEy0YXekI++SCOJoYNw25D8UC94Rd9mUYSB3AoBFm0gTQxYtHTACKu6uOBzgQb+eQ6EIhN3ZeIDfh94RF6rqXZx4aBRpJYQ5B11qqQ+Gso1lQD6FAR09ob6QBpORpg+dsf3/DxqxOZ+zcEXuyFNCcHRYO8YkhTbZafjVXyD0SktZLvaCQGWrYCVut0WVu3BZCWjjiATnb4+uqFQObpVdHFPs2w6pPTHSfDOSYCuHB8aWlizP141bey+vh/HoFIfOf9Pq1ShkdSwt3L7MZ7xfv3Tz7uHvBOJWBQ3JkXTGnZ3x4NA9AwMfazT3elJwN+mO4HduIlTA050hpvAHwgA//2caFANDe6c+9x09LUB12NBSASjqXa93TsxNvAetLSmUokDrd2Hmn50zBCQjpy7Tv6v8oR5H8BrdnadapNpUwAAAAASUVORK5CYII=" style="height:28px; width:auto; object-fit:contain;"/> 
      <h2 style="margin:0;">Gesti√≥n de Llamadas</h2>
      <span class="badge">LLAMADAS v1.4.0</span>
      <span class="badge">Single-File</span>
    </div>

    <!-- LOGIN -->
    <section id="login" class="card">
      <h3 class="title">Ingreso</h3>
      <p class="muted">Conecta tus Google Sheets publicados (CSV) desde ‚öôÔ∏è <strong>Configurar</strong>. Demo: <code>demo / 1234</code> o <code>vendedor / 1234</code>.</p>
      <div class="grid grid-3">
        <div><label>Usuario</label><input id="loginUser" type="text" placeholder="ej: rmejia" autocomplete="username" /></div>
        <div><label>Contrase√±a</label><input id="loginPass" type="password" placeholder="********" autocomplete="current-password" /></div>
        <div class="grid"><label>&nbsp;</label><button id="btnLogin" class="btn btn-primary">Entrar</button></div>
      </div>
      <div class="toolbar" style="margin-top:6px;">
        <span class="chip">Modo: <span id="modeLabel">local</span></span>
        <span class="chip">Usuarios: <span id="usersCount">0</span></span>
        <button id="btnOpenConfig" class="btn btn-soft">‚öôÔ∏è Configurar</button>
      
<button id="btnReporteResumen" class="btn btn-soft">Reporte (Resumen)</button>
<button id="btnReporteResumen" class="btn btn-soft">Reporte (Resumen)</button></div>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <div class="card">
        <div class="toolbar">
          <button id="btnToggleFiltros" class="btn btn-soft">‚ò∞ Filtros</button>
          <div class="toolbar">
            <button id="btnAgenda" class="btn btn-soft">üóìÔ∏è Agenda</button>
            <button id="btnRegistrar" class="btn btn-soft" disabled>üìù Registrar llamada</button>
            <button id="btnReporte" class="btn btn-soft">üìä Reporte</button>
<button id="btnReporteResumen" class="btn btn-soft">Reporte (Resumen)</button>
            <button id="btnFicha" class="btn btn-soft">üëÅÔ∏è Ver ficha</button>
            <button id="btnNuevoCliente" class="btn btn-soft">‚ûï Nuevo cliente</button>
            <button id="btnExport" class="btn">‚≠≥ Exportar CSV</button>
            <button id="btnRestaurar" class="btn btn-danger">‚ü≤ Restaurar</button>
            <button id="btnOpenConfig2" class="btn btn-soft">‚öôÔ∏è Configurar</button>
            <button id="btnToggleLegend" class="btn btn-soft">üëÅÔ∏è Mostrar leyenda</button>
          </div>
          <div class="toolbar">
            <span class="chip">Clientes: <span id="statTotal">0</span></span>
            <span class="chip">Con coordenadas: <span id="statGeo">0</span></span>
            <span class="chip">Filtrados: <span id="statFilt">0</span></span>
          </div>
        </div>

        <div id="panelFiltros" class="card" style="margin-top:8px;">
          <div class="filters">
            <div><label>Semana</label><select id="fSemana"><option value="">Todas</option></select></div>
            <div><label>D√≠a</label><select id="fDia"><option value="">Todos</option></select></div>
            <div><label>Vendedor</label><select id="fVendedor"><option value="">Todos</option></select></div>
            <div><label>Gestor</label><select id="fGestor"><option value="">Todos</option></select></div>
            <div><label>Empresa</label><select id="fEmpresa"><option value="">Todas</option></select></div>
            <div><label>Buscar</label><input id="fBuscar" type="text" placeholder="Nombre o c√≥digo..." /></div>
          </div>
          <div style="margin-top:8px;" class="grid grid-2">
            <div><label>Cliente</label><select id="fCliente"><option value="">-- Seleccione --</option></select></div>
            <div class="toolbar hidden" id="legend"></div> <!-- hidden by default -->
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="col">
            <div id="map"></div>
            <div class="muted" id="hintZero" style="display:none; margin-top:6px;">No hay clientes con coordenadas en el filtro.</div>
          </div>
          <div class="col card">
            <h3 class="title">Clientes filtrados</h3>
            <div style="max-height:60vh; overflow:auto; border-radius:10px;">
              <table class="table" id="tbl">
                <thead><tr><th>Cod</th><th>Cliente</th><th>Semana</th><th>D√≠a</th><th>Vendedor</th><th>Gestor</th><th>Empresa</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal Config -->
  <div id="modalConfig" class="modal hidden" aria-modal="true" role="dialog">
    <div class="card" style="width:min(860px,96vw);">
      <h3 class="title">Configuraci√≥n - Conectar Google Sheets</h3>
      <p class="muted">Pega las URL publicadas como CSV de tus hojas. <em>Tip:</em> usa ‚ÄúAplicar ahora‚Äù para ver cambios sin recargar.</p>
      <div class="grid grid-2">
        <div>
          <label>Modo</label>
          <select id="cfgMode"><option value="local">local (demo)</option><option value="sheets">sheets (Google)</option></select>
        </div>
        <div>
          <label>Usuarios (CSV)</label>
          <input id="cfgUsuarios" type="url" disabled placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"/>
        </div>
        <div>
          <label>Clientes (CSV)</label>
          <input id="cfgClientes" type="url" disabled placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"/>
        </div>
        <div>
          <label>Calendario (CSV)</label>
          <input id="cfgCalendario" type="url" disabled placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"/>
        </div>
      </div>
      <details style="margin-top:8px;">
        <summary>Filtros avanzados</summary>
        <div class="grid">
          <div>
            <label>Excluir vendedores (uno por l√≠nea)</label>
            <textarea id="cfgExcluirVendedores" placeholder="Nombres a excluir..."></textarea>
          </div>
        </div>
      </details>
      <div class="toolbar" style="margin-top:8px;">
        <button id="btnCfgProbar" class="btn">Probar conexi√≥n</button>
        <button id="btnCfgGuardar" disabled class="btn btn-primary">Guardar & Recargar</button>
        <button id="btnCfgAplicar" disabled class="btn">Aplicar ahora (sin recargar)</button>
        <button id="btnCfgLimpiar" disabled class="btn btn-danger">Limpiar configuraci√≥n</button>
        <button id="btnCfgCerrar" class="btn btn-soft">Cerrar</button>
      </div>
      <p id="cfgStatus" class="muted" style="margin-top:6px;"></p>
    </div>
  </div>

  <!-- Modal Registrar Llamada -->
  <div id="modalLlamada" class="modal hidden" aria-modal="true" role="dialog">
    <div class="card" style="width:min(900px,96vw);">
      <h3 class="title">üìû Registrar llamada</h3>
      <div class="grid grid-2">
        <div><label>Cliente</label><input id="callCliente" type="text" readonly /></div>
        <div><label>Cod Empresa</label><input id="callCodEmpresa" type="text" readonly /></div>
        <div><label>Vendedor</label><input id="callVendedor" type="text" readonly /></div>
        <div><label>gestor_servicio</label><input id="callGestor" type="text" readonly /></div>
        <div><label>Fecha y hora</label><input id="callFechaHora" type="datetime-local" /></div>
        <div><label>N¬∞ Semana</label>
          <select id="callSemana">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>
        <div><label>Resultado</label>
          <select id="callResultado">
<option value="Exitosa con Cita">Exitosa con Cita</option>
<option value="Exitosa Con Venta">Exitosa Con Venta</option>
<option value="Exitosa seguimiento a recepci√≥n de pedido">Exitosa seguimiento a recepci√≥n de pedido</option>
<option value="No Contesta">No Contesta</option>
<option value="No Compro">No Compro</option>
<option value="Captacion de Cliente">Captacion de Cliente</option>
</select>
        </div>
        <div><label>Duraci√≥n (seg.)</label><input id="callDuracion" type="number" min="0" step="1" value="0" /></div>
        <div></div>
        <div class="grid" style="grid-column:1/-1;"><label>Observaciones</label><textarea id="callObs" placeholder="Notas de la llamada..."></textarea></div>
      </div>
      <details style="margin-top:8px;">
        <summary>Contacto del cliente</summary>
        <div class="grid grid-3">
          <div><label>Tel√©fono 1</label><input id="callTelefono1" type="text" readonly /></div>
          <div><label>Celular</label><input id="callCelular" type="text" readonly /></div>
          <div><label>Provincia</label><input id="callProvincia" type="text" readonly /></div>
        </div>
      </details>
      <fieldset class="card" style="margin-top:10px;">
        <legend class="muted">Cita</legend>
        <div class="grid grid-3">
          <div><label>Tipo</label><select id="callCitaTipo">
            <option value="sin_cita">(sin cita)</option><option value="cita_showroom">Cita Showroom</option><option value="no_cita">No cita</option>
          </select></div>
          <div><label>Fecha</label><input id="callCitaFecha" type="date" /></div>
          <div><label>Hora</label><input id="callCitaHora" type="time" /></div>
        </div>
      </fieldset>
      <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
        <button id="btnCallCancelar" class="btn btn-soft">Cancelar</button>
        <button id="btnCallGuardar" class="btn btn-primary">Guardar</button>
      </div>
      <p id="callStatus" class="muted" style="margin-top:6px;"></p>
    </div>
  </div>

  <!-- Modal Reporte -->
  <div id="modalReporte" class="modal hidden" aria-modal="true" role="dialog">
    <div class="card" style="width:min(1100px,96vw);">
      <h3 class="title">üìä Reporte de llamadas</h3>
      <div class="grid grid-3">
        <div><label>Desde</label><input id="repDesde" type="date"/></div>
        <div><label>Hasta</label><input id="repHasta" type="date"/></div>
        <div><label>Vendedor</label><input id="repVendedor" type="text" placeholder="(todos)"/></div>
        <div><label>Gestor</label><input id="repGestor" type="text" placeholder="(todos)"/></div>
        <div><label>Resultado</label>
          <select id="repResultado">
<option value="">(todos)</option><option>Exitosa con Cita</option><option>Exitosa Con Venta</option><option>Exitosa seguimiento a recepci√≥n de pedido</option><option>No Contesta</option><option>No Compro</option><option>Captacion de Cliente</option>
</select>
        </div>
        <div><label>&nbsp;</label><button id="repExport" class="btn">‚¨á Exportar CSV</button></div>
      </div>
      
      <div class="toolbar" style="margin-top:6px; gap:8px; align-items:center;">
        <button id="repTabResumen" class="btn btn-soft">Resumen</button>
        <button id="repTabDetalle" class="btn btn-soft">Detalle</button>
        <div style="flex:1"></div>
        <button id="repSumExport" class="btn">‚¨á Exportar Resumen</button>
      </div>

      <div id="repResumenWrap" style="display:none; margin-top:8px; max-height:60vh; overflow:auto; border-radius:10px;">
        <table class="table" id="repSumTbl">
          <thead><tr>
            <th>Gestor</th><th>Semana</th><th>D√≠a</th>
            <th>A realizar</th><th>Realizadas</th><th>% Cobertura</th><th>√öltima llamada</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
<div id="repDetalleWrap" style="margin-top:8px;max-height:60vh;overflow:auto;border-radius:10px;">
        <table class="table" id="repTbl">
          <thead><tr>
            <th>Fecha/Hora</th><th>Cliente</th><th>Cod</th><th>Vendedor</th><th>Gestor</th>
            <th>Resultado</th><th>Duraci√≥n</th><th>Obs</th><th>Provincia</th><th>Tel1</th><th>Cel</th><th>Cita</th><th>Estatus cita</th>
          </tr></thead><tbody></tbody>
        </table>
      </div>
      <div class="toolbar" style="justify-content:flex-end; margin-top:10px;"><button id="btnRepCerrar" class="btn btn-soft">Cerrar</button></div>
    </div>
  </div>

  <!-- Modal Agenda -->
  <div id="modalAgenda" class="modal hidden" aria-modal="true" role="dialog">
    <div class="card" style="width:min(1200px,96vw);">
      <h3 class="title">üóìÔ∏è Visitas programadas</h3>
      <div class="grid grid-3">
        <div><label>Desde</label><input id="agDesde" type="date"></div>
        <div><label>Hasta</label><input id="agHasta" type="date"></div>
        <div><label>Estatus</label>
          <select id="agStatus">
            <option value="">(todos)</option>
            <option>programada</option><option>asisti√≥</option><option>no asisti√≥</option>
            <option>reprogramada</option><option>cancelada</option>
          </select>
        </div>
        <div><label>Vendedor</label><select id="agVendedor"><option value="">(todos)</option></select></div>
        <div><label>Gestor</label><select id="agGestor"><option value="">(todos)</option></select></div>
        <div style="display:flex;align-items:end;justify-content:flex-end;"><button id="agOpenReport" class="btn">üßæ Gesti√≥n de visita</button> <button id="agExport" class="btn">‚¨á Exportar CSV</button></div>
      </div>
      <div class="kanban" style="margin-top:10px;">
        <div class="kcol"><h4>Hoy</h4><div id="agHoy"></div></div>
        <div class="kcol"><h4>Esta semana</h4><div id="agSemana"></div></div>
        <div class="kcol"><h4>Futuras</h4><div id="agFuturas"></div></div>
      </div>
      <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
        <button id="btnAgCerrar" class="btn btn-soft">Cerrar</button>
      </div>
    </div>
  </div>

  
  <!-- Modal Gesti√≥n de Visita -->
  <div id="modalAgReporte" class="modal hidden" aria-modal="true" role="dialog">
    <div class="card" style="width:min(1100px,96vw);">
      <h3 class="title">üßæ Gesti√≥n de visita (Agenda)</h3>

      <div class="grid grid-3">
        <div><label>Desde</label><input id="gvDesde" type="date"></div>
        <div><label>Hasta</label><input id="gvHasta" type="date"></div>
        <div><label>Estatus</label>
          <select id="gvStatus">
            <option value="">(todos)</option>
            <option>programada</option><option>asisti√≥</option><option>no asisti√≥</option>
            <option>reprogramada</option><option>cancelada</option>
          </select>
        </div>
        <div><label>Vendedor</label><select id="gvVendedor"><option value="">(todos)</option></select></div>
        <div><label>Gestor</label><select id="gvGestor"><option value="">(todos)</option></select></div>
        <div style="display:flex;align-items:end;justify-content:flex-end;">
          <button id="gvExport" class="btn">‚¨á Exportar CSV</button>
        </div>
      </div>

      <div style="margin-top:8px;max-height:60vh;overflow:auto;border-radius:10px;">
        <table class="table" id="gvTbl">
          <thead>
            <tr>
              <th>Fecha</th><th>Hora</th><th>D√≠a</th>
              <th>Cliente</th><th>Cod</th>
              <th>Vendedor</th><th>Gestor</th>
              <th>Estatus</th><th>Tipo</th><th>Obs</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
        <button id="btnGvCerrar" class="btn btn-soft">Cerrar</button>
      </div>
    </div>
  </div>

  
  <button id="btnOpenResumenSem" class="btn" style="margin-left:8px;">üìä Resumen (Sem)</button>

  
  <!-- === Pantalla: Reporte de Llamadas ‚Äî Resumen (Semanal) === -->
  <section id="screenResumenSem" style="display:none;">
    <div class="card" style="margin:12px auto; width:min(1180px,96vw);">
      <div class="toolbar" style="gap:10px; align-items:center; flex-wrap:wrap;">
        <h3 style="margin:6px 12px 6px 0;">üìà Reporte de Llamadas ‚Äî Resumen (Semanal)</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-left:auto">
          <div><label>Semana</label>
            <select id="rwSemana">
              <option value="">Todas</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div><label>Vendedor</label><select id="rwVendedor"><option value="">Todos</option></select></div>
          <div><label>Gestor</label><select id="rwGestor"><option value="">Todos</option></select></div>
          <button id="rwExport" class="btn">‚¨á Exportar CSV</button>
          <button id="rwVolver" class="btn btn-soft">‚Üê Volver</button>
        </div>
      </div>

      <div class="toolbar" style="gap:12px; flex-wrap:wrap; margin-top:6px;"><button id="rwToggle" class="btn btn-soft">Ocultar</button>
        <span class="chip">A realizar: <strong id="rwPlan">0</strong></span>
        <span class="chip">Realizadas: <strong id="rwDone">0</strong></span>
        <span class="chip">% Cobertura: <strong id="rwCov">0%</strong></span>
        <span id="rwInfo" class="muted"></span>
      </div>
<div id="rwKpis" class="row" style="margin-top:8px;">
  <div class="col">
    <div class="card" style="text-align:center; padding:14px 10px;">
      <div class="muted">A realizar (Itinerarios)</div>
      <div id="kpiPlan" style="font-size:28px; font-weight:800;">0</div>
    </div>
  </div>
  <div class="col">
    <div class="card" style="text-align:center; padding:14px 10px;">
      <div class="muted">Realizadas (Llamadas)</div>
      <div id="kpiDone" style="font-size:28px; font-weight:800;">0</div>
    </div>
  </div>
  <div class="col">
    <div class="card" style="text-align:center; padding:14px 10px;">
      <div class="muted">Llamadas (Total)</div>
      <div id="kpiCalls" style="font-size:28px; font-weight:800;">0</div>
    </div>
  </div>
  <div class="col">
    <div class="card" style="text-align:center; padding:14px 10px;">
      <div class="muted">% Cobertura</div>
      <div id="kpiCov" style="font-size:28px; font-weight:800;">0%</div>
    </div>
  </div>
</div>


      <div style="margin-top:8px; max-height:calc(84vh - 160px); overflow:auto; border-radius:12px;">
        <table class="table" id="rwTbl">
          <thead>
            <tr>
              <th>Gestor</th>
              <th>Semana</th>
              <th>A realizar</th>
              <th>Realizadas</th>
              <th>% Cobertura</th>
              <th>√öltima llamada</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="errbar" id="errbar"></div>

<script>

// === CORREGIDO: Ocultar cita solo al presionar Guardar y si estatus !== "programada" ===
document.querySelectorAll('.kcol').forEach(col => {
  col.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn || !btn.classList.contains('btn-primary')) return;

    const card = btn.closest('.kcard');
    if (!card) return;

    const select = card.querySelector('select');
    if (!select) return;

    const status = select.value.trim().toLowerCase();
    if (status !== 'programada') {
      setTimeout(() => {
        card.remove(); // Eliminar visualmente despu√©s del guardado
      }, 150);
    }
  });
});

// ======================= CONFIG =======================

const DEFAULT_CONFIG = { 
  mode: 'sheets', 
  sheets: {
    usuarios: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv',
    clientes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1016315198&single=true&output=csv',
    calendario: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv'
  },
  excluirVendedores: []
};
let CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));


// ======================= DEMO DATA =======================
const DEMO = {
  usuarios: [
    { Usuario:'demo', Password:'1234', gestor_servicio:'RENDY MEJIA', Vendedor:'RENDY MEJIA', Permiso:'administrador' },
    { Usuario:'vendedor', Password:'1234', gestor_servicio:'DIOGENES', Vendedor:'DIOGENES', Permiso:'usuario' }
  ],
  clientes: [
    { 'Cod Empresa':'1001', RazonSocial:'FERRETERIA EL SOL', Latitud:'18.510', Longitud:'-69.850', Telefono1:'809-555-1111', Celular:'809-999-1111', Provincia:'La Altagracia', Vendedor:'RENDY MEJIA', gestor_servicio:'RENDY MEJIA', Empresa:'WILLIAM'},
    { 'Cod Empresa':'1002', RazonSocial:'PINTURAS CARIBE',   Latitud:'18,470', Longitud:'-69,900', Telefono1:'809-555-2222', Celular:'809-999-2222', Provincia:'Santo Domingo', Vendedor:'DIOGENES', gestor_servicio:'DIOGENES', Empresa:'WILLIAM'},
    { 'Cod Empresa':'1003', RazonSocial:'TODO HOGAR',        Latitud:'',       Longitud:'',       Telefono1:'809-555-3333', Celular:'809-999-3333', Provincia:'La Romana', Vendedor:'', gestor_servicio:'', Empresa:'WILLIAM'}
  ],
  calendario: [
    { 'Cod Empresa':'1001', Semana:'32', Dia:'Viernes' },
    { 'Cod Empresa':'1002', Semana:'32', Dia:'Jueves'  }
  ]
};

// ======================= STATE =======================
const STATE = {
  calls: [], users: [], clientes: [], calendario: [], joined: [], filtered: [],
  currentUser: null, selected: null,
  map: null, markers: [], colorByVendedor: {}, iconByColor: {}
};

// ======================= UTILS =======================
const JOIN_KEYS = ['Cod Empresa','CodEmpresa','Cod_Empresa','codigo_empresa','codigo','CodEmp','CodEmpresaId','codigo_npg','Codigo NPG','Codigo_NPG','CODIGO_NPG'];
function norm(v){ return (v??'').toString().trim().toLowerCase(); }
function stripAccents(s){ return (s??'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function normName(s){ return stripAccents(String(s||'')).trim().toLowerCase(); }
function val(id){ return document.getElementById(id).value; }

function pick(row, keys){
  for(const k of keys){ if(row && row[k] != null && row[k] !== '') return row[k]; }
  const normRow = {}; for(const key in row){ normRow[key.toLowerCase().replace(/\s|_/g,'')] = row[key]; }
  for(const k of keys){ const nk = k.toLowerCase().replace(/\s|_/g,''); if(nk in normRow) return normRow[nk]; }
  return '';
}
function parseCoord(val){
  if(val==null) return NaN;
  const s = String(val).trim();
  let cleaned = s.replace(/[^0-9,\.\-]/g, '');
  if(cleaned.includes('.') && cleaned.includes(',')){ cleaned = cleaned.replace(/,/g,''); } else { cleaned = cleaned.replace(',', '.'); }
  const num = parseFloat(cleaned);
  return isFinite(num) ? num : NaN;
}
function getByGuess(row, patterns){
  for(const key in row){ if(patterns.some(rx=> rx.test(key))) return row[key]; }
  const map = {}; for(const k in row){ map[k.toLowerCase().replace(/\s|_/g,'')] = row[k]; }
  for(const nk in map){ if(patterns.some(rx=> rx.test(nk))) return map[nk]; }
  return '';
}
function getLat(row){ const v = row['Latitud']||row['latitud']||row['LATITUD']||getByGuess(row,[/lat$/i,/^lat/i,/latitude/i]); return parseCoord(v); }
function getLon(row){ const v = row['Longitud']||row['longitud']||row['LONGITUD']||row['Lng']||row['lng']||getByGuess(row,[/lon$/i,/long/i,/lng/i]); return parseCoord(v); }
function uniqueSorted(arr){ return Array.from(new Set(arr.filter(x=>x!=null && x!==''))).sort((a,b)=>{ const na=Number(a), nb=Number(b); if(isFinite(na)&&isFinite(nb)) return na-nb; return String(a).localeCompare(String(b),'es',{numeric:true}); }); }
function showErr(msg){ const el=document.getElementById('errbar'); el.textContent=msg; el.style.display='block'; setTimeout(()=>{ el.style.display='none'; }, 2600); }
function hashColor(name){ const s=(name||'').toString(); let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h+s.charCodeAt(i); h|=0; } const hue=Math.abs(h)%360; return `hsl(${hue} 80% 55%)`; }

// ======================= CSV LOADER =======================
async function fetchCSV(url){ const res = await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status); const text = await res.text(); return parseCSV(text); }
function parseCSV(text){
  const rows = []; const lines = text.split(/\r?\n/).filter(x=>x.trim().length>0); if(lines.length===0) return rows;
  const split = (line) => { const result=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const c=line[i], n=line[i+1];
    if(c==='\"'){ if(inQ && n==='\"'){ cur+='\"'; i++; } else inQ=!inQ; } else if(c===',' && !inQ){ result.push(cur); cur=''; } else cur+=c; }
    result.push(cur); return result; };
  const headers = split(lines[0]).map(h=>h.trim());
  for(let i=1;i<lines.length;i++){ const vals = split(lines[i]); const row = {}; headers.forEach((h,idx)=> row[h]= vals[idx]!==undefined ? vals[idx] : '' ); rows.push(row); }
  return rows;
}

// ======================= DATA PREP =======================
function detectVendedor(row){
  const cand = row['Vendedor']||row['VENDEDOR']||row['vendedor']||row['Vendedor Asignado']||row['VENDEDOR ASIGNADO']||row['VendedorAsignado']||row['VENDEDOR_ASIGNADO']||getByGuess(row,[/vendedor/i,/seller/i,/salesrep/i]);
  if(cand && String(cand).trim()!=='') return cand;
  return row['gestor_servicio']||row['Gestor']||row['GESTOR_SERVICIO']||''; // fallback
}
function mapUserRecord(r){
  const u = r['Usuario']||r['usuario']||r['Login']||r['NombreUsuario']||r['USUARIO']||r['gestor_servicio']||r['Gestor']||r['GESTOR_SERVICIO'];
  const p = r['Password']||r['Contrase√±a']||r['Contrasena']||r['PASS']||r['Clave'];
  const permiso = (r['Permiso']||r['permiso']||r['ROLE']||r['Rol']||'usuario').toString().toLowerCase();
  return { Usuario:(u??'').toString(), Password:(p??'').toString(), gestor_servicio:r['gestor_servicio']||r['Gestor']||r['GESTOR_SERVICIO']||'', Vendedor: detectVendedor(r), Permiso: permiso==='administrador'?'administrador':'usuario' };
}
function vendorExcludedSet(){ const arr = CONFIG.excluirVendedores || []; return new Set(arr.map(v=> normName(v) ).filter(Boolean)); }
function isVendorExcluded(name){ if(!name) return false; return vendorExcludedSet().has(normName(name)); }

function buildJoined(){
  const idxCal = {}; const getDia = r => r['Dia'] ?? r['D√≠a'] ?? r['dia'] ?? r['DIA']; const getSem = r => r['Semana'] ?? r['SEMANA'] ?? r['semana'];
  STATE.calendario.forEach(r=>{ const key = norm(pick(r, JOIN_KEYS)); if(!key) return; if(!idxCal[key]) idxCal[key]=r; });
  STATE.joined = STATE.clientes.map(c=>{
    const key = norm(pick(c, JOIN_KEYS)); const m = idxCal[key]; const semana = m ? (getSem(m) || 'Por asignar') : 'Por asignar'; const dia = m ? (getDia(m) || 'Por asignar') : 'Por asignar';
    const lat = getLat(c); const lon = getLon(c);
    const vendedor = detectVendedor(c);
    return { cod: pick(c, JOIN_KEYS) || '', nombre: c['NombreCliente']||c['Cliente']||c['RazonSocial']||c['RAZONSOCIAL']||'', semana, dia,
      vendedor, gestor: c['gestor_servicio']||c['Gestor']||c['GESTOR_SERVICIO']||'', empresa: c['Empresa']||c['EMPRESA']||'', lat, lon,
      telefono1: c['Telefono1']||c['TEL1']||c['Telefono']||c['Tel']||c['TEL']||'',
      celular: c['Celular']||c['CELULAR']||c['Movil']||c['M√≥vil']||'',
      provincia: c['Provincia']||c['PROVINCIA']||c['estado']||c['Departamento']||'' };
  });
  if((CONFIG.excluirVendedores||[]).length){ STATE.joined = STATE.joined.filter(x=> !isVendorExcluded(x.vendedor) ); }
}

// ======================= UI RENDER =======================
function buildFilters(){
  const S=STATE.joined;
  fillSelect('fSemana', uniqueSorted(S.map(x=>x.semana)), 'Todas');
  fillSelect('fDia', uniqueSorted(S.map(x=>x.dia)), 'Todos');
  const vendOpts = uniqueSorted(S.map(x=>x.vendedor)).filter(v=> !isVendorExcluded(v) );
  fillSelect('fVendedor', vendOpts, 'Todos');
  fillSelect('fGestor', uniqueSorted(S.map(x=>x.gestor)), 'Todos');
  fillSelect('fEmpresa', uniqueSorted(S.map(x=>x.empresa)), 'Todas');
  const opts = S.map(x=>({value:x.cod, label:`${x.cod} - ${x.nombre}`})).sort((a,b)=>a.label.localeCompare(b.label,'es',{numeric:true}));
  const sel = document.getElementById('fCliente'); sel.innerHTML = '<option value="">-- Seleccione --</option>' + opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
  buildLegend();
}
function fillSelect(id, arr, defLabel){ const el=document.getElementById(id); el.innerHTML = `<option value="">${defLabel}</option>` + arr.map(v=>`<option value="${String(v)}">${String(v)}</option>`).join(''); }
function buildLegend(){
  const legend=document.getElementById('legend'); legend.innerHTML='';
  uniqueSorted(STATE.joined.map(x=>x.vendedor)).filter(v=> !isVendorExcluded(v)).forEach(v=>{
    const c=hashColor(v||''); const span=document.createElement('span'); span.className='chip'; span.style.borderColor=c; span.style.color='#dbe7ff'; span.textContent=v||'Sin vendedor'; legend.appendChild(span);
  });
}
function applyFilters(){
  const fSemana=val('fSemana'), fDia=val('fDia'), fVend=val('fVendedor'), fGes=val('fGestor'), fEmp=val('fEmpresa'), fBus=norm(val('fBuscar')), fCli=val('fCliente');
  STATE.filtered = STATE.joined.filter(x=>{
    if(isVendorExcluded(x.vendedor)) return false;
    if(fSemana && String(x.semana)!==String(fSemana)) return false; if(fDia && String(x.dia)!==String(fDia)) return false;
    if(fVend && String(x.vendedor)!==String(fVend)) return false; if(fGes && String(x.gestor)!==String(fGes)) return false;
    if(fEmp && String(x.empresa)!==String(fEmp)) return false; if(fCli && String(x.cod)!==String(fCli)) return false;
    if(fBus){ const hay=[x.cod,x.nombre,x.vendedor,x.gestor,x.empresa].map(v=>norm(v)).some(s=>s.includes(fBus)); if(!hay) return false; }
    return true;
  });
  renderTable(); renderMap(); updateStats(); updateButtonsState();
}
function renderTable(){
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  STATE.filtered.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${x.cod}</td><td>${x.nombre}</td><td>${x.semana}</td><td>${x.dia}</td><td>${x.vendedor}</td><td>${x.gestor}</td><td>${x.empresa}</td>`; tr.style.cursor='pointer'; tr.onclick=()=>selectCliente(x); tb.appendChild(tr); });
}

// ===== Map with PIN icons =====
function initMap(){ if(STATE.map) return; const RD=[18.735693,-70.162651]; STATE.map=L.map('map',{zoomControl:true}).setView(RD,8); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(STATE.map); setTimeout(()=>STATE.map.invalidateSize(), 200); window.addEventListener('resize', ()=>STATE.map&&STATE.map.invalidateSize()); }
function clearMarkers(){ STATE.markers.forEach(m=>STATE.map.removeLayer(m)); STATE.markers=[]; }
function getVendedorColor(v){ if(!v) return '#9aa3b2'; if(!STATE.colorByVendedor[v]) STATE.colorByVendedor[v]=hashColor(v); return STATE.colorByVendedor[v]; }
function svgPin(color){ const fill=color||'#3b82f6'; const stroke='#08121f'; const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="26" height="38" viewBox="0 0 26 38"><path d="M13 0C7 0 2 5 2 11c0 7.5 9 17 11 19 2-2 11-11.5 11-19C24 5 19 0 13 0z" fill="${fill}" stroke="${stroke}" stroke-width="2"/><circle cx="13" cy="12" r="4.2" fill="#fff" stroke="${stroke}" stroke-width="2"/></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
function pinIcon(color){ if(!STATE.iconByColor[color]){ STATE.iconByColor[color]=L.icon({iconUrl:svgPin(color), iconSize:[26,38], iconAnchor:[13,36], popupAnchor:[0,-30], className:'vendor-pin'});} return STATE.iconByColor[color]; }
function renderMap(){
  initMap(); clearMarkers(); const bounds=[]; let rendered=0;
  STATE.filtered.forEach(x=>{ if(!isFinite(x.lat)||!isFinite(x.lon)) return; const color=getVendedorColor(x.vendedor); const m=L.marker([x.lat,x.lon],{ icon: pinIcon(color) }).addTo(STATE.map);
    m.bindPopup(`<strong>${x.nombre}</strong><div class="muted">Cod ${x.cod} ‚Ä¢ ${x.empresa||''}</div><div>Semana: ${x.semana} ‚Ä¢ D√≠a: ${x.dia}</div><div>Vendedor: ${x.vendedor||'-'} ‚Ä¢ Gestor: ${x.gestor||'-'}</div>`);
    m.on('click',()=>selectCliente(x)); STATE.markers.push(m); bounds.push([x.lat,x.lon]); rendered++; });
  document.getElementById('hintZero').style.display = rendered? 'none':'block';
  if(bounds.length){ STATE.map.fitBounds(bounds,{padding:[20,20]}); } else { STATE.map.setView([18.735693,-70.162651],8); }
  setTimeout(()=>STATE.map.invalidateSize(), 50);
}
function selectCliente(x){ STATE.selected=x; document.getElementById('fCliente').value=x.cod; renderMap(); updateButtonsState(); }
function updateButtonsState(){ const has=!!STATE.selected; document.getElementById('btnRegistrar').toggleAttribute('disabled', !has); document.getElementById('btnFicha').toggleAttribute('disabled', !has); }
function updateStats(){ const t=STATE.joined.length, g=STATE.joined.filter(x=>isFinite(x.lat)&&isFinite(x.lon)).length, f=STATE.filtered.length; document.getElementById('statTotal').textContent=t; document.getElementById('statGeo').textContent=g; document.getElementById('statFilt').textContent=f; }
function exportCSV(){ const headers=['Cod','Cliente','Semana','Dia','Vendedor','Gestor','Empresa','Latitud','Longitud']; const rows=STATE.filtered.map(x=>[x.cod,x.nombre,x.semana,x.dia,x.vendedor,x.gestor,x.empresa,x.lat||'',x.lon||'']); const csv=[headers.join(','),...rows.map(r=>r.map(csvEscape).join(','))].join('\\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='clientes_filtrados.csv'; a.click(); URL.revokeObjectURL(a.href); }
function csvEscape(v){ if(v==null) return ''; const s=String(v); return (s.includes(',')||s.includes('\"')||s.includes('\\n'))?('\"'+s.replace(/\"/g,'\"\"')+'\"'):s; }

// ======================= REGISTRAR LLAMADA =======================
function formatDatetimeLocal(d){ const pad=n=> String(n).padStart(2,'0'); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes()); }
function computeWeekFromVal(val){ try{ const d = val? new Date(val): new Date(); if(!(d instanceof Date)||isNaN(d)) return '1'; const w = Math.ceil((d.getDate())/7); return String(Math.min(Math.max(w,1),4)); }catch(_){ return '1'; } }
function openCallModal(){
  if(!STATE.selected){ showErr('Debe seleccionar un cliente.'); return; }
  const x = STATE.selected;
  document.getElementById('callCliente').value = x.nombre || '';
  document.getElementById('callCodEmpresa').value = x.cod || '';
  document.getElementById('callVendedor').value = x.vendedor || '';
  document.getElementById('callGestor').value = x.gestor || '';
  document.getElementById('callFechaHora').value = formatDatetimeLocal(new Date());
  document.getElementById('callSemana').value = computeWeekFromVal(document.getElementById('callFechaHora').value);document.getElementById('callResultado').value = 'Exitosa';
  document.getElementById('callDuracion').value = 0;
  document.getElementById('callObs').value = '';
  document.getElementById('callTelefono1').value = x.telefono1 || '';
  document.getElementById('callCelular').value = x.celular || '';
  document.getElementById('callProvincia').value = x.provincia || '';
  document.getElementById('callCitaTipo').value = 'sin_cita';
  document.getElementById('callCitaFecha').value = '';
  document.getElementById('callCitaHora').value = '';
  document.getElementById('callStatus').textContent = '';
  const m=document.getElementById('modalLlamada'); m.classList.remove('hidden'); m.style.display='flex'; document.body.classList.add('no-scroll');
}
function closeCallModal(){ const m=document.getElementById('modalLlamada'); m.classList.add('hidden'); m.style.display='none'; document.body.classList.remove('no-scroll'); }
function saveCallRecord(){
  if(!STATE.selected){ showErr('Debe seleccionar un cliente.'); return; }
  const record = {
    cliente: document.getElementById('callCliente').value.trim(),
    cod_empresa: document.getElementById('callCodEmpresa').value.trim(),
    vendedor: document.getElementById('callVendedor').value.trim(),
    gestor_servicio: document.getElementById('callGestor').value.trim(),
    fecha_hora: document.getElementById('callFechaHora').value,
    resultado: document.getElementById('callResultado').value,
    semana: document.getElementById('callSemana').value,
    duracion_seg: Number(document.getElementById('callDuracion').value||0),
    observaciones: document.getElementById('callObs').value.trim(),
    telefono1: document.getElementById('callTelefono1').value.trim(),
    celular: document.getElementById('callCelular').value.trim(),
    provincia: document.getElementById('callProvincia').value.trim(),
    cita_tipo: document.getElementById('callCitaTipo').value,
    cita_fecha: document.getElementById('callCitaFecha').value,
    cita_hora: document.getElementById('callCitaHora').value
  };
  record.__id = record.__id || (record.cod_empresa+'-'+Date.now()+'-'+Math.random().toString(36).slice(2,7));
  STATE.calls.push(record);
  try{ const prev = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); prev.push(record); localStorage.setItem('llamadas_records', JSON.stringify(prev)); }catch(e){ console.error(e); }
  document.getElementById('callStatus').textContent = 'Registro guardado localmente.';
  setTimeout(()=>{ closeCallModal(); showErr('Llamada registrada.'); }, 400);
}

// ======================= REPORTE =======================
function loadAllCallRecords(){ let local=[]; try{ local = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(_){ local=[]; } return [...local, ...STATE.calls]; }
function openReporte(){ renderReporte(); const m=document.getElementById('modalReporte'); m.classList.remove('hidden'); m.style.display='flex'; document.body.classList.add('no-scroll'); }
function closeReporte(){ const m=document.getElementById('modalReporte'); m.classList.add('hidden'); m.style.display='none'; document.body.classList.remove('no-scroll'); }
function repFilters(){ const desde = document.getElementById('repDesde').value; const hasta = document.getElementById('repHasta').value; const vend = norm(document.getElementById('repVendedor').value); const gest = norm(document.getElementById('repGestor').value); const res  = document.getElementById('repResultado').value; return {desde,hasta,vend,gest,res}; }
function renderReporte(){
  const all = loadAllCallRecords();
  const {desde,hasta,vend,gest,res} = repFilters();
  let ds = desde? new Date(desde+'T00:00:00') : null; let hs = hasta? new Date(hasta+'T23:59:59') : null;
  const rows = all.filter(r=>{ let ok=true; const fh=r.fecha_hora||''; const d=fh?new Date(fh):null; if(ds && d && d<ds) ok=false; if(hs && d && d>hs) ok=false; if(vend && norm(r.vendedor)!==vend) ok=false; if(gest && norm(r.gestor_servicio)!==gest) ok=false; if(res && String(r.resultado)!==String(res)) ok=false; return ok; });
  const tb=document.querySelector('#repTbl tbody'); tb.innerHTML=''; rows.forEach(r=>{ const cita=(r.cita_tipo && r.cita_tipo!=='sin_cita')?(r.cita_tipo+' '+(r.cita_fecha||'')+' '+(r.cita_hora||'')) : ''; const tr=document.createElement('tr'); tr.innerHTML = '<td>'+ (r.fecha_hora||'') +'</td><td>'+ (r.cliente||'') +'</td><td>'+ (r.cod_empresa||'') +'</td><td>'+ (r.vendedor||'') +'</td><td>'+ (r.gestor_servicio||'') +'</td><td>'+ (r.resultado||'') +'</td><td>'+ (r.duracion_seg||'') +'</td><td>'+ (r.observaciones||'') +'</td><td>'+ (r.provincia||'') +'</td><td>'+ (r.telefono1||'') +'</td><td>'+ (r.celular||'') +'</td><td>'+ cita +'</td><td>'+ (r.estatus_visita||'') +'</td>'; tb.appendChild(tr); });
}
function exportReporteCSV(){ const tb=document.querySelector('#repTbl tbody'); const headers=['Fecha/Hora','Cliente','Cod','Vendedor','Gestor','Resultado','Duraci√≥n','Obs','Provincia','Tel1','Cel','Cita','Estatus cita']; const rows=[...tb.querySelectorAll('tr')].map(tr=>[...tr.children].map(td=>td.textContent)); const csv=[headers.join(','),...rows.map(r=>r.map(csvEscape).join(','))].join('\\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='reporte_llamadas.csv'; a.click(); URL.revokeObjectURL(a.href); }

// ======================= AGENDA =======================
function ensureId(r){ if(!r.__id){ r.__id = (r.cod_empresa||'')+'-'+(r.cita_fecha||'')+'-'+Math.random().toString(36).slice(2,7); } if(!r.estatus_visita) r.estatus_visita='programada'; return r; }
function allCalls(){ let local=[]; try{ local = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(_){ local=[]; } return [...local, ...STATE.calls].map(ensureId); }
function openAgenda(){ buildAgendaFilters(); renderAgenda(); const m=document.getElementById('modalAgenda'); m.classList.remove('hidden'); m.style.display='flex'; document.body.classList.add('no-scroll'); }
function closeAgenda(){ const m=document.getElementById('modalAgenda'); m.classList.add('hidden'); m.style.display='none'; document.body.classList.remove('no-scroll'); }
function buildAgendaFilters(){
  const data = allCalls().filter(c => c.cita_tipo && c.cita_tipo !== 'sin_cita');
  const vends = [...new Set(data.map(x => x.vendedor).filter(Boolean))].sort();
  const ges   = [...new Set(data.map(x => x.gestor_servicio).filter(Boolean))].sort();
  const selV = document.getElementById('agVendedor'); const selG = document.getElementById('agGestor');
  selV.innerHTML = '<option value="">(todos)</option>' + vends.map(v=>`<option>${v}</option>`).join('');
  selG.innerHTML = '<option value="">(todos)</option>' + ges.map(v=>`<option>${v}</option>`).join('');
}
function agendaFilters(){ return { desde:document.getElementById('agDesde').value, hasta:document.getElementById('agHasta').value, vendedor:document.getElementById('agVendedor').value, gestor:document.getElementById('agGestor').value, status:document.getElementById('agStatus').value }; }
function renderAgenda(){
  const wrapHoy=document.getElementById('agHoy'), wrapSem=document.getElementById('agSemana'), wrapFut=document.getElementById('agFuturas'); [wrapHoy,wrapSem,wrapFut].forEach(w=>w.innerHTML='');
  const {desde,hasta,vendedor,gestor,status} = agendaFilters(); const ds=desde?new Date(desde+'T00:00:00'):null; const hs=hasta?new Date(hasta+'T23:59:59'):null;
  const items = allCalls().filter(r=>{ if(!r.cita_tipo || r.cita_tipo==='sin_cita' || r.cita_tipo==='no_cita' || !r.cita_fecha || !r.cita_hora) return false; const f=r.cita_fecha?new Date(r.cita_fecha+'T'+(r.cita_hora||'00:00')):null; if(ds && f && f<ds) return false; if(hs && f && f>hs) return false; if(vendedor && r.vendedor!==vendedor) return false; if(gestor && r.gestor_servicio!==gestor) return false; if(status){ if((r.estatus_visita||'programada')!==status) return false; } else { const s=(r.estatus_visita||'programada'); if(!(s==='programada'||s==='reprogramada')) return false; } return true; });
  const today=new Date(); today.setHours(0,0,0,0); const endWeek=new Date(today); endWeek.setDate(today.getDate() + (7 - today.getDay()));
  items.forEach(r=>{ const f=r.cita_fecha?new Date(r.cita_fecha+'T'+(r.cita_hora||'00:00')):null; const card=agendaCard(r); if(!f || f<today){ wrapSem.appendChild(card); } else if(f.toDateString()===today.toDateString()){ wrapHoy.appendChild(card); } else if(f<=endWeek){ wrapSem.appendChild(card); } else { wrapFut.appendChild(card); } });
}
function agendaCard(r){
  const div=document.createElement('div'); div.className='kcard';
  div.innerHTML=`
    <div class="khead">${r.cliente||''}</div>
    <div class="kmeta">${r.cod_empresa||''} ‚Ä¢ ${r.vendedor||''} ‚Ä¢ ${r.gestor_servicio||''}</div>
    <div class="grid grid-3" style="margin-top:6px;">
      <div><label>Fecha</label><input type="date" value="${r.cita_fecha||''}" data-id="${r.__id}" data-k="cita_fecha"></div>
      <div><label>Hora</label><input type="time" value="${r.cita_hora||''}" data-id="${r.__id}" data-k="cita_hora"></div>
      <div><label>Estatus</label>
        <select data-id="${r.__id}" data-k="estatus_visita">
          ${['programada','asisti√≥','no asisti√≥','reprogramada','cancelada'].map(s=>`<option ${((r.estatus_visita||'programada')===s)?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="toolbar" style="justify-content:flex-end;margin-top:6px;">
      <button class="btn btn-primary" data-save="${r.__id}">Guardar</button>
    </div>
    <div class="muted" style="margin-top:4px;">${r.observaciones||''}</div>`;
  div.querySelector('[data-save]').addEventListener('click', ()=>{
    const id = div.querySelector('[data-save]').getAttribute('data-save');
    const fecha = div.querySelector('[data-id="'+id+'"][data-k="cita_fecha"]').value;
    const hora  = div.querySelector('[data-id="'+id+'"][data-k="cita_hora"]').value;
    const est   = div.querySelector('[data-id="'+id+'"][data-k="estatus_visita"]').value;
    updateCallRecord(id, {cita_fecha:fecha, cita_hora:hora, estatus_visita:est});
    renderAgenda(); showErr('Cita actualizada');
  });

  // add delete if admin
  if(STATE.currentUser && STATE.currentUser.Permiso==='administrador'){
    const bar = div.querySelector('.toolbar');
    const delBtn = document.createElement('button');
    delBtn.className='btn btn-danger';
    delBtn.textContent='Eliminar';
    delBtn.style.marginLeft='8px';
    delBtn.addEventListener('click', ()=>{
      if(!confirm('¬øEliminar esta cita?')) return;
      // remove from STATE.calls and localStorage by __id
      const id = (r.__id);
      STATE.calls = STATE.calls.filter(x=> x.__id!==id);
      let local=[]; try{ local = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(_){ local=[]; }
      local = local.filter(x=> x.__id!==id);
      try{ localStorage.setItem('llamadas_records', JSON.stringify(local)); }catch(_){ }
      renderAgenda(); showErr('Cita eliminada');
    });
    bar.appendChild(delBtn);
  }
  return div;
}
function updateCallRecord(id, patch){
  STATE.calls = STATE.calls.map(r => r.__id===id ? {...r, ...patch} : r);
  let local=[]; try{ local = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); }catch(_){ local=[]; }
  local = local.map(r => r.__id===id ? {...r, ...patch} : r);
  localStorage.setItem('llamadas_records', JSON.stringify(local));
}
function exportAgendaCSV(){
  const {desde,hasta,vendedor,gestor,status} = agendaFilters(); const ds=desde?new Date(desde+'T00:00:00'):null; const hs=hasta?new Date(hasta+'T23:59:59'):null;
  const data = allCalls().filter(r=> r.cita_tipo && r.cita_tipo!=='sin_cita').filter(r=>{ const f=r.cita_fecha?new Date(r.cita_fecha+'T'+(r.cita_hora||'00:00')):null; if(ds && f && f<ds) return false; if(hs && f && f>hs) return false; if(vendedor && r.vendedor!==vendedor) return false; if(gestor && r.gestor_servicio!==gestor) return false; if(status){ if((r.estatus_visita||'programada')!==status) return false; } else { const s=(r.estatus_visita||'programada'); if(!(s==='programada'||s==='reprogramada')) return false; } return true; });
  const headers=['Cliente','Cod','Vendedor','Gestor','Fecha','Hora','Estatus','Tipo','Obs']; const rows=data.map(r=>[r.cliente||'',r.cod_empresa||'',r.vendedor||'',r.gestor_servicio||'',r.cita_fecha||'',r.cita_hora||'',r.estatus_visita||'programada',r.cita_tipo||'',r.observaciones||'']); const csv=[headers.join(','),...rows.map(r=>r.map(csvEscape).join(','))].join('\\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='agenda.csv'; a.click(); URL.revokeObjectURL(a.href);
}

// ======================= LOGIN =======================
function doLogin(){ const u=val('loginUser').trim(), p=val('loginPass'); if(!u||!p){ showErr('Ingrese usuario y contrase√±a.'); return; } const ok=STATE.users.find(x=> norm(x.Usuario)===norm(u) && String(x.Password)===String(p) ); if(!ok){ showErr('Usuario o contrase√±a incorrectos.'); return; } STATE.currentUser = ok; document.getElementById('login').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); setTimeout(()=>STATE.map&&STATE.map.invalidateSize(), 50); applyFilters(); }

// ======================= CONFIG MODAL =======================
function openConfig(){ document.getElementById('cfgMode').value = CONFIG.mode; document.getElementById('cfgUsuarios').value = CONFIG.sheets.usuarios || ''; document.getElementById('cfgClientes').value = CONFIG.sheets.clientes || ''; document.getElementById('cfgCalendario').value = CONFIG.sheets.calendario || ''; document.getElementById('cfgExcluirVendedores').value = (CONFIG.excluirVendedores||[]).join('\\n'); document.getElementById('cfgStatus').textContent = ''; const m=document.getElementById('modalConfig'); m.classList.remove('hidden'); m.style.display='flex'; }
function closeConfig(){ const m=document.getElementById('modalConfig'); m.classList.add('hidden'); m.style.display='none'; }
async function testConfig(){ const u=val('cfgUsuarios').trim(), c=val('cfgClientes').trim(), k=val('cfgCalendario').trim(); const out=[]; async function tryFetch(name, url){ if(!url){ out.push(`${name}: (vac√≠o)`); return; } try{ const arr=await fetchCSV(url); out.push(`${name}: OK (${arr.length} filas)`); }catch(e){ out.push(`${name}: ERROR (${e.message})`); } } await tryFetch('Usuarios',u); await tryFetch('Clientes',c); await tryFetch('Calendario',k); document.getElementById('cfgStatus').textContent = out.join(' ‚Ä¢ '); }
function parseExcludeTextarea(){ const raw = document.getElementById('cfgExcluirVendedores').value || ''; return raw.split(/[\\r\\n]+/).map(s=>s.trim()).filter(Boolean); }
function saveToLocalStorage(cfg){ try{ localStorage.setItem('llamadas_config', JSON.stringify(cfg)); return true; }catch(e){ console.error(e); showErr('No se pudo guardar configuraci√≥n (localStorage).'); return false; } }
function forceReload(){ try{ location.reload(); }catch(_){ try{ window.location.assign(window.location.pathname + '?r=' + Date.now()); }catch(__){} } }
function saveConfig(){ const modeSel = val('cfgMode'); const usuarios = val('cfgUsuarios').trim(); const clientes = val('cfgClientes').trim(); const calendario = val('cfgCalendario').trim(); const shouldForceSheets = usuarios && clientes && calendario; const mode = (modeSel!=='sheets' && shouldForceSheets) ? 'sheets' : modeSel; const excluirVendedores = parseExcludeTextarea(); const cfg = { mode, sheets:{ usuarios, clientes, calendario }, excluirVendedores }; if(saveToLocalStorage(cfg)){ const s=document.getElementById('cfgStatus'); s.textContent='Configuraci√≥n guardada. Recargando...'; document.getElementById('btnCfgGuardar').disabled=true; document.getElementById('btnCfgProbar').disabled=true; document.getElementById('btnCfgAplicar').disabled=true; setTimeout(()=>{ closeConfig(); forceReload(); }, 350); } }
async function applyConfigNow(){ const usuarios = val('cfgUsuarios').trim(), clientes = val('cfgClientes').trim(), calendario = val('cfgCalendario').trim(); const excluirVendedores = parseExcludeTextarea(); const cfg = { mode:'sheets', sheets:{usuarios, clientes, calendario}, excluirVendedores }; saveToLocalStorage(cfg); document.getElementById('cfgStatus').textContent = 'Aplicando configuraci√≥n... cargando datos'; try{ STATE.users = (await fetchCSV(usuarios)).map(mapUserRecord); STATE.clientes = await fetchCSV(clientes); STATE.calendario = await fetchCSV(calendario); CONFIG = cfg; document.getElementById('modeLabel').textContent = CONFIG.mode; document.getElementById('usersCount').textContent = STATE.users.length; buildJoined(); buildFilters(); applyFilters(); document.getElementById('cfgStatus').textContent = 'Listo. Puedes cerrar esta ventana.'; }catch(err){ document.getElementById('cfgStatus').textContent = 'Error cargando datos: ' + err.message; } }
function clearConfig(){ try{ localStorage.removeItem('llamadas_config'); }catch(_){ } forceReload(); }

// Toggle legend
document.addEventListener('click', (e)=>{ if(e.target && e.target.id==='btnToggleLegend'){ const el = document.getElementById('legend'); const isHidden = el.classList.contains('hidden'); el.classList.toggle('hidden'); e.target.textContent = isHidden ? 'üëÅÔ∏è Ocultar leyenda' : 'üëÅÔ∏è Mostrar leyenda'; } });


// ======= GESTI√ìN DE VISITA (reporte de agenda) =======
function openGvReporte(){
  buildGvFilters(); renderGvReporte();
  const m=document.getElementById('modalAgReporte');
  m.classList.remove('hidden'); m.style.display='flex';
  document.body.classList.add('no-scroll');
}
function closeGvReporte(){
  const m=document.getElementById('modalAgReporte');
  m.classList.add('hidden'); m.style.display='none';
  document.body.classList.remove('no-scroll');
}
function buildGvFilters(){
  const data = allCalls().filter(c => c.cita_tipo && c.cita_tipo !== 'sin_cita');
  const vends = [...new Set(data.map(x => x.vendedor).filter(Boolean))].sort();
  const ges   = [...new Set(data.map(x => x.gestor_servicio).filter(Boolean))].sort();
  const selV = document.getElementById('gvVendedor');
  const selG = document.getElementById('gvGestor');
  selV.innerHTML = '<option value="">(todos)</option>' + vends.map(v=>`<option>${v}</option>`).join('');
  selG.innerHTML = '<option value="">(todos)</option>' + ges.map(v=>`<option>${v}</option>`).join('');
}
function gvFilters(){
  return {
    desde: document.getElementById('gvDesde').value,
    hasta: document.getElementById('gvHasta').value,
    vendedor: document.getElementById('gvVendedor').value,
    gestor: document.getElementById('gvGestor').value,
    status: document.getElementById('gvStatus').value
  };
}
function dayName(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr + 'T00:00:00');
  const dias = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
  return isNaN(d) ? '' : dias[d.getDay()];
}
function gvDataFiltered(){
  const {desde,hasta,vendedor,gestor,status} = gvFilters();
  const ds = desde? new Date(desde+'T00:00:00'):null;
  const hs = hasta? new Date(hasta+'T23:59:59'):null;
  return allCalls()
    .filter(r => r.cita_tipo && r.cita_tipo!=='sin_cita')
    .filter(r => {
      const f = r.cita_fecha? new Date(r.cita_fecha+'T'+(r.cita_hora||'00:00')) : null;
      if(ds && f && f<ds) return false;
      if(hs && f && f>hs) return false;
      if(vendedor && r.vendedor!==vendedor) return false;
      if(gestor && r.gestor_servicio!==gestor) return false;
      if(status){ if((r.estatus_visita||'programada')!==status) return false; } else { const s=(r.estatus_visita||'programada'); if(!(s==='programada'||s==='reprogramada')) return false; }
      return true;
    });
}
function renderGvReporte(){
  const tb = document.querySelector('#gvTbl tbody');
  tb.innerHTML = '';
  gvDataFiltered().forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.cita_fecha||''}</td>
      <td>${r.cita_hora||''}</td>
      <td>${dayName(r.cita_fecha)||''}</td>
      <td>${r.cliente||''}</td>
      <td>${r.cod_empresa||''}</td>
      <td>${r.vendedor||''}</td>
      <td>${r.gestor_servicio||''}</td>
      <td>${r.estatus_visita||'programada'}</td>
      <td>${r.cita_tipo||''}</td>
      <td>${r.observaciones||''}</td>`;
    tb.appendChild(tr);
  });
}
function exportGvCSV(){
  const headers=['Fecha','Hora','D√≠a','Cliente','Cod','Vendedor','Gestor','Estatus','Tipo','Obs'];
  const rows = gvDataFiltered().map(r=>[
    r.cita_fecha||'', r.cita_hora||'', dayName(r.cita_fecha)||'',
    r.cliente||'', r.cod_empresa||'', r.vendedor||'', r.gestor_servicio||'',
    r.estatus_visita||'programada', r.cita_tipo||'', r.observaciones||''
  ]);
  const csv=[headers.join(','), ...rows.map(r=>r.map(csvEscape).join(','))].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download='gestion_de_visita.csv'; a.click();
  URL.revokeObjectURL(a.href);
}

// ======================= INIT =======================
async function init(){
  try{ const saved = JSON.parse(localStorage.getItem('llamadas_config')||'null'); if(saved && typeof saved==='object'){ CONFIG = Object.assign({}, DEFAULT_CONFIG, saved); CONFIG.sheets = Object.assign({}, DEFAULT_CONFIG.sheets, saved.sheets||{}); CONFIG.excluirVendedores = Array.isArray(saved.excluirVendedores) ? saved.excluirVendedores : DEFAULT_CONFIG.excluirVendedores; } }catch(_){}
  document.getElementById('modeLabel').textContent = CONFIG.mode;

  if(CONFIG.mode==='sheets' && CONFIG.sheets.usuarios && CONFIG.sheets.clientes && CONFIG.sheets.calendario){
    try{ STATE.users = (await fetchCSV(CONFIG.sheets.usuarios)).map(mapUserRecord); STATE.clientes = await fetchCSV(CONFIG.sheets.clientes); STATE.calendario = await fetchCSV(CONFIG.sheets.calendario); }catch(err){ console.error(err); showErr('Error cargando hojas. Pasando a modo demo local.'); fallbackToDemo(); }
  }else{ fallbackToDemo(); }
  if(!STATE.users.length){ fallbackToDemo(); }
  document.getElementById('usersCount').textContent = STATE.users.length;

  buildJoined(); buildFilters(); updateStats(); applyFilters();

  // Events
  document.getElementById('btnLogin').addEventListener('click', doLogin);
  ['fSemana','fDia','fVendedor','fGestor','fEmpresa'].forEach(id=> document.getElementById(id).addEventListener('change', applyFilters));
  document.getElementById('fBuscar').addEventListener('input', applyFilters);
  document.getElementById('fCliente').addEventListener('change', ()=>{ const cod=val('fCliente'); const x=STATE.joined.find(r=> String(r.cod)===String(cod) ); if(x){ selectCliente(x); } else { STATE.selected=null; updateButtonsState(); } });
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('btnRestaurar').addEventListener('click', ()=>{ ['fSemana','fDia','fVendedor','fGestor','fEmpresa'].forEach(id=> document.getElementById(id).value=''); document.getElementById('fBuscar').value=''; document.getElementById('fCliente').value=''; STATE.selected=null; applyFilters(); });
  document.getElementById('btnToggleFiltros').addEventListener('click', ()=>{ const p=document.getElementById('panelFiltros'); p.style.display=(p.style.display==='none')?'block':'none'; setTimeout(()=>STATE.map&&STATE.map.invalidateSize(),50); });

  // Modales
  document.getElementById('btnRegistrar').addEventListener('click', openCallModal);
  document.getElementById('btnCallCancelar').addEventListener('click', closeCallModal);
  document.getElementById('callFechaHora').addEventListener('change', function(){ document.getElementById('callSemana').value = computeWeekFromVal(this.value); });
document.getElementById('btnCallGuardar').addEventListener('click', saveCallRecord);

  document.getElementById('btnReporte').addEventListener('click', openReporte);
  document.getElementById('btnRepCerrar').addEventListener('click', closeReporte);
  document.getElementById('repExport').addEventListener('click', exportReporteCSV);
  document.getElementById('repDesde').addEventListener('change', renderReporte);
  document.getElementById('repHasta').addEventListener('change', renderReporte);
  document.getElementById('repVendedor').addEventListener('input', renderReporte);
  document.getElementById('repGestor').addEventListener('input', renderReporte);
  document.getElementById('repResultado').addEventListener('change', renderReporte);

  document.getElementById('btnAgenda').addEventListener('click', openAgenda);
  document.getElementById('btnAgCerrar').addEventListener('click', closeAgenda);
  document.getElementById('agOpenReport').addEventListener('click', openGvReporte);
  document.getElementById('btnGvCerrar').addEventListener('click', closeGvReporte);
  ['gvDesde','gvHasta','gvStatus','gvVendedor','gvGestor'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change', renderGvReporte); });
  document.getElementById('gvExport').addEventListener('click', exportGvCSV);
  ['agDesde','agHasta','agStatus','agVendedor','agGestor'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change', renderAgenda); });
  document.getElementById('agExport').addEventListener('click', exportAgendaCSV);

  // Global ESC
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeConfig(); closeReporte(); closeCallModal(); closeAgenda(); } });
}
function fallbackToDemo(){ STATE.users = DEMO.usuarios.map(mapUserRecord); STATE.clientes = DEMO.clientes; STATE.calendario = DEMO.calendario; }

window.addEventListener('DOMContentLoaded', ()=>{ init(); initMap(); });
</script>

<script>

// === CORREGIDO: Ocultar cita solo al presionar Guardar y si estatus !== "programada" ===
document.querySelectorAll('.kcol').forEach(col => {
  col.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn || !btn.classList.contains('btn-primary')) return;

    const card = btn.closest('.kcard');
    if (!card) return;

    const select = card.querySelector('select');
    if (!select) return;

    const status = select.value.trim().toLowerCase();
    if (status !== 'programada') {
      setTimeout(() => {
        card.remove(); // Eliminar visualmente despu√©s del guardado
      }, 150);
    }
  });
});

function dedupById(arr) {
    const seen = new Set();
    return arr.filter(item => {
        if (!item.__id) return true;
        if (seen.has(item.__id)) return false;
        seen.add(item.__id);
        return true;
    });
}

// Reemplazar funciones para deduplicar
const originalLoadAllCallRecords = loadAllCallRecords;
loadAllCallRecords = function() {
    let local=[]; 
    try { local = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); } catch(_) { local=[]; }
    return dedupById([...local, ...STATE.calls]);
};

const originalAllCalls = allCalls;
allCalls = function() {
    let local=[]; 
    try { local = JSON.parse(localStorage.getItem('llamadas_records')||'[]'); } catch(_) { local=[]; }
    return dedupById([...local, ...STATE.calls].map(ensureId));
};

// Mapa: centrar y abrir popup del cliente seleccionado
let markerByCod = {};
function renderMap(){
  initMap(); clearMarkers(); markerByCod = {}; const bounds=[]; let rendered=0;
  STATE.filtered.forEach(x=>{ 
    if(!isFinite(x.lat)||!isFinite(x.lon)) return; 
    const color=getVendedorColor(x.vendedor); 
    const m=L.marker([x.lat,x.lon],{ icon: pinIcon(color) }).addTo(STATE.map);
    m.bindPopup(`<strong>${x.nombre}</strong><div class="muted">Cod ${x.cod} ‚Ä¢ ${x.empresa||''}</div><div>Semana: ${x.semana} ‚Ä¢ D√≠a: ${x.dia}</div><div>Vendedor: ${x.vendedor||'-'} ‚Ä¢ Gestor: ${x.gestor||'-'}</div>`);
    m.on('click',()=>selectCliente(x)); 
    STATE.markers.push(m); 
    markerByCod[x.cod] = m;
    bounds.push([x.lat,x.lon]); rendered++; 
  });
  document.getElementById('hintZero').style.display = rendered? 'none':'block';
  if(bounds.length){ STATE.map.fitBounds(bounds,{padding:[20,20]}); } else { STATE.map.setView([18.735693,-70.162651],8); }
  setTimeout(()=>STATE.map.invalidateSize(), 50);
}

function selectCliente(x){ 
    STATE.selected=x; 
    document.getElementById('fCliente').value=x.cod; 
    if(markerByCod[x.cod]){
        STATE.map.setView(markerByCod[x.cod].getLatLng(), 14);
        markerByCod[x.cod].openPopup();
    }
    updateButtonsState(); 
}

document.addEventListener('DOMContentLoaded', function(){
    const selCliente = document.getElementById('fCliente');
    if(selCliente){
        selCliente.addEventListener('change', function(){
            const cod = this.value;
            const cliente = STATE.joined.find(c => c.cod === cod);
            if(cliente){
                selectCliente(cliente);
            }
        });
    }
});
</script>



<!-- Modal Ver Ficha -->
<div id="modalFicha" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(700px, 90vw); max-height:90vh; overflow:auto;">
    <h3 class="title">üëÅÔ∏è Ficha del Cliente</h3>
    <div class="grid grid-2">
      <div><label>C√≥digo</label><input id="fichaCod" type="text" readonly /></div>
      <div><label>Nombre / Raz√≥n Social</label><input id="fichaNombre" type="text" readonly /></div>
      <div><label>Latitud</label><input id="fichaLat" type="text" readonly /></div>
      <div><label>Longitud</label><input id="fichaLon" type="text" readonly /></div>
      <div><label>Tel√©fono</label><input id="fichaTel" type="text" readonly /></div>
      <div><label>Celular</label><input id="fichaCel" type="text" readonly /></div>
      <div><label>Provincia</label><input id="fichaProv" type="text" readonly /></div>
      <div><label>Vendedor</label><input id="fichaVend" type="text" readonly /></div>
      <div><label>Gestor</label><input id="fichaGestor" type="text" readonly /></div>
      <div><label>Empresa</label><input id="fichaEmpresa" type="text" readonly /></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
      <button onclick="closeFichaModal()" class="btn btn-soft">Cerrar</button>
    </div>
  </div>
</div>

<div id="modalFicha" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(600px, 90vw);">
    <h3 class="title">üëÅÔ∏è Ficha del Cliente</h3>
    <p class="muted">Aqu√≠ se mostrar√° la informaci√≥n detallada del cliente seleccionado.</p>
    <div class="toolbar" style="justify-content:flex-end;">
      <button onclick="closeFichaModal()" class="btn btn-soft">Cerrar</button>
    </div>
  </div>
</div>


<!-- Modal Nuevo Cliente -->
<div id="modalNuevoCliente" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(700px, 90vw); max-height:90vh; overflow:auto;">
    <h3 class="title">‚ûï Nuevo Cliente</h3>
    <div class="grid grid-2">
      <div><label>C√≥digo</label><input id="nuevoCod" type="text" /></div>
      <div><label>Raz√≥n Social</label><input id="nuevoNombre" type="text" /></div>
      <div><label>Latitud</label><input id="nuevoLat" type="text" /></div>
      <div><label>Longitud</label><input id="nuevoLon" type="text" /></div>
      <div><label>Tel√©fono</label><input id="nuevoTel" type="text" /></div>
      <div><label>Celular</label><input id="nuevoCel" type="text" /></div>
      <div><label>Provincia</label><input id="nuevoProv" type="text" /></div>
      <div><label>Vendedor</label><input id="nuevoVend" type="text" /></div>
      <div><label>Gestor</label><input id="nuevoGestor" type="text" /></div>
      <div><label>Empresa</label><input id="nuevoEmpresa" type="text" /></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
      <button onclick="closeNuevoClienteModal()" class="btn btn-soft">Cancelar</button>
      <button onclick="guardarNuevoCliente()" class="btn btn-primary">Guardar</button>
    </div>
    <p id="nuevoClienteStatus" class="muted" style="margin-top:6px;"></p>
  </div>
</div>

<div id="modalNuevoCliente" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(600px, 90vw);">
    <h3 class="title">‚ûï Nuevo Cliente</h3>
    <p class="muted">Formulario para agregar un nuevo cliente (en desarrollo).</p>
    <div class="toolbar" style="justify-content:flex-end;">
      <button onclick="closeNuevoClienteModal()" class="btn btn-soft">Cerrar</button>
    </div>
  </div>
</div>

<script>

// === CORREGIDO: Ocultar cita solo al presionar Guardar y si estatus !== "programada" ===
document.querySelectorAll('.kcol').forEach(col => {
  col.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn || !btn.classList.contains('btn-primary')) return;

    const card = btn.closest('.kcard');
    if (!card) return;

    const select = card.querySelector('select');
    if (!select) return;

    const status = select.value.trim().toLowerCase();
    if (status !== 'programada') {
      setTimeout(() => {
        card.remove(); // Eliminar visualmente despu√©s del guardado
      }, 150);
    }
  });
});


// Abrir/Cerrar modal Ver Ficha
document.getElementById('btnFicha').addEventListener('click', () => {
  document.getElementById('modalFicha').classList.remove('hidden');
  document.body.classList.add('no-scroll');
});
function closeFichaModal() {
  document.getElementById('modalFicha').classList.add('hidden');
  document.body.classList.remove('no-scroll');
}

// Abrir/Cerrar modal Nuevo Cliente
document.getElementById('btnNuevoCliente').addEventListener('click', () => {
  document.getElementById('modalNuevoCliente').classList.remove('hidden');
  document.body.classList.add('no-scroll');
});
function closeNuevoClienteModal() {
  document.getElementById('modalNuevoCliente').classList.add('hidden');
  document.body.classList.remove('no-scroll');
}

</script>


<!-- Modal Ver Ficha -->
<div id="modalFicha" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(700px, 90vw); max-height:90vh; overflow:auto;">
    <h3 class="title">üëÅÔ∏è Ficha del Cliente</h3>
    <div class="grid grid-2">
      <div><label>C√≥digo</label><input id="fichaCod" type="text" readonly /></div>
      <div><label>Nombre / Raz√≥n Social</label><input id="fichaNombre" type="text" readonly /></div>
      <div><label>Latitud</label><input id="fichaLat" type="text" readonly /></div>
      <div><label>Longitud</label><input id="fichaLon" type="text" readonly /></div>
      <div><label>Tel√©fono</label><input id="fichaTel" type="text" readonly /></div>
      <div><label>Celular</label><input id="fichaCel" type="text" readonly /></div>
      <div><label>Provincia</label><input id="fichaProv" type="text" readonly /></div>
      <div><label>Vendedor</label><input id="fichaVend" type="text" readonly /></div>
      <div><label>Gestor</label><input id="fichaGestor" type="text" readonly /></div>
      <div><label>Empresa</label><input id="fichaEmpresa" type="text" readonly /></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
      <button onclick="closeFichaModal()" class="btn btn-soft">Cerrar</button>
    </div>
  </div>
</div>

<div id="modalFicha" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(700px, 90vw); max-height:90vh; overflow:auto;">
    <h3 class="title">üëÅÔ∏è Ficha del Cliente</h3>
    <div class="grid grid-2">
      <div><label>C√≥digo</label><input id="fichaCod" type="text" readonly /></div>
      <div><label>Nombre / Raz√≥n Social</label><input id="fichaNombre" type="text" readonly /></div>
      <div><label>Latitud</label><input id="fichaLat" type="text" readonly /></div>
      <div><label>Longitud</label><input id="fichaLon" type="text" readonly /></div>
      <div><label>Tel√©fono</label><input id="fichaTel" type="text" readonly /></div>
      <div><label>Celular</label><input id="fichaCel" type="text" readonly /></div>
      <div><label>Provincia</label><input id="fichaProv" type="text" readonly /></div>
      <div><label>Vendedor</label><input id="fichaVend" type="text" readonly /></div>
      <div><label>Gestor</label><input id="fichaGestor" type="text" readonly /></div>
      <div><label>Empresa</label><input id="fichaEmpresa" type="text" readonly /></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
      <button onclick="closeFichaModal()" class="btn btn-soft">Cerrar</button>
    </div>
  </div>
</div>


<!-- Modal Nuevo Cliente -->
<div id="modalNuevoCliente" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(700px, 90vw); max-height:90vh; overflow:auto;">
    <h3 class="title">‚ûï Nuevo Cliente</h3>
    <div class="grid grid-2">
      <div><label>C√≥digo</label><input id="nuevoCod" type="text" /></div>
      <div><label>Raz√≥n Social</label><input id="nuevoNombre" type="text" /></div>
      <div><label>Latitud</label><input id="nuevoLat" type="text" /></div>
      <div><label>Longitud</label><input id="nuevoLon" type="text" /></div>
      <div><label>Tel√©fono</label><input id="nuevoTel" type="text" /></div>
      <div><label>Celular</label><input id="nuevoCel" type="text" /></div>
      <div><label>Provincia</label><input id="nuevoProv" type="text" /></div>
      <div><label>Vendedor</label><input id="nuevoVend" type="text" /></div>
      <div><label>Gestor</label><input id="nuevoGestor" type="text" /></div>
      <div><label>Empresa</label><input id="nuevoEmpresa" type="text" /></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
      <button onclick="closeNuevoClienteModal()" class="btn btn-soft">Cancelar</button>
      <button onclick="guardarNuevoCliente()" class="btn btn-primary">Guardar</button>
    </div>
    <p id="nuevoClienteStatus" class="muted" style="margin-top:6px;"></p>
  </div>
</div>

<div id="modalNuevoCliente" class="modal hidden" aria-modal="true" role="dialog">
  <div class="card" style="width:min(700px, 90vw); max-height:90vh; overflow:auto;">
    <h3 class="title">‚ûï Nuevo Cliente</h3>
    <div class="grid grid-2">
      <div><label>C√≥digo</label><input id="nuevoCod" type="text" /></div>
      <div><label>Nombre / Raz√≥n Social</label><input id="nuevoNombre" type="text" /></div>
      <div><label>Latitud</label><input id="nuevoLat" type="text" /></div>
      <div><label>Longitud</label><input id="nuevoLon" type="text" /></div>
      <div><label>Tel√©fono</label><input id="nuevoTel" type="text" /></div>
      <div><label>Celular</label><input id="nuevoCel" type="text" /></div>
      <div><label>Provincia</label><input id="nuevoProv" type="text" /></div>
      <div><label>Vendedor</label><input id="nuevoVend" type="text" /></div>
      <div><label>Gestor</label><input id="nuevoGestor" type="text" /></div>
      <div><label>Empresa</label><input id="nuevoEmpresa" type="text" /></div>
    </div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:10px;">
      <button onclick="closeNuevoClienteModal()" class="btn btn-soft">Cancelar</button>
      <button onclick="guardarNuevoCliente()" class="btn btn-primary">Guardar</button>
    </div>
    <p id="nuevoClienteStatus" class="muted" style="margin-top:6px;"></p>
  </div>
</div>

<script>

// === CORREGIDO: Ocultar cita solo al presionar Guardar y si estatus !== "programada" ===
document.querySelectorAll('.kcol').forEach(col => {
  col.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn || !btn.classList.contains('btn-primary')) return;

    const card = btn.closest('.kcard');
    if (!card) return;

    const select = card.querySelector('select');
    if (!select) return;

    const status = select.value.trim().toLowerCase();
    if (status !== 'programada') {
      setTimeout(() => {
        card.remove(); // Eliminar visualmente despu√©s del guardado
      }, 150);
    }
  });
});


// Mostrar ficha de cliente
document.getElementById('btnFicha').addEventListener('click', () => {
  const x = STATE.selected;
  if (!x) return;
  document.getElementById('fichaCod').value = x.cod || '';
  document.getElementById('fichaNombre').value = x.nombre || '';
  document.getElementById('fichaLat').value = x.lat || '';
  document.getElementById('fichaLon').value = x.lon || '';
  document.getElementById('fichaTel').value = x.telefono1 || '';
  document.getElementById('fichaCel').value = x.celular || '';
  document.getElementById('fichaProv').value = x.provincia || '';
  document.getElementById('fichaVend').value = x.vendedor || '';
  document.getElementById('fichaGestor').value = x.gestor || '';
  document.getElementById('fichaEmpresa').value = x.empresa || '';
  document.getElementById('modalFicha').classList.remove('hidden');
  document.body.classList.add('no-scroll');
});
function closeFichaModal() {
  document.getElementById('modalFicha').classList.add('hidden');
  document.body.classList.remove('no-scroll');
}

// Modal Nuevo Cliente
document.getElementById('btnNuevoCliente').addEventListener('click', () => {
  document.querySelectorAll('#modalNuevoCliente input').forEach(i => i.value = '');
  document.getElementById('nuevoClienteStatus').textContent = '';
  document.getElementById('modalNuevoCliente').classList.remove('hidden');
  document.body.classList.add('no-scroll');
});
function closeNuevoClienteModal() {
  document.getElementById('modalNuevoCliente').classList.add('hidden');
  document.body.classList.remove('no-scroll');
}
function guardarNuevoCliente() {
  const nuevo = {
    cod: document.getElementById('nuevoCod').value.trim(),
    nombre: document.getElementById('nuevoNombre').value.trim(),
    lat: parseCoord(document.getElementById('nuevoLat').value),
    lon: parseCoord(document.getElementById('nuevoLon').value),
    telefono1: document.getElementById('nuevoTel').value.trim(),
    celular: document.getElementById('nuevoCel').value.trim(),
    provincia: document.getElementById('nuevoProv').value.trim(),
    vendedor: document.getElementById('nuevoVend').value.trim(),
    gestor: document.getElementById('nuevoGestor').value.trim(),
    empresa: document.getElementById('nuevoEmpresa').value.trim(),
    semana: 'Por asignar',
    dia: 'Por asignar'
  };
  if (!nuevo.cod || !nuevo.nombre) {
    document.getElementById('nuevoClienteStatus').textContent = 'C√≥digo y Nombre son obligatorios.';
    return;
  }
  STATE.joined.push(nuevo);
  applyFilters();
  closeNuevoClienteModal();
  showErr('Nuevo cliente agregado (localmente).');
}

</script>

<script>
// ===== Resumen de llamadas (A realizar vs Realizadas) =====

// Normalizaci√≥n de d√≠a
const __DIAS_OK = ['lunes','martes','miercoles','mi√©rcoles','jueves','viernes','sabado','s√°bado','domingo'];
function __normDia(d){
  const s = (String(d||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase());
  return __DIAS_OK.includes(s) ? s : String(d||'').toLowerCase();
}

// Construye √≠ndice de planificaci√≥n (A realizar) desde STATE.joined o STATE.filtered
function __buildPlanIndex(baseRows){
  const map = new Map();
  for(const x of (baseRows||[])){
    const gestor = (x.gestor||'').trim();
    const sem = (x.semana!==undefined && x.semana!==null) ? String(x.semana) : '';
    const dia = __normDia(x.dia);
    const key = gestor+'||'+sem+'||'+dia;
    const it = map.get(key) || { gestor, semana: sem, dia: (x.dia||''), asignados:0 };
    it.asignados += 1;
    map.set(key, it);
  }
  return map;
}

// Construye √≠ndice de realizadas desde registros de llamadas (localStorage + STATE.calls)
function __toDate(s){ const d = new Date(s); return isNaN(d)? null : d; }
function __buildDoneIndex(allCalls, dateFrom, dateTo){
  const from = dateFrom ? new Date(dateFrom+'T00:00:00') : null;
  const to   = dateTo   ? new Date(dateTo+'T23:59:59')   : null;
  const map = new Map();
  for(const r of (allCalls||[])){
    const d = __toDate(r.fecha_hora); if(!d) continue;
    if(from && d < from) continue; if(to && d > to) continue;
    const gestor = (r.gestor_servicio||'').trim();
    const dia = __normDia(d.toLocaleDateString('es-ES',{ weekday:'long' }));
    const sem = ''; // Si se desea cruzar por semana planificada, dejar vac√≠o o parametrizar
    const key = gestor+'||'+sem+'||'+dia;
    const it = map.get(key) || { gestor, semana: sem, dia, realizadas:0, last:null };
    it.realizadas += 1;
    it.last = (!it.last || (__toDate(it.last) < d)) ? r.fecha_hora : it.last;
    map.set(key, it);
  }
  return map;
}

// Render del Resumen
function __renderRepResumen(){
  const desde = (document.getElementById('repDesde')||{}).value || '';
  const hasta = (document.getElementById('repHasta')||{}).value || '';
  const fv = ((document.getElementById('repVendedor')||{}).value||'').trim().toLowerCase();
  const fg = ((document.getElementById('repGestor')||{}).value||'').trim().toLowerCase();

  // Base de planificaci√≥n desde vista filtrada si existe, si no, todo unido
  const base = (window.STATE && Array.isArray(STATE.filtered) && STATE.filtered.length) ? STATE.filtered
              : (window.STATE && Array.isArray(STATE.joined) ? STATE.joined : []);

  const baseFiltrada = base.filter(x=>{
    if(fv && String(x.vendedor||'').toLowerCase() !== fv) return false;
    if(fg && String(x.gestor||'').toLowerCase() !== fg) return false;
    return true;
  });

  // Llamadas realizadas
  let local = [];
  try{ local = JSON.parse(localStorage.getItem('llamadas_records') || '[]'); }catch(_){ local=[]; }
  const allCalls = [...(local||[]), ...((window.STATE && Array.isArray(STATE.calls))? STATE.calls : [])];
  const callsFiltradas = allCalls.filter(c=>{
    if(fv && String(c.vendedor||'').toLowerCase() !== fv) return false;
    if(fg && String(c.gestor_servicio||'').toLowerCase() !== fg) return false;
    return true;
  });

  const planIdx = __buildPlanIndex(baseFiltrada);
  const doneIdx = __buildDoneIndex(callsFiltradas, desde, hasta);

  const keys = new Set([...planIdx.keys(), ...doneIdx.keys()]);
  const rows = [];
  for(const k of keys){
    const p = planIdx.get(k) || {gestor:'', semana:'', dia:'', asignados:0};
    const d = doneIdx.get(k) || {realizadas:0, last:null};
    const asignados = p.asignados||0;
    const realizadas = d.realizadas||0;
    const pct = asignados ? (realizadas/asignados*100) : (realizadas? 100 : 0);
    rows.push({
      gestor: p.gestor || d.gestor || '',
      semana: p.semana || d.semana || '',
      dia:    p.dia    || d.dia    || '',
      asignados, realizadas, pct, last: d.last || ''
    });
  }

  rows.sort((a,b)=> a.gestor.localeCompare(b.gestor,'es',{numeric:true}) ||
                   String(a.semana).localeCompare(String(b.semana),'es',{numeric:true}) ||
                   String(a.dia).localeCompare(String(b.dia),'es',{numeric:true}));

  const tb = document.querySelector('#repSumTbl tbody');
  if(tb){
    tb.innerHTML = rows.map(r=>'<tr>'
      +'<td>'+ (r.gestor||'-') +'</td>'
      +'<td>'+ (r.semana||'-') +'</td>'
      +'<td>'+ (r.dia||'-') +'</td>'
      +'<td>'+ r.asignados +'</td>'
      +'<td>'+ r.realizadas +'</td>'
      +'<td>'+ r.pct.toFixed(1) +'%' +'</td>'
      +'<td>'+ (r.last ? new Date(r.last).toLocaleString() : '-') +'</td>'
    +'</tr>').join('');
  }
}

// Alternar pesta√±as
function __repShowResumen(){
  const a = document.getElementById('repResumenWrap');
  const b = document.getElementById('repDetalleWrap');
  if(a) a.style.display = 'block';
  if(b) b.style.display = 'none';
  __renderRepResumen();
}
function __repShowDetalle(){
  const a = document.getElementById('repResumenWrap');
  const b = document.getElementById('repDetalleWrap');
  if(a) a.style.display = 'none';
  if(b) b.style.display = 'block';
  // la tabla de detalle ya se renderiza con renderReporte()
}

// Exportar CSV del resumen
function __exportRepResumen(){
  const rows = [...document.querySelectorAll('#repSumTbl tbody tr')].map(tr=>[...tr.children].map(td=>td.textContent));
  const headers = ['Gestor','Semana','D√≠a','A realizar','Realizadas','% Cobertura','√öltima llamada'];
  const csv = [headers, *rows].map(r=>r.map(x=>('"'+String(x).replace(/"/g,'""')+'"')).join(',')).join('\\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'reporte_resumen_llamadas.csv'; a.click();
  URL.revokeObjectURL(a.href);
}

// Enlaces de UI del modal
document.addEventListener('click', (ev)=>{
  if(ev.target && ev.target.id === 'repTabResumen'){ __repShowResumen(); }
  if(ev.target && ev.target.id === 'repTabDetalle'){ __repShowDetalle(); }
  if(ev.target && ev.target.id === 'repSumExport'){ __exportRepResumen(); }
});

// Al abrir el modal de Reporte, intentamos mostrar por defecto el Resumen si existe
(function(){
  const origOpen = window.openReporte;
  if(typeof origOpen === 'function'){
    window.openReporte = function(){
      origOpen();
      // Si nuestro wrap existe, mu√©stralo por defecto
      if(document.getElementById('repResumenWrap')){
        __repShowResumen();
      }
    };
  }
})();
</script>


<script>
document.addEventListener('click', (ev)=>{
  if(ev.target && ev.target.id === 'btnReporteResumen'){
    if(typeof window.openReporte === 'function'){ 
      window.openReporte();
      if(typeof window.__repShowResumen === 'function') window.__repShowResumen();
    }
  }
});
</script>


<!-- ===== Pantalla: Reporte Resumen ===== -->
<section id="screenResumen" style="display:none; padding:16px 0 40px 0;">
  <div class="card" style="padding:14px 18px;">
    <div class="toolbar" style="gap:8px; align-items:center; flex-wrap:wrap;">
      <h2 style="margin:0; font-size:20px;">Reporte de Llamadas ‚Äî Resumen</h2>
      <div style="flex:1"></div>
      <button id="rrExport" class="btn">‚¨á Exportar CSV</button>
      <button id="rrVolver" class="btn btn-soft">‚Üê Volver</button>
    </div>

    <div class="grid" style="grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin-top:12px;">
      <div>
        <label class="lbl">Semana</label>
        <select id="rrSemana" class="input"><option value="">Todas</option></select>
      </div>
      <div>
        <label class="lbl">D√≠a</label>
        <select id="rrDia" class="input">
          <option value="">Todos</option>
          <option>Lunes</option><option>Martes</option><option>Mi√©rcoles</option>
          <option>Jueves</option><option>Viernes</option><option>S√°bado</option><option>Domingo</option>
        </select>
      </div>
      <div>
        <label class="lbl">Vendedor</label>
        <select id="rrVendedor" class="input"><option value="">Todos</option></select>
      </div>
      <div>
        <label class="lbl">Gestor</label>
        <select id="rrGestor" class="input"><option value="">Todos</option></select>
      </div>
    
    </div>

    <div id="rrKpis" class="toolbar" style="gap:12px; margin-top:10px; flex-wrap:wrap;">
      <span class="chip">A realizar: <b id="kpiAsignadas">0</b></span>
      <span class="chip">Realizadas: <b id="kpiHechas">0</b></span>
      <span class="chip">Cobertura: <b id="kpiCobertura">0%</b></span>
    </div>

    <div style="margin-top:12px; max-height:60vh; overflow:auto; border-radius:10px;">

      <table class="table" id="rrTbl">
        <thead>
          <tr><th>Gestor</th><th>Semana</th><th>D√≠a</th><th>A realizar</th><th>Realizadas</th><th>% Cobertura</th><th>√öltima llamada</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>


<script>
(function(){
  // Navegaci√≥n simple entre la pantalla principal y el reporte-resumen
  function showResumenScreen(){
    const s = document.getElementById('screenResumen');
    if(!s) return;
    // ocultar contenedor principal (primer .card grande si existe) o body children excepto s
    const bodyChildren = [...document.body.children];
    bodyChildren.forEach(el=>{
      if(el.id === 'screenResumen' || el.tagName.toLowerCase()==='script') return;
      // Mantener visibles elementos fuera del app? Asumimos primera card es el app principal
      // Si el main app tiene id "app" se podr√≠a usar; aqu√≠ ocultamos tarjetas de la UI principal comunes
      if(el.matches('section,div,main')) el.style.display = 'none';
    });
    s.style.display = 'block';
    populateRRFilters();
    renderRR();
  }
  function backToMain(){
    const s = document.getElementById('screenResumen');
    if(!s) return;
    s.style.display = 'none';
    // Mostrar nuevamente el resto
    const bodyChildren = [...document.body.children];
    bodyChildren.forEach(el=>{
      if(el.id === 'screenResumen' || el.tagName.toLowerCase()==='script') return;
      if(el.style && el.style.display === 'none') el.style.display = '';
    });
  }
  window.__showResumenScreen = showResumenScreen;

  // Hook bot√≥n existente
  document.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.id === 'btnReporteResumen'){
      ev.preventDefault();
      showResumenScreen();
    }
    if(ev.target && ev.target.id === 'rrVolver'){
      ev.preventDefault();
      backToMain();
    }
    if(ev.target && ev.target.id === 'rrExport'){
      exportRR();
    }
  });

  // Poblar filtros desde datos
  function uniqueVals(arr, key){
    const s = new Set();
    for(const x of arr||[]){
      const v = (x[key]!==undefined && x[key]!==null) ? String(x[key]).trim() : '';
      if(v) s.add(v);
    }
    return [...s].sort((a,b)=> a.localeCompare(b,'es',{numeric:true}));
  }
  function populateRRFilters(){
    const base = (window.STATE && Array.isArray(STATE.joined)) ? STATE.joined : [];
    const semanas = uniqueVals(base, 'semana');
    const vendedores = uniqueVals(base, 'vendedor');
    const gestores = uniqueVals(base, 'gestor');

    const selSemana = document.getElementById('rrSemana');
    const selVend = document.getElementById('rrVendedor');
    const selGest = document.getElementById('rrGestor');
    if(selSemana && selSemana.options.length<=1){
      semanas.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selSemana.appendChild(o); });
    }
    if(selVend && selVend.options.length<=1){
      vendedores.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selVend.appendChild(o); });
    }
    if(selGest && selGest.options.length<=1){
      gestores.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selGest.appendChild(o); });
    }
  }

  // Normalizaci√≥n de d√≠a (mismo helper que el modal)
  const RR_DIAS_OK = ['lunes','martes','miercoles','mi√©rcoles','jueves','viernes','sabado','s√°bado','domingo'];
  function rrNormDia(d){
    const s = (String(d||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase());
    return RR_DIAS_OK.includes(s) ? s : String(d||'').toLowerCase();
  }

  function buildPlanIndex(baseRows){
    const map = new Map();
    for(const x of (baseRows||[])){
      const gestor = (x.gestor||'').trim();
      const sem = (x.semana!==undefined && x.semana!==null) ? String(x.semana) : '';
      const dia = rrNormDia(x.dia);
      const key = gestor+'||'+sem+'||'+dia;
      const it = map.get(key) || { gestor, semana: sem, dia: (x.dia||''), asignados:0 };
      it.asignados += 1;
      map.set(key, it);
    }
    return map;
  }
  function toDate(s){ const d = new Date(s); return isNaN(d)? null : d; }
  function buildDoneIndex(allCalls){
    const map = new Map();
    for(const r of (allCalls||[])){
      const d = toDate(r.fecha_hora); if(!d) continue;
      const gestor = (r.gestor_servicio||'').trim();
      const dia = rrNormDia(d.toLocaleDateString('es-ES',{ weekday:'long' }));
      const sem = ''; // si en el futuro deseas cruzar por semana planificada
      const key = gestor+'||'+sem+'||'+dia;
      const it = map.get(key) || { gestor, semana: sem, dia, realizadas:0, last:null };
      it.realizadas += 1;
      it.last = (!it.last || (toDate(it.last) < d)) ? r.fecha_hora : it.last;
      map.set(key, it);
    }
    return map;
  }

  function renderRR(){
    const fSemana = (document.getElementById('rrSemana')||{}).value || '';
    const fDia = (document.getElementById('rrDia')||{}).value || '';
    const fVend = (document.getElementById('rrVendedor')||{}).value || '';
    const fGest = (document.getElementById('rrGestor')||{}).value || '';

    const base = (window.STATE && Array.isArray(STATE.joined)) ? STATE.joined : [];
    const baseFiltrada = base.filter(x=>{
      if(fSemana && String(x.semana) !== String(fSemana)) return false;
      if(fDia && String(x.dia).toLowerCase() !== String(fDia).toLowerCase()) return false;
      if(fVend && String(x.vendedor) !== String(fVend)) return false;
      if(fGest && String(x.gestor) !== String(fGest)) return false;
      return true;
    });

    let local = [];
    try{ local = JSON.parse(localStorage.getItem('llamadas_records') || '[]'); }catch(_){ local=[]; }
    const allCalls = [...(local||[]), ...((window.STATE && Array.isArray(STATE.calls))? STATE.calls : [])];
    const callsFiltradas = allCalls.filter(c=>{
      if(fVend && String(c.vendedor) !== String(fVend)) return false;
      if(fGest && String(c.gestor_servicio) !== String(fGest)) return false;
      // si quieres filtrar por semana/d√≠a tambi√©n del selector, se podr√≠a inferir del timestamp; por ahora no
      return true;
    });

    const planIdx = buildPlanIndex(baseFiltrada);
    const doneIdx = buildDoneIndex(callsFiltradas);
    const keys = new Set([...planIdx.keys(), ...doneIdx.keys()]);
    const rows = [];
    for(const k of keys){
      const p = planIdx.get(k) || {gestor:'', semana:'', dia:'', asignados:0};
      const d = doneIdx.get(k) || {realizadas:0, last:null};
      const asignados = p.asignados||0;
      const realizadas = d.realizadas||0;
      const pct = asignados ? (realizadas/asignados*100) : (realizadas? 100 : 0);
      rows.push({
        gestor: p.gestor || d.gestor || '',
        semana: p.semana || d.semana || '',
        dia:    p.dia    || d.dia    || '',
        asignados, realizadas, pct, last: d.last || ''
      });
    }
    rows.sort((a,b)=> a.gestor.localeCompare(b.gestor,'es',{numeric:true}) ||
                     String(a.semana).localeCompare(String(b.semana),'es',{numeric:true}) ||
                     String(a.dia).localeCompare(String(b.dia),'es',{numeric:true}));

    const tb = document.querySelector('#rrTbl tbody');
    if(tb){
      tb.innerHTML = rows.map(r=>'<tr>'
        +'<td>'+ (r.gestor||'-') +'</td>'
        +'<td>'+ (r.semana||'-') +'</td>'
        +'<td>'+ (r.dia||'-') +'</td>'
        +'<td>'+ r.asignados +'</td>'
        +'<td>'+ r.realizadas +'</td>'
        +'<td>'+ r.pct.toFixed(1) +'%' +'</td>'
        +'<td>'+ (r.last ? new Date(r.last).toLocaleString() : '-') +'</td>'
      +'</tr>').join('');
    }
  }

  // Listeners de filtros
  ['rrSemana','rrDia','rrVendedor','rrGestor'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('change', renderRR);
  });

  // Exportar CSV
  function exportRR(){
    const rows = [...document.querySelectorAll('#rrTbl tbody tr')].map(tr=>[...tr.children].map(td=>td.textContent));
    const headers = ['Gestor','Semana','D√≠a','A realizar','Realizadas','% Cobertura','√öltima llamada'];
    const csv = [headers, ...rows].map(r=>r.map(x=>('"'+String(x).replace(/"/g,'""')+'"')).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'reporte_resumen_llamadas.csv'; a.click();
    URL.revokeObjectURL(a.href);
  }
  window.exportRR = exportRR;
})();
</script>


<script>
document.addEventListener('click', (ev)=>{
  if(ev.target && ev.target.id === 'btnReporteResumen'){
    if(typeof window.__showResumenScreen === 'function'){ window.__showResumenScreen(); }
  }
});
</script>


<script>
(function(){
  // Reintento de poblaci√≥n de filtros cuando los datos a√∫n no han cargado
  let rrPopulateTries = 0;
  function rrTryPopulateLater(){
    rrPopulateTries += 1;
    if(rrPopulateTries>20) return; // ~6s si 300ms
    setTimeout(()=>{
      const base = (window.STATE && Array.isArray(STATE.joined)) ? STATE.joined : [];
      // solo repoblar si siguen vac√≠os y ya hay datos
      const selSemana = document.getElementById('rrSemana');
      const selVend = document.getElementById('rrVendedor');
      const selGest = document.getElementById('rrGestor');
      const need = (selSemana && selSemana.options.length<=1) || (selVend && selVend.options.length<=1) || (selGest && selGest.options.length<=1);
      if(base.length && need){
        // reutilizar populateRRFilters si existe
        if(typeof populateRRFilters==='function'){ populateRRFilters(); renderRR(); return; }
      }
      // seguir intentando
      rrTryPopulateLater();
    }, 300);
  }

  // KPI updater hooking into renderRR if available
  const _oldRender = window.renderRR;
  window.renderRR = function(){
    if(typeof _oldRender==='function'){ _oldRender(); }
    try {
      // leer totales de la tabla renderizada
      const rows = [...document.querySelectorAll('#rrTbl tbody tr')].map(tr=>[...tr.children].map(td=>td.textContent));
      let asign = 0, hechas = 0;
      for(const r of rows){
        asign += Number(r[3]||0);
        hechas += Number(r[4]||0);
      }
      const cov = asign ? (hechas/asign*100) : (hechas?100:0);
      const a = document.getElementById('kpiAsignadas'); if(a) a.textContent = String(asign);
      const h = document.getElementById('kpiHechas'); if(h) h.textContent = String(hechas);
      const c = document.getElementById('kpiCobertura'); if(c) c.textContent = cov.toFixed(1)+'%';
    } catch(_){}
  };

  // Al mostrar la pantalla, si no hay opciones, reintenta hasta que STATE.joined est√© listo
  const _oldShow = window.__showResumenScreen;
  window.__showResumenScreen = function(){
    if(typeof _oldShow==='function'){ _oldShow(); }
    // Si qued√≥ vac√≠o, reintenta popular
    rrPopulateTries = 0;
    rrTryPopulateLater();
  };
})();
</script>


<script>
(function(){
  function pick(obj, keys){
    for(const k of keys){
      if(k in obj && obj[k]!=null && obj[k]!=='' ) return obj[k];
      const found = Object.keys(obj).find(x=>x.toLowerCase()===k.toLowerCase());
      if(found) return obj[found];
    }
    return undefined;
  }
  function normStr(s){ return String(s||'').trim(); }
  function normDia(d){
    return String(d||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
  }
  const K = {
    semana: ['Semana','N Semana','N_Semana','n_semana','n semana','semana'],
    dia: ['D√≠a','Dia','d√≠a','dia'],
    vendedor: ['Vendedor','VENDEDOR','vendedor'],
    gestor: ['Gestor','gestor','Gestor cartera','gestor_cartera','gestor_servicio'],
    cod: ['Cod','C√≥digo','Codigo','codigo','cod','codigo_npg','id','ID','Id','Cod Cliente','cod cliente']
  };
  function getBase(){
    const base = (window.STATE && Array.isArray(STATE.joined)) ? STATE.joined : [];
    return base.map(x=>({
      gestor: normStr(pick(x, K.gestor) || 'NO ASIGNADO'),
      vendedor: normStr(pick(x, K.vendedor) || ''),
      semana: normStr(pick(x, K.semana) || ''),
      dia: normStr(pick(x, K.dia) || ''),
      cod: normStr(pick(x, K.cod) || '')
    }));
  }
  function indexByCod(base){
    const map = new Map();
    for(const r of base){
      if(r.cod) map.set(r.cod, r);
    }
    return map;
  }
  window.populateRRFilters = function populateRRFilters(){
    const base = getBase();
    const selSemana = document.getElementById('rrSemana');
    const selVend = document.getElementById('rrVendedor');
    const selGest = document.getElementById('rrGestor');
    function addOpts(sel, values){
      if(!sel) return;
      const have = new Set([...sel.options].map(o=>o.value));
      for(const v of values){
        if(!have.has(v) && v!=='') {
          const o = document.createElement('option');
          o.value = v; o.textContent = v;
          sel.appendChild(o);
        }
      }
    }
    const semanas = [...new Set(base.map(x=>x.semana).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es',{numeric:true}));
    const vend = [...new Set(base.map(x=>x.vendedor).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es',{numeric:true}));
    const gest = [...new Set(base.map(x=>x.gestor).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es',{numeric:true}));
    addOpts(selSemana, semanas);
    addOpts(selVend, vend);
    addOpts(selGest, gest);
  };

  const _oldRenderRR = window.renderRR;
  window.renderRR = function(){
    const fSemana = (document.getElementById('rrSemana')||{}).value || '';
    const fDia = (document.getElementById('rrDia')||{}).value || '';
    const fVend = (document.getElementById('rrVendedor')||{}).value || '';
    const fGest = (document.getElementById('rrGestor')||{}).value || '';

    const baseAll = getBase();
    const base = baseAll.filter(x=>{
      if(fSemana && x.semana !== fSemana) return false;
      if(fDia && normDia(x.dia) !== normDia(fDia)) return false;
      if(fVend && x.vendedor !== fVend) return false;
      if(fGest && x.gestor !== fGest) return false;
      return true;
    });

    const planMap = new Map();
    function keyOf(r){ return r.gestor+'||'+r.semana+'||'+normDia(r.dia); }
    for(const r of base){
      const k = keyOf(r);
      const it = planMap.get(k) || {gestor:r.gestor, semana:r.semana, dia:r.dia, asignados:0};
      it.asignados += 1;
      planMap.set(k, it);
    }

    let calls = [];
    try{ calls = JSON.parse(localStorage.getItem('llamadas_records') || '[]'); }catch(_){ calls=[]; }
    if(window.STATE && Array.isArray(STATE.calls)) calls = calls.concat(STATE.calls);

    const codIndex = indexByCod(baseAll);
    const doneMap = new Map();
    for(const c of calls){
      const cod = normStr(c.cod || c.codigo || c.cod_cliente || c.id || c.Cod || '');
      const plan = codIndex.get(cod);
      if(!plan) continue;
      if(fSemana && plan.semana !== fSemana) continue;
      if(fDia && normDia(plan.dia) !== normDia(fDia)) continue;
      if(fVend && plan.vendedor !== fVend) continue;
      if(fGest && plan.gestor !== fGest) continue;
      const k = plan.gestor+'||'+plan.semana+'||'+normDia(plan.dia);
      const it = doneMap.get(k) || {gestor:plan.gestor, semana:plan.semana, dia:plan.dia, realizadas:0, last:null};
      it.realizadas += 1;
      const d = new Date(c.fecha_hora||c.fecha||c.timestamp||'');
      if(!isNaN(d)) it.last = (!it.last || new Date(it.last) < d) ? d.toISOString() : it.last;
      doneMap.set(k, it);
    }

    const keys = new Set([...planMap.keys(), ...doneMap.keys()]);
    const rows = [];
    for(const k of keys){
      const p = planMap.get(k) || {gestor:'', semana:'', dia:'', asignados:0};
      const d = doneMap.get(k) || {realizadas:0, last:null};
      const asign = p.asignados||0, hechas = d.realizadas||0;
      const pct = asign ? (hechas/asign*100) : (hechas?100:0);
      rows.push({
        gestor: p.gestor || d.gestor || '',
        semana: p.semana || d.semana || '',
        dia: p.dia || d.dia || '',
        asignados: asign,
        realizadas: hechas,
        pct: pct,
        last: d.last
      });
    }
    rows.sort((a,b)=> a.gestor.localeCompare(b.gestor,'es',{numeric:true}) ||
                     String(a.semana).localeCompare(String(b.semana),'es',{numeric:true}) ||
                     String(a.dia).localeCompare(String(b.dia),'es',{numeric:true}));

    const tb = document.querySelector('#rrTbl tbody');
    if(tb){
      tb.innerHTML = rows.map(r=>'<tr>'
        +'<td>'+ (r.gestor||'-') +'</td>'
        +'<td>'+ (r.semana||'-') +'</td>'
        +'<td>'+ (r.dia||'-') +'</td>'
        +'<td>'+ r.asignados +'</td>'
        +'<td>'+ r.realizadas +'</td>'
        +'<td>'+ r.pct.toFixed(1) +'%' +'</td>'
        +'<td>'+ (r.last ? new Date(r.last).toLocaleString() : '-') +'</td>'
      +'</tr>').join('');
    }

    try{
      let asign = 0, hechas = 0;
      rows.forEach(r=>{ asign+=r.asignados; hechas+=r.realizadas; });
      const cov = asign ? (hechas/asign*100) : (hechas?100:0);
      const a = document.getElementById('kpiAsignadas'); if(a) a.textContent = String(asign);
      const h = document.getElementById('kpiHechas'); if(h) h.textContent = String(hechas);
      const c = document.getElementById('kpiCobertura'); if(c) c.textContent = cov.toFixed(1)+'%';
    }catch(_){}
  };

  const _oldShow = window.__showResumenScreen;
  window.__showResumenScreen = function(){
    if(typeof _oldShow==='function'){ _oldShow(); }
    try { populateRRFilters(); } catch(_) {}
    try { renderRR(); } catch(_) {}
  };
  ['rrSemana','rrDia','rrVendedor','rrGestor'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('change', function(){ try{ renderRR(); }catch(_){}});
  });
})();
</script>


<script>
(function(){
  // === Config ===
  const CAL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv";

  // === Helpers ===
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function norm(s){ return String(s||'').trim(); }
  function normDia(d){ return String(d||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase(); }
  function csvEscape(v){ if(v==null) return ''; const s=String(v); return (s.includes(',')||s.includes('"')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s; }
  function weekOfMonth(date){ if(!(date instanceof Date)||isNaN(date)) return ''; const w = 1 + Math.floor((date.getDate()-1)/7); return String(Math.min(Math.max(w,1),4)); }

  // CSV minimal parser
  function parseCSV(text){
    const rows=[]; let row=[], cur='', q=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i];
      if(ch=='"'){ if(q && text[i+1]=='"'){ cur+='"'; i++; } else q=!q; }
      else if(ch==',' && !q){ row.push(cur); cur=''; }
      else if((ch=='\n'||ch=='\r') && !q){ if(cur.length||row.length){ row.push(cur); rows.push(row); row=[]; cur=''; } }
      else cur+=ch;
    }
    if(cur.length||row.length){ row.push(cur); rows.push(row); }
    if(!rows.length) return [];
    const head = rows.shift().map(h=>String(h||'').trim());
    return rows.filter(r=>r.some(x=>String(x||'').trim()!=='')).map(r=>{
      const o={}; for(let j=0;j<head.length;j++){ o[head[j]]= r[j]!==undefined ? r[j] : ''; } return o;
    });
  }
  function pick(o, names){
    const ks = Object.keys(o);
    for(const n of names){
      if(n in o && o[n]!=null) return o[n];
      const f = ks.find(k=>k.toLowerCase()===n.toLowerCase());
      if(f) return o[f];
    }
    return '';
  }

  // Load Calendario plan
  let PLAN = []; // {gestor, vendedor, semana, cod?}
  async function loadPlan(){
    try{
      const res = await fetch(CAL_URL, {cache:'no-store', mode:'cors'});
      const txt = await res.text();
      const rows = parseCSV(txt);
      PLAN = rows.map(r=> ({
        gestor: norm(pick(r, ['gestor_servicio','Gestor','gestor'])) || 'NO ASIGNADO',
        vendedor: norm(pick(r, ['vendedor','Vendedor','VENDEDOR'])),
        semana: norm(pick(r, ['SEMANA','Semana','semana'])),
        cod: norm(pick(r, ['Cod Empresa','Cod','C√≥digo','Codigo','cod','ID']))
      })).filter(x=>x.semana);
    }catch(e){
      console.warn('No se pudo cargar Calendario', e);
      PLAN = [];
    }
  }

  // Calls
  function getCalls(){
    let calls = [];
    try{ calls = JSON.parse(localStorage.getItem('llamadas_records') || '[]'); }catch(_){}
    if(window.STATE && Array.isArray(STATE.calls)) calls = calls.concat(STATE.calls);
    return calls.map(c=>{
      const d = new Date(c.fecha_hora || c.fecha || '');
      return {
        gestor: c.gestor_servicio || c.gestor || '',
        vendedor: c.vendedor || c.Vendedor || '',
        semana: c.semana || weekOfMonth(d),
        fecha: d
      };
    });
  }

  // Populate filters
  function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),'es',{numeric:true})); }
  function populateFilters(){
    const vend = uniq(PLAN.map(p=>p.vendedor));
    const gest = uniq(PLAN.map(p=>p.gestor));
    const fvend = $('#rwVendedor'); const fgest = $('#rwGestor');
    fvend.innerHTML = '<option value="">Todos</option>' + vend.map(v=>'<option>'+v+'</option>').join('');
    fgest.innerHTML = '<option value="">Todos</option>' + gest.map(v=>'<option>'+v+'</option>').join('');
  }

  // Render table (aggregate by semana y gestor; NO por d√≠a)
  function render(){
    const fSem = $('#rwSemana').value || '';
    const fVend = $('#rwVendedor').value || '';
    const fGest = $('#rwGestor').value || '';

    const planF = PLAN.filter(x=>{
      if(fSem && String(x.semana)!==String(fSem)) return false;
      if(fVend && x.vendedor!==fVend) return false;
      if(fGest && x.gestor!==fGest) return false;
      return true;
    });

    // Agrupar Plan por (gestor, semana)
    const planMap = new Map(); // key: gestor|semana => count
    planF.forEach(p=>{
      const k = p.gestor+'|'+p.semana;
      planMap.set(k, (planMap.get(k)||0)+1);
    });

    // Realizadas: agrupar por (gestor, semana)
    const calls = getCalls().filter(c=>{
      if(fSem && String(c.semana)!==String(fSem)) return false;
      if(fVend && c.vendedor!==fVend) return false;
      if(fGest && c.gestor!==fGest) return false;
      return true;
    });
    const doneMap = new Map(); const lastMap = new Map();
    calls.forEach(c=>{
      const k = c.gestor+'|'+(c.semana||'');
      doneMap.set(k, (doneMap.get(k)||0)+1);
      const prev = lastMap.get(k);
      if(!prev || prev < c.fecha) lastMap.set(k, c.fecha);
    });

    const keys = new Set([...planMap.keys(), ...doneMap.keys()]);
    const rows = [];
    keys.forEach(k=>{
      const [gestor, semana] = k.split('|');
      const a = planMap.get(k) || 0;
      const r = doneMap.get(k) || 0;
      const pct = a ? (r/a*100) : (r?100:0);
      const last = lastMap.get(k) ? lastMap.get(k).toLocaleString() : '-';
      rows.push({gestor, semana, a, r, pct, last});
    });
    rows.sort((x,y)=> x.gestor.localeCompare(y.gestor,'es',{numeric:true}) || String(x.semana).localeCompare(String(y.semana),'es',{numeric:true}));

    const tb = $('#rwTbl tbody'); tb.innerHTML='';
    const frag = document.createDocumentFragment();
    rows.forEach(row=>{
      const tr = document.createElement('tr');
      function td(t){ const el=document.createElement('td'); el.textContent = t; return el; }
      tr.appendChild(td(row.gestor||'-'));
      tr.appendChild(td(row.semana||'-'));
      tr.appendChild(td(row.a));
      tr.appendChild(td(row.r));
      tr.appendChild(td(row.pct.toFixed(1)+'%'));
      tr.appendChild(td(row.last));
      frag.appendChild(tr);
    });
    tb.appendChild(frag);

    // KPIs
    const totalA = rows.reduce((s,x)=>s+x.a,0);
    const totalR = rows.reduce((s,x)=>s+x.r,0);
    const cov = totalA ? (totalR/totalA*100) : (totalR?100:0);
    $('#rwPlan').textContent = String(totalA);
    $('#rwDone').textContent = String(totalR);
    $('#rwCov').textContent  = cov.toFixed(1)+'%';
    $('#rwInfo').textContent = `Plan: ${planF.length} filas ¬∑ Llamadas: ${calls.length}`;
  }

  // Export CSV
  function exportCSV(){
    const headers = ['Gestor','Semana','A realizar','Realizadas','% Cobertura','√öltima llamada'];
    const rows = $all('#rwTbl tbody tr').map(tr=> Array.from(tr.cells).map(td=> td.textContent));
    const csv = [headers.map(csvEscape).join(',')].concat(rows.map(r=> r.map(csvEscape).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'reporte_resumen_semanal.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  // Screen toggle
  function showResumen(){
    const main = $('#container, #app, main') || document.body;
    const scr = $('#screenResumenSem');
    if(main && scr){ main.style.display='none'; scr.style.display='block'; }
  }
  function backFromResumen(){
    const main = $('#container, #app, main') || document.body;
    const scr = $('#screenResumenSem');
    if(main && scr){ scr.style.display='none'; main.style.display='block'; }
  }

  // Bindings
  document.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.id==='btnOpenResumenSem'){
      ev.preventDefault(); ev.stopPropagation();
      (async ()=>{
        await loadPlan(); populateFilters(); render(); showResumen();
      })();
    }
    if(ev.target && ev.target.id==='rwVolver'){ backFromResumen(); }
    if(ev.target && ev.target.id==='rwExport'){ exportCSV(); }
  });
  document.addEventListener('change', (ev)=>{
    if(ev.target && ['rwSemana','rwVendedor','rwGestor'].includes(ev.target.id)){ render(); }
  });
})();
</script>


<!-- ==== Drill-down Detail + Excel Export (self-contained) ==== -->
<style>
  .dlp-card{background:#fff;border-radius:14px;box-shadow:0 6px 24px rgba(13,38,76,.12);padding:16px;margin:24px 0}
  .dlp-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .dlp-title{font-size:18px;font-weight:700;margin:0 0 10px}
  .dlp-chips{display:flex;gap:10px;margin:6px 0 14px;flex-wrap:wrap}
  .dlp-chip{background:#f1f5f9;border-radius:999px;padding:6px 10px;font-size:12px}
  .dlp-tabs{display:flex;gap:6px;margin:8px 0 12px}
  .dlp-tab{padding:8px 12px;border-radius:10px;border:1px solid #e2e8f0;background:#fff;cursor:pointer}
  .dlp-tab.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  .dlp-actions{margin-left:auto;display:flex;gap:8px}
  .dlp-btn{padding:8px 12px;border:1px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer}
  .dlp-table{width:100%;border-collapse:collapse;margin-top:8px}
  .dlp-table th,.dlp-table td{border-bottom:1px solid #e5e7eb;padding:8px 10px;font-size:13px;text-align:left}
  .dlp-muted{opacity:.7}
  @media (prefers-color-scheme: dark){
    .dlp-card{background:#111827;color:#e5e7eb;border:1px solid #1f2937}
    .dlp-chip{background:#1f2937}
    .dlp-tab{background:#111827;border-color:#1f2937;color:#e5e7eb}
    .dlp-btn{background:#111827;border-color:#1f2937;color:#e5e7eb}
    .dlp-table th,.dlp-table td{border-color:#1f2937}
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
(function(){
  const AGENDA_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv";

  const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
  const T = (el)=> (el && (el.textContent||'').trim()) || "";
  const norm = s => (s||"").toString().trim().toLowerCase();

  let agendaRows = null; // parsed CSV
  let state = { semana: "Todas", vendedor:"Todos", gestor:"Todos", selected:{gestor:null, semana:null} };
  let elements = { panel:null, tabs:null, table:null, chips:null };

  function findKPI(){
    // locate the KPI upper card by heading Resumen (Semanal)
    for(const h of $$('h1,h2,h3,h4')){
      const t = T(h).toLowerCase();
      if(t.includes('resumen') && t.includes('semanal')){
        const card = h.closest('section,.card,div');
        if(card){
          // find 3 selects near
          const selects = $$('select', card);
          let map = {};
          selects.forEach(sel=>{
            const l = sel.closest('label,div')?.querySelector('label');
            const guess = l ? T(l).toLowerCase() : "";
            if(guess.includes('semana')) map.semana = sel;
            else if(guess.includes('vendedor')) map.vendedor = sel;
            else if(guess.includes('gestor')) map.gestor = sel;
          });
          // fallback: first 3 selects
          if(!map.semana && selects[0]) map.semana = selects[0];
          if(!map.vendedor && selects[1]) map.vendedor = selects[1];
          if(!map.gestor && selects[2]) map.gestor = selects[2];
          return {card, filters:map, table: card.querySelector('table')};
        }
      }
    }
    return null;
  }

  function readFilters(kpi){
    const get = sel => sel ? sel.value : "Todos";
    state.semana = get(kpi.filters.semana) || "Todas";
    state.vendedor = get(kpi.filters.vendedor) || "Todos";
    state.gestor   = get(kpi.filters.gestor)   || "Todos";
  }

  function injectPanel(afterNode){
    if(elements.panel) return;
    const wrap = document.createElement('section');
    wrap.className = 'dlp-card';
    wrap.innerHTML = `
      <div class="dlp-row">
        <h3 class="dlp-title">Detalle de llamadas ‚Äî Clientes</h3>
        <div class="dlp-actions"><button class="dlp-btn btn-soft" id="dlpToggle">Ocultar</button>
          <button class="dlp-btn" id="dlpExportActive">Exportar Excel</button>
          <button class="dlp-btn" id="dlpExportBoth">Exportar Excel ‚Äî Todo</button>
        
      </div>
      <div id="dlpCalWrap" style="display:none; margin-top:10px;">
        <div class="kanban">
          <div class="kcol"><h4>LUNES</h4><div id="dlpCalCol-LUNES"></div></div>
          <div class="kcol"><h4>MARTES</h4><div id="dlpCalCol-MARTES"></div></div>
          <div class="kcol"><h4>MIERCOLES</h4><div id="dlpCalCol-MIERCOLES"></div></div>
          <div class="kcol"><h4>JUEVES</h4><div id="dlpCalCol-JUEVES"></div></div>
          <div class="kcol"><h4>VIERNES</h4><div id="dlpCalCol-VIERNES"></div></div>
          <div class="kcol"><h4>SABADO</h4><div id="dlpCalCol-SABADO"></div></div>
          <div class="kcol"><h4>DOMINGO</h4><div id="dlpCalCol-DOMINGO"></div></div>
        </div>
      </div>
      
      </div>
      <div id="dlpCalWrap" style="display:none; margin-top:10px;">
        <div class="kanban">
          <div class="kcol"><h4>LUNES</h4><div id="dlpCalCol-LUNES"></div></div>
          <div class="kcol"><h4>MARTES</h4><div id="dlpCalCol-MARTES"></div></div>
          <div class="kcol"><h4>MIERCOLES</h4><div id="dlpCalCol-MIERCOLES"></div></div>
          <div class="kcol"><h4>JUEVES</h4><div id="dlpCalCol-JUEVES"></div></div>
          <div class="kcol"><h4>VIERNES</h4><div id="dlpCalCol-VIERNES"></div></div>
          <div class="kcol"><h4>SABADO</h4><div id="dlpCalCol-SABADO"></div></div>
          <div class="kcol"><h4>DOMINGO</h4><div id="dlpCalCol-DOMINGO"></div></div>
        </div>
      </div>
      <div class="dlp-chips" id="dlpChips">
      </div>
      <div id="dlpCalWrap" style="display:none; margin-top:10px;">
        <div class="kanban">
          <div class="kcol"><h4>LUNES</h4><div id="dlpCalCol-LUNES"></div></div>
          <div class="kcol"><h4>MARTES</h4><div id="dlpCalCol-MARTES"></div></div>
          <div class="kcol"><h4>MIERCOLES</h4><div id="dlpCalCol-MIERCOLES"></div></div>
          <div class="kcol"><h4>JUEVES</h4><div id="dlpCalCol-JUEVES"></div></div>
          <div class="kcol"><h4>VIERNES</h4><div id="dlpCalCol-VIERNES"></div></div>
          <div class="kcol"><h4>SABADO</h4><div id="dlpCalCol-SABADO"></div></div>
          <div class="kcol"><h4>DOMINGO</h4><div id="dlpCalCol-DOMINGO"></div></div>
        </div>
      </div>
      <div class="dlp-tabs">
        <button class="dlp-tab active" data-tab="pend">Pendientes (Agenda)</button>
        <button class="dlp-tab" data-tab="real">Realizadas (Historial)</button>
        <button class="dlp-tab" data-tab="cal">Agenda (Calendario)</button>
      
      </div>
      <div id="dlpCalWrap" style="display:none; margin-top:10px;">
        <div class="kanban">
          <div class="kcol"><h4>LUNES</h4><div id="dlpCalCol-LUNES"></div></div>
          <div class="kcol"><h4>MARTES</h4><div id="dlpCalCol-MARTES"></div></div>
          <div class="kcol"><h4>MIERCOLES</h4><div id="dlpCalCol-MIERCOLES"></div></div>
          <div class="kcol"><h4>JUEVES</h4><div id="dlpCalCol-JUEVES"></div></div>
          <div class="kcol"><h4>VIERNES</h4><div id="dlpCalCol-VIERNES"></div></div>
          <div class="kcol"><h4>SABADO</h4><div id="dlpCalCol-SABADO"></div></div>
          <div class="kcol"><h4>DOMINGO</h4><div id="dlpCalCol-DOMINGO"></div></div>
        </div>
      </div>
      <div id="dlpTableWrap">
        <table class="dlp-table" id="dlpTable"><thead></thead><tbody></tbody></table>
        <div class="dlp-muted" id="dlpEmpty" style="display:none; padding:10px 0">Sin datos para los filtros seleccionados.
      </div>
      <div id="dlpCalWrap" style="display:none; margin-top:10px;">
        <div class="kanban">
          <div class="kcol"><h4>LUNES</h4><div id="dlpCalCol-LUNES"></div></div>
          <div class="kcol"><h4>MARTES</h4><div id="dlpCalCol-MARTES"></div></div>
          <div class="kcol"><h4>MIERCOLES</h4><div id="dlpCalCol-MIERCOLES"></div></div>
          <div class="kcol"><h4>JUEVES</h4><div id="dlpCalCol-JUEVES"></div></div>
          <div class="kcol"><h4>VIERNES</h4><div id="dlpCalCol-VIERNES"></div></div>
          <div class="kcol"><h4>SABADO</h4><div id="dlpCalCol-SABADO"></div></div>
          <div class="kcol"><h4>DOMINGO</h4><div id="dlpCalCol-DOMINGO"></div></div>
        </div>
      </div>
      
      </div>
      <div id="dlpCalWrap" style="display:none; margin-top:10px;">
        <div class="kanban">
          <div class="kcol"><h4>LUNES</h4><div id="dlpCalCol-LUNES"></div></div>
          <div class="kcol"><h4>MARTES</h4><div id="dlpCalCol-MARTES"></div></div>
          <div class="kcol"><h4>MIERCOLES</h4><div id="dlpCalCol-MIERCOLES"></div></div>
          <div class="kcol"><h4>JUEVES</h4><div id="dlpCalCol-JUEVES"></div></div>
          <div class="kcol"><h4>VIERNES</h4><div id="dlpCalCol-VIERNES"></div></div>
          <div class="kcol"><h4>SABADO</h4><div id="dlpCalCol-SABADO"></div></div>
          <div class="kcol"><h4>DOMINGO</h4><div id="dlpCalCol-DOMINGO"></div></div>
        </div>
      </div>
    `;
    afterNode.parentNode.insertBefore(wrap, afterNode.nextSibling);
    elements.panel = wrap;
    elements.table = wrap.querySelector('#dlpTable');
    elements.chips = wrap.querySelector('#dlpChips');
    elements.tabs = wrap.querySelectorAll('.dlp-tab');
    elements.btnActive = wrap.querySelector('#dlpExportActive');
    elements.btnBoth = wrap.querySelector('#dlpExportBoth');

    elements.tabs.forEach(btn=>btn.addEventListener('click', ()=>{
      elements.tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      render();
    }));
    elements.btnActive.addEventListener('click', ()=> exportExcel({both:false}));
    elements.btnBoth.addEventListener('click', ()=> exportExcel({both:true}));
  }

  async function ensureAgenda(){
    if(agendaRows) return;
    try{
      const res = await fetch(AGENDA_CSV, {cache:'no-store'});
      const csv = await res.text();
      const parsed = Papa.parse(csv, {header:true, skipEmptyLines:true});
      agendaRows = parsed.data;
    }catch(e){
      console.error('Error cargando Agenda CSV', e);
      agendaRows = [];
    }
  }

  function filtersSummary(extra={}){
    const chips = [];
    const s = state.semana; const v= state.vendedor; const g= state.gestor;
    chips.push(`Semana: <b>${s}</b>`);
    chips.push(`Vendedor: <b>${v}</b>`);
    chips.push(`Gestor: <b>${g}</b>`);
    if(extra.gestor && extra.semana){
      chips.push(`Foco KPI ‚Üí Gestor: <b>${extra.gestor}</b>, Semana: <b>${extra.semana}</b>`);
    }
    elements.chips.innerHTML = chips.map(c=>`<span class="dlp-chip">${c}</span>`).join('');
  }

  function getActiveTab(){ return elements.panel.querySelector('.dlp-tab.active')?.dataset.tab || 'pend'; }

  function weekMatches(val){
    if(!state.semana || state.semana==='Todas') return true;
    const vv = (val||'').toString().trim();
    return vv === state.semana || vv.padStart(1,'') === state.semana;
  }
  function eqOrAll(filterVal, value){
    if(!filterVal || /todos|todas/i.test(filterVal)) return true;
    return norm(filterVal) === norm(value);
  }

  function buildPendientes(){
    const rows = (agendaRows||[]).filter(r=>
      weekMatches(r['SEMANA']||r['Semana']||r['semana']) &&
      eqOrAll(state.vendedor, r['vendedor']) &&
      eqOrAll(state.gestor, r['gestor_servicio']||r['gestor'])
    );
    const map = new Map();
    rows.forEach(r=>{
      const cod = r['Cod Empresa'] || r['cod'] || r['Cod'] || '';
      const cli = r['RazonSocial'] || r['cliente'] || '';
      const key = cod+'|'+cli;
      if(!map.has(key)){
        map.set(key, { 'Cod Empresa':cod, 'Cliente':cli, 'Semana': r['SEMANA']||r['Semana']||r['semana'],
                       'D√≠a': r['DIA']||r['Dia']||r['d√≠a']||'', 'Vendedor': r['vendedor']||'',
                       'Gestor': r['gestor_servicio']||r['gestor']||'', 'A realizar':0 });
      }
      map.get(key)['A realizar'] += 1;
    });
    return Array.from(map.values());
  }

  function findCallsTable(){
    for(const t of $$('table')){
      const hs = $$('thead th', t).map(th=>T(th).toLowerCase());
      if(hs.includes('cliente') && (hs.includes('vendedor')||hs.includes('gestor')) && hs.some(h=>h.includes('fecha'))){
        return t;
      }
    }
    return null;
  }

  function buildRealizadas(){
    const tbl = findCallsTable();
    if(!tbl) return [];
    const hs = $$('thead th', tbl).map(th=>T(th));
    const body = $$('tbody tr', tbl);
    const idx = (name)=>{
      const i = hs.findIndex(h=> (h||'').toLowerCase().includes(name) );
      return i>=0 ? i : -1;
    };
    const icli=idx('cliente'), iven=idx('vendedor'), iges=idx('gestor');
    const ifecha = hs.findIndex(h=>/fecha|hora/i.test(h));
    const map = new Map();
    body.forEach(tr=>{
      const tds = $$('td', tr).map(td=>T(td));
      const cliente = icli>=0? tds[icli] : '';
      const vendedor = iven>=0? tds[iven] : '';
      const gestor = iges>=0? tds[iges] : '';
      const fecha = ifecha>=0? tds[ifecha] : '';
      if(!eqOrAll(state.vendedor, vendedor)) return;
      if(!eqOrAll(state.gestor, gestor)) return;
      const k = cliente+'|'+vendedor+'|'+gestor;
      if(!map.has(k)) map.set(k, { 'Cliente': cliente, 'Vendedor': vendedor, 'Gestor': gestor, 'Realizadas': 0, '√öltima llamada': ''});
      const o = map.get(k);
      o['Realizadas'] += 1;
      if(fecha){
        if(!o['√öltima llamada'] || fecha > o['√öltima llamada']) o['√öltima llamada'] = fecha;
      }
    });
    return Array.from(map.values());
  }

  function setTable(headers, rows){
    const thead = elements.table.querySelector('thead');
    const tbody = elements.table.querySelector('tbody');
    thead.innerHTML = '<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
    if(!rows.length){
      tbody.innerHTML = '';
      elements.panel.querySelector('#dlpEmpty').style.display = 'block';
    }else{
      elements.panel.querySelector('#dlpEmpty').style.display = 'none';
      tbody.innerHTML = rows.map(r=>'<tr>'+headers.map(h=>`<td>${r[h] ?? ''}</td>`).join('')+'</tr>').join('');
    }
  }

  function render(){
    const tab = getActiveTab();
    const wrapTbl = elements.panel.querySelector('#dlpTableWrap');
    const wrapCal = elements.panel.querySelector('#dlpCalWrap');
    if(wrapTbl) wrapTbl.style.display = (tab==='cal') ? 'none' : '';
    if(wrapCal) wrapCal.style.display = (tab==='cal') ? '' : 'none';
    filtersSummary(state.selected);
    if(tab==='pend'){
      ensureAgenda().then(()=>{
        const data = buildPendientes();
        const headers = ['Cod Empresa','Cliente','Semana','D√≠a','Vendedor','Gestor','A realizar'];
        setTable(headers, data);
        elements.btnActive.dataset.sheet = 'Pendientes';
        elements.btnActive.dataset.payload = JSON.stringify(data);
      });

    }else if(tab==='cal'){
      // Build calendar from Google Sheet 'Calendario'
      const cols = ['LUNES','MARTES','MIERCOLES','JUEVES','VIERNES','SABADO','DOMINGO'];
      const normDia = s => String(s||'').toUpperCase()
        .replace(/[√Å√Ä√Ñ√Ç]/g,'A').replace(/[√â√à√ã√ä]/g,'E').replace(/[√ç√å√è√é]/g,'I')
        .replace(/[√ì√í√ñ√î]/g,'O').replace(/[√ö√ô√ú√õ]/g,'U');
      try{
        // Clear columns
        cols.forEach(c=>{ const el = elements.panel.querySelector('#dlpCalCol-'+c); if(el) el.innerHTML=''; });
        const S = (STATE && STATE.calendario) ? STATE.calendario : [];
        const rows = S.filter(r=>{
          return weekMatches(r['SEMANA']||r['Semana']||r['semana']) &&
                 eqOrAll(state.vendedor, r['vendedor']) &&
                 eqOrAll(state.gestor, r['gestor_servicio']||r['gestor']);
        });
        const flat = [];
        rows.forEach(r=>{
          const dia = normDia(r['DIA']||r['Dia']||r['d√≠a']||'LUNES');
          const cod = r['Cod Empresa']||r['cod_empresa']||r['COD_EMPRESA']||r['codigo']||r['Cod']||'';
          const cli = r['RazonSocial']||r['Cliente']||r['cliente']||'';
          const vend = r['vendedor']||'';
          const ges  = r['gestor_servicio']||r['gestor']||'';
          const sema = r['SEMANA']||r['Semana']||r['semana']||'';
          const col = elements.panel.querySelector('#dlpCalCol-'+(cols.includes(dia)?dia:'LUNES'));
          const card = document.createElement('div'); card.className='kcard';
          const _cc = (window.getRealizadasSet ? window.getRealizadasSet() : (window._REALIZADAS_CLIENTES||new Set()));
          const _status = _cc.has((cli||'').toLowerCase()) ? 'ok' : 'miss';
          card.innerHTML = '<div class="khead"><span class="cal-dot '+_status+'"></span>'+(cli||'')+'</div>' +
                           '<div class="kmeta">'+(cod||'')+' ‚Ä¢ '+vend+' ‚Ä¢ '+ges+'</div>' +
                           '<div class="muted" style="margin-top:6px;">Semana '+sema+' ‚Äî '+dia+'</div>';
          if(col) col.appendChild(card);
          flat.push({'Cod Empresa':cod,'Cliente':cli,'Semana':sema,'D√≠a':dia,'Vendedor':vend,'Gestor':ges});
        });
        // For export
        elements.btnActive.dataset.sheet = 'Calendario';
        elements.btnActive.dataset.payload = JSON.stringify(flat);
      }catch(err){ console.error('cal render', err); }
    }else{

      const data = buildRealizadas();
      try { window._REALIZADAS_CLIENTES = new Set(data.map(o => (o['Cliente']||'').toString().trim().toLowerCase())); document.dispatchEvent(new CustomEvent('realizadas:update',{detail:{count:window._REALIZADAS_CLIENTES.size}})); } catch (e) { window._REALIZADAS_CLIENTES = new Set(); }
      const headers = ['Cliente','Vendedor','Gestor','Realizadas','√öltima llamada'];
      setTable(headers, data);
      elements.btnActive.dataset.sheet = 'Realizadas';
      elements.btnActive.dataset.payload = JSON.stringify(data);
    }
  }

  function exportExcel({both=false}={}){
    const wb = XLSX.utils.book_new();
    const addSheet = (name, arr)=>{
      const ws = XLSX.utils.json_to_sheet(arr);
      XLSX.utils.book_append_sheet(wb, ws, name);
    };
    if(both){
      const pendBtn = elements.panel.querySelector('.dlp-tab[data-tab="pend"]');
      const realBtn = elements.panel.querySelector('.dlp-tab[data-tab="real"]');
      const current = getActiveTab();
      pendBtn.classList.add('active'); realBtn.classList.remove('active'); render();
      const pendData = JSON.parse(elements.btnActive.dataset.payload||'[]');
      pendBtn.classList.remove('active'); realBtn.classList.add('active'); render();
      const realData = JSON.parse(elements.btnActive.dataset.payload||'[]');
      if(current==='pend'){ pendBtn.classList.add('active'); realBtn.classList.remove('active'); } else { pendBtn.classList.remove('active'); realBtn.classList.add('active'); }
      render();
      addSheet('Pendientes', pendData);
      addSheet('Realizadas', realData);
    }else{
      const sheet = elements.btnActive.dataset.sheet || 'Datos';
      const data = JSON.parse(elements.btnActive.dataset.payload||'[]');
      addSheet(sheet, data);
    }
    const parts = [];
    if(state.semana && !/todas/i.test(state.semana)) parts.push('Sem'+state.semana);
    if(state.vendedor && !/todos/i.test(state.vendedor)) parts.push('Ven_'+state.vendedor);
    if(state.gestor && !/todos/i.test(state.gestor)) parts.push('Ges_'+state.gestor);
    const fname = 'Llamadas_'+(parts.join('_')||'Resumen')+'.xlsx';
    XLSX.writeFile(wb, fname);
  }

  function attachRowClick(kpi){
    const tbody = kpi.table ? kpi.table.querySelector('tbody') : null;
    if(!tbody) return;
    tbody.addEventListener('click', (ev)=>{
      const tr = ev.target.closest('tr'); if(!tr) return;
      const tds = Array.from(tr.querySelectorAll('td')).map(td=> (td.textContent||'').trim() );
      const heads = Array.from(kpi.table.querySelectorAll('thead th')).map(th=> (th.textContent||'').trim().toLowerCase());
      const idxGestor = heads.findIndex(h=>h.includes('gestor'));
      const idxSem = heads.findIndex(h=>h.includes('semana'));
      const gestor = idxGestor>=0 ? tds[idxGestor] : null;
      const semana = idxSem>=0 ? tds[idxSem] : null;
      if(gestor || semana){
        state.selected = {gestor, semana};
        if(gestor && kpi.filters.gestor){ kpi.filters.gestor.value = gestor; }
        if(semana && kpi.filters.semana){ kpi.filters.semana.value = semana; }
        readFilters(kpi);
        render();
      }
    });
  }

  function hideFloatingOnLogin(){
    const pwd = document.querySelector('input[type="password"]');
    const visible = pwd && pwd.offsetParent !== null;
    Array.from(document.querySelectorAll('button,a,[role="button"]')).forEach(el=>{
      const t = (el.textContent||'').trim().toLowerCase();
      if(/resumen\s*\(sem\)/.test(t)){
        el.style.display = visible ? 'none' : '';
      }
    });
  }

  function onReady(){
    const kpi = findKPI();
    if(!kpi) return;
    readFilters(kpi);
    injectPanel(kpi.card);
    render();
    Object.values(kpi.filters).forEach(sel=> sel && sel.addEventListener('change', ()=>{ readFilters(kpi); render(); }));
    attachRowClick(kpi);
    hideFloatingOnLogin();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', onReady);
  } else { onReady(); }

  new MutationObserver(()=>hideFloatingOnLogin()).observe(document.documentElement, {subtree:true, childList:true});
})();
</script>


<script>
// === Universal VOLVER -> home + reset (safe, unobtrusive) ===
(function(){
  function resetMainFilters(){
    var ids = ['fSemana','fDia','fVendedor','fGestor','fEmpresa','fBuscar','fCliente'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(!el) return;
      if (el.tagName === 'SELECT') el.value = '';
      else if (el.tagName === 'INPUT') el.value = '';
    });
    try{
      if (typeof applyFilters === 'function') applyFilters();
      if (typeof updateButtonsState === 'function') updateButtonsState();
    }catch(e){}
  }
  function resetResumenFilters(){
    ['rwSemana','rwVendedor','rwGestor'].forEach(function(id){
      var el = document.getElementById(id);
      if(!el) return;
      if (el.tagName === 'SELECT') el.value = '';
      else if (el.tagName === 'INPUT') el.value = '';
    });
  }
  function closeAllModals(){
    ['modalReporte','modalAgenda','modalAgReporte','modalLlamada','modalConfig'].forEach(function(id){
      var el = document.getElementById(id);
      if (el) { el.classList.add('hidden'); el.style.display = ''; }
    });
    document.body.classList.remove('no-scroll');
  }
  function showMain(){
    var app = document.getElementById('app');
    var login = document.getElementById('login');
    var resumen = document.getElementById('screenResumenSem');
    if (resumen) resumen.style.display = 'none';
    if (login) login.classList.add('hidden');
    if (app) { app.classList.remove('hidden'); app.style.display = 'block'; }
    try { window.scrollTo({top:0, behavior:'auto'}); } catch(_){}
  }
  function goHomeAndReset(ev){
    if (ev) ev.preventDefault();
    try{
      resetResumenFilters();
      resetMainFilters();
      closeAllModals();
      showMain();
    }catch(e){}
  }
  window.goHomeAndReset = goHomeAndReset;

  function hookVolverButtons(){
    var nodes = Array.from(document.querySelectorAll('button, a'));
    nodes.forEach(function(btn){
      var txt = (btn.textContent || '').trim().toLowerCase();
      if (txt === '‚Üê volver' || txt === 'volver') {
        btn.onclick = goHomeAndReset;
      }
    });
    ['rwVolver','rrVolver'].forEach(function(id){
      var b = document.getElementById(id);
      if (b) b.onclick = goHomeAndReset;
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', hookVolverButtons);
  } else {
    hookVolverButtons();
  }
  var mo = new MutationObserver(hookVolverButtons);
  mo.observe(document.documentElement || document.body, {childList:true, subtree:true});
})();
// === End patch ===
</script>


<!-- === Safe patch: Screen Manager + Delegated Events (no ID removals) === -->
<script>
(function(){
  // Avoid polluting global scope; do not override existing functions.
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const $ = (sel, root=document) => root.querySelector(sel);

  // Basic screen manager that coexists with existing code
  const SCREENS = ["login","app","screenResumenSem"];
  const navStack = [];

  function hideAll(){
    SCREENS.forEach(id => {
      const el = document.getElementById(id) || document.querySelector("#"+id);
      if(!el) return;
      // Some are <section>, some may be other elements; respect current "hidden" strategy
      if(id === "app"){
        // app usa clase 'hidden'; si existe, usarla
        el.classList && el.classList.add("hidden");
      }
      // Para login y screenResumenSem, usan style.display
      el.style && (el.style.display = (id==="login" ? "" : "none"));
    });
  }

  function show(id){
    // No rompas si el elemento no existe
    const el = document.getElementById(id) || document.querySelector("#"+id);
    if(!el) return;
    if(id==="app"){
      el.classList && el.classList.remove("hidden");
    } else {
      el.style && (el.style.display = "");
    }
  }

  function currentScreen(){
    // heur√≠stica simple
    if(document.getElementById("app") && !document.getElementById("app").classList.contains("hidden")) return "app";
    if(document.getElementById("screenResumenSem") && document.getElementById("screenResumenSem").style.display !== "none") return "screenResumenSem";
    return "login";
  }

  function showScreen(id){
    const cur = currentScreen();
    if(cur !== id){ navStack.push(cur); }
    // resetea y muestra
    // Cuidado: login <section id="login"> est√° visible por defecto.
    //           app usa clase hidden; resumenSem usa display:none.
    // Ocultar todo sin cambiar IDs ni estructura
    // Primero ocultar
    if (document.getElementById("login")) document.getElementById("login").style.display = "none";
    if (document.getElementById("app")) document.getElementById("app").classList.add("hidden");
    if (document.getElementById("screenResumenSem")) document.getElementById("screenResumenSem").style.display = "none";

    // Luego mostrar la solicitada
    if(id==="login"){
      const lg = document.getElementById("login");
      if(lg) lg.style.display = "";
    } else if(id==="app"){
      const ap = document.getElementById("app");
      if(ap) ap.classList.remove("hidden");
    } else if(id==="screenResumenSem"){
      const rs = document.getElementById("screenResumenSem");
      if(rs) rs.style.display = "";
    }
  }

  function goBack(){
    const prev = navStack.pop();
    if(prev){ showScreen(prev); }
    else { showScreen("app"); } // fallback
  }

  // Expose minimal API for other inline handlers (without colliding if already present)
  window.__nav = window.__nav || { showScreen, goBack };

  document.addEventListener("DOMContentLoaded", function(){
    // 1) Delegar clicks para todos los elementos con ID duplicado #btnReporteResumen
    document.addEventListener("click", function(ev){
      const btn = ev.target.closest("#btnReporteResumen");
      if(btn){
        ev.preventDefault();
        // Siempre abre el Resumen (Sem); el KPI/tabla se calcula por la l√≥gica existente
        showScreen("screenResumenSem");
        return;
      }
      const volver = ev.target.closest("#rwVolver");
      if(volver){
        ev.preventDefault();
        goBack();
        return;
      }
      const toggleFiltros = ev.target.closest("#btnToggleFiltros");
      if(toggleFiltros){
        ev.preventDefault();
        const panel = document.getElementById("panelFiltros");
        if(panel){
          const isHidden = panel.classList.contains("hidden");
          panel.classList.toggle("hidden");
          // Si se oculta, permitir que lo de abajo se vea completo
          if(!isHidden){
            // Hacemos scroll para asegurar visibilidad de contenido inferior
            setTimeout(()=>{
              window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
            }, 80);
          }
        }
        return;
      }
    }, true);

    // 2) En el arranque, aseguramos que solo Login se vea (si el archivo original lo hace, respetamos)
    //    No forzamos si el autor ya inici√≥ 'app' visible. Simple heur√≠stica:
    try {
      const appVisible = document.getElementById("app") && !document.getElementById("app").classList.contains("hidden");
      const rsVisible = document.getElementById("screenResumenSem") && document.getElementById("screenResumenSem").style.display !== "none";
      const lg = document.getElementById("login");
      if(lg && !appVisible && !rsVisible){
        // Mantener login visible por defecto
        lg.style.display = "";
      }
    } catch(e){ /* no-op */ }
  });
})();
</script>

<script id="safe-resumen-overlay">
(function(){
  function openResumen(){ document.body.classList.add('show-resumen'); }
  function closeResumen(){ document.body.classList.remove('show-resumen'); }
  // Hook into existing buttons
  document.addEventListener('click', function(ev){
    const a = ev.target.closest('#btnReporteResumen');
    if(a){ openResumen(); }
    const b = ev.target.closest('#rwVolver');
    if(b){ closeResumen(); }
  }, true);
  // Ensure no leftover overlay on load/navigation
  document.addEventListener('DOMContentLoaded', function(){ document.body.classList.remove('show-resumen'); });
  // Expose for other scripts if needed
  window.__resumen = window.__resumen || { open: openResumen, close: closeResumen };
})();
</script>


<script id="safe-resumen-kpi">
(function(){
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const $ = (s,root=document)=>root.querySelector(s);
  function val(id){ const el=document.getElementById(id); return el?el.value:''; }
  function uniqueSorted(arr){
    return Array.from(new Set(arr.filter(x=>x!=null && x!=='')))
      .sort((a,b)=>{
        const na=Number(a), nb=Number(b);
        if(isFinite(na)&&isFinite(nb)) return na-nb;
        return String(a).localeCompare(String(b),'es',{numeric:true});
      });
  }
  function normName(s){ return (s||'').toString().normalize('NFD').replace(/\u0300-\u036f/g,'').trim().toLowerCase(); }
  function get(obj, keys){
    for(const k of keys){ if(obj && obj[k]!=null && obj[k] !== '') return obj[k]; }
    const flat={}; for(const k in obj){ flat[k.toLowerCase().replace(/\s|_/g,'')]=obj[k]; }
    for(const k of keys){ const nk=k.toLowerCase().replace(/\s|_/g,''); if(flat[nk]!=null && flat[nk] !== '') return flat[nk]; }
    return '';
  }
  function toDate(x){
    if(!x) return null;
    try {
      if(x instanceof Date) return x;
      const s=String(x).trim();
      const d = new Date(s);
      if(!isNaN(d.getTime())) return d;
      const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
      if(m){
        const dd=+m[1], mm=+m[2]-1, yy=+m[3] < 100 ? 2000+(+m[3]) : +m[3];
        const hh= m[4]? +m[4] : 0, mi= m[5]? +m[5] : 0;
        return new Date(yy,mm,dd,hh,mi);
      }
    } catch(e){}
    return null;
  }
  function weekOfMonth(date){
    if(!(date instanceof Date)) return '';
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
    const day = date.getDate();
    return Math.ceil( (day + (firstDay===0?6:firstDay-1)) / 7 );
  }

  const STATE = window.STATE || (window.__STATE || {});
  const isVendorExcluded = window.isVendorExcluded || function(){ return false; };

  function fillSelect(id, values, first){
    const el = document.getElementById(id);
    if(!el) return;
    const opts = [`<option value="">${first}</option>`].concat(values.map(v=>`<option value="${String(v)}">${String(v)}</option>`));
    el.innerHTML = opts.join('');
  }

  function getCallWeek(rec){
    const s = get(rec, ['Semana','N Semana','N¬∞ Semana','N_Semana','semana']);
    if(s) return String(s).trim();
    const fh = get(rec, ['Fecha/Hora','FechaHora','fecha','Fecha','fecha_hora']);
    const d = toDate(fh);
    if(d) return String(Math.min(4, Math.max(1, weekOfMonth(d))));
    return '';
  }
  function getCallVend(rec){ return get(rec, ['Vendedor','vendedor']); }
  function getCallGestor(rec){ return get(rec, ['gestor_servicio','Gestor','gestor','gestor_cartera','Gestor cartera','gcartera']); }
  function getCallFecha(rec){ return toDate(get(rec, ['Fecha/Hora','Fecha','fecha','FechaHora','fecha_hora'])); }

  function buildResumenFilters(){
    const cal = Array.isArray(STATE.calendario)? STATE.calendario : [];
    if(cal.length){
      const get = (r,klist)=>{ for(const k of klist){ if(r[k]!=null && r[k]!=='' ) return r[k]; } const m={}; for(const k in r){ m[k.toLowerCase().replace(/\s|_/g,'')]=r[k]; } for(const k of klist){ const nk=k.toLowerCase().replace(/\s|_/g,''); if(m[nk]!=null && m[nk]!=='' ) return m[nk]; } return ''; };
      const weeks = cal.map(r=> String(get(r,['SEMANA','Semana','semana'])||'').trim()).filter(Boolean);
      const semanas = uniqueSorted(weeks.map(w=>{ const n=Number(String(w).replace(/[^0-9]/g,'')); return (isFinite(n)&&n>=1) ? (n<=4? String(n): String(((n-1)%4)+1)) : String(w); }));
      const vendedores = uniqueSorted(cal.map(r=> get(r,['vendedor','Vendedor','VENDEDOR']) ).filter(v=>!isVendorExcluded(v)));
      const gestores   = uniqueSorted(cal.map(r=> get(r,['gestor_servicio','Gestor','GESTOR_SERVICIO']) ));
      fillSelect('rwSemana', semanas.length? semanas : ['1','2','3','4'], 'Todas');
      fillSelect('rwVendedor', vendedores, 'Todos');
      fillSelect('rwGestor', gestores, 'Todos');
      return true;
    }
    // fallback a joined/UI (por si el calendario a√∫n no carg√≥)
    if(Array.isArray(STATE.joined) && STATE.joined.length){
      const semanas = uniqueSorted(STATE.joined.map(x=> String(x.semana||'').trim()).filter(Boolean));
      const vendedores = uniqueSorted(STATE.joined.map(x=> x.vendedor).filter(v=>!isVendorExcluded(v)));
      const gestores = uniqueSorted(STATE.joined.map(x=> x.gestor));
      fillSelect('rwSemana', semanas.length? semanas : ['1','2','3','4'], 'Todas');
      fillSelect('rwVendedor', vendedores, 'Todos');
      fillSelect('rwGestor', gestores, 'Todos');
      return true;
    }
    return false;
  }

  function renderResumen(){
    function mapPlanWeek(w){
      // Si la semana ya es 1..4, usarla tal cual. Si viene como 5+ (p.ej. 32), mapear a 1..4.
      const n = Number(String(w||"").replace(/[^0-9]/g,""));
      if(Number.isFinite(n) && n>=1){ return n<=4 ? String(n) : String(((n-1)%4)+1); }
      // Casos "Por asignar" u otros: quedar√°n en blanco y luego se completan como 1..4 por defecto
      return "";
    }
    function ensureFourWeeks(groups){
      // Construye filas faltantes (semanas 1..4) para cada gestor detectado en plan o done
      const gestores = new Set();
      groups.forEach(g=>gestores.add(g.gestor||""));
      const arr = Array.from(groups.values ? groups.values() : groups);
      arr.forEach(g=>gestores.add(g.gestor||""));
      const out = new Map();
      const key = (ges,sem)=> (ges||"")+"__"+String(sem);
      gestores.forEach(ges=>{
        [1,2,3,4].forEach(sem=>{
          const k = key(ges, sem);
          if(!out.has(k)) out.set(k,{gestor:ges||"", semana:String(sem), plan:0, done:0, last:null});
        });
      });
      // Mezclar lo que ya tenemos sobre esta base 1..4
      (groups instanceof Map ? Array.from(groups.values()) : groups).forEach(g=>{
        const k = key(g.gestor||"", g.semana);
        if(!out.has(k)) out.set(k,{gestor:g.gestor||"", semana:String(g.semana||""), plan:0, done:0, last:null});
        const tgt = out.get(k);
        tgt.plan += g.plan||0; tgt.done += g.done||0; if(g.last && (!tgt.last || g.last>tgt.last)) tgt.last=g.last;
      });
      return out;
    }


    function renderBreakdown(groups){
      const host=document.getElementById("rwBreakdown");
      if(!host) return;
      host.innerHTML="";
      // Agrupar por gestor y listar semanas
      const byGestor=new Map();
      groups.forEach(g=>{
        const key=g.gestor||"-";
        if(!byGestor.has(key)) byGestor.set(key, []);
        byGestor.get(key).push(g);
      });
      // Ordenar por gestor y semana
      const gs=[...byGestor.keys()].sort((a,b)=>String(a).localeCompare(String(b),'es',{numeric:true}));
      gs.forEach(gestor=>{
        const card=document.createElement("div"); card.className="col";
        const rows=(byGestor.get(gestor)||[]).sort((a,b)=>{const na=+a.semana, nb=+b.semana; return (isFinite(na)&&isFinite(nb))?na-nb:String(a.semana).localeCompare(String(b.semana));});
        const innerRows=rows.map(r=>`<tr><td style="width:56px;">${r.semana||''}</td><td style="text-align:right;">${r.plan}</td><td style="text-align:right;">${r.done}</td><td style="text-align:right;">${r.plan?Math.round((r.done/r.plan)*100):0}%</td></tr>`).join('');
        const totals=rows.reduce((a,r)=>({plan:a.plan+r.plan,done:a.done+r.done}),{plan:0,done:0});
        const covTot = totals.plan? Math.round((totals.done/totals.plan)*100) : 0;
        card.innerHTML = `
          <div class="card">
            <div class="toolbar" style="justify-content:space-between;align-items:center;">
              <strong>${gestor||'-'}</strong>
              <span class="chip">Cumplimiento total: <strong>${covTot}%</strong></span>
            </div>
            <div style="margin-top:6px;max-height:220px;overflow:auto;border-radius:10px;">
              <table class="table" style="font-size:12px;">
                <thead><tr><th>Semana</th><th style="text-align:right;">A realizar</th><th style="text-align:right;">Realizadas</th><th style="text-align:right;">% Cumpl.</th></tr></thead>
                <tbody>${innerRows}</tbody>
              </table>
            </div>
          </div>`;
        host.appendChild(card);
      });
    }
    
        function _isAll(v){ return v==null || v==='' || String(v).toLowerCase()==='todas'; }
const fSem = val('rwSemana');
    const fVend = val('rwVendedor');
    const fGes = val('rwGestor');

    
    // Prefer plan from Google Sheet Calendario; fallback to joined
    let planRows = [];
    if(Array.isArray(STATE.calendario) && STATE.calendario.length){
      const get = (r,klist)=>{ for(const k of klist){ if(r[k]!=null && r[k]!=='' ) return r[k]; } return ''; };
      planRows = STATE.calendario.filter(r=>{
        const wk = mapPlanWeek(get(r,['SEMANA','Semana','semana']));
        const vend = get(r,['vendedor','Vendedor','VENDEDOR']);
        const ges  = get(r,['gestor_servicio','Gestor','GESTOR_SERVICIO','gestor']);
        if(!_isAll(fSem) && String(wk) !== String(fSem)) return false;
        if(!_isAll(fVend) && String(vend) !== String(fVend)) return false;
        if(!_isAll(fGes) && String(ges) !== String(fGes)) return false;
        return true;
      }).map(r=>{
        return {
          gestor: String(get(r,['gestor_servicio','Gestor','GESTOR_SERVICIO','gestor'])||'').trim(),
          semana: mapPlanWeek(get(r,['SEMANA','Semana','semana'])),
          vendedor: get(r,['vendedor','Vendedor','VENDEDOR'])
        };
      });
    }else{
      planRows = (STATE.joined || []).filter(x=>{
        if(isVendorExcluded(x.vendedor)) return false;
        if(!_isAll(fSem) && String(x.semana) !== String(fSem)) return false;
        if(!_isAll(fVend) && String(x.vendedor) !== String(fVend)) return false;
        if(!_isAll(fGes) && String(x.gestor) !== String(fGes)) return false;
        return true;
      });
    }


    const calls = Array.isArray(STATE.calls) ? STATE.calls : [];
    const doneRows = calls.filter(c=>{
      const wk = getCallWeek(c);
      const vend = getCallVend(c);
      const ges = getCallGestor(c);
      if(!_isAll(fSem) && String(wk) !== String(fSem)) return false;
      if(!_isAll(fVend) && String(vend) !== String(fVend)) return false;
      if(!_isAll(fGes) && String(ges) !== String(fGes)) return false;
      return true;
    });

    const groups = new Map();
    function key(g, s){ return (g||'')+'__'+String(s||''); }
    function aggSet(g, s){
      const k = key(g,s);
      if(!groups.has(k)) groups.set(k, {gestor:g||'', semana:String(s||''), plan:0, done:0, last:null});
      return groups.get(k);
    }

    /*__PATCH_DERIVE_PLAN__*/
    if(!planRows.length){
      // Fallback: derive plan from Clients table (#tbl)
      const tb = document.querySelector("#tbl tbody");
      if(tb){
        planRows = Array.from(tb.querySelectorAll("tr")).map(tr=>{
          const tds = tr.children;
          return {
            gestor: (tds[5]&&tds[5].textContent.trim())||"",
            semana: mapPlanWeek((tds[2]&&tds[2].textContent.trim())||""),
          };
        });
      }
    }

    planRows.forEach(x=>{
      const g = aggSet(x.gestor, mapPlanWeek(x.semana));
      g.plan += 1;
    });

    (function(){
      const uniq = new Map();
      let totalCalls = 0;
      doneRows.forEach(c=>{
        const wk = getCallWeek(c)||'';
        const ges= getCallGestor(c)||'';
        const cod = String(c.cod_empresa || c['Cod Empresa'] || c.cod || c.codigo || c.Cod || '').trim() || String(c.cliente||'').trim();
        const key = ges+'__'+wk;
        if(!uniq.has(key)) uniq.set(key, new Set());
        uniq.get(key).add(cod);
        const g = aggSet(ges, wk);
        const d = getCallFecha(c);
        if(d && (!g.last || d>g.last)) g.last = d;
        totalCalls += 1;
      });
      uniq.forEach((set,key)=>{
        const [ges,wk] = key.split('__');
        const g = aggSet(ges, wk);
        g.done = set.size;
      });
      window.__resumen_total_calls = totalCalls;
    })();

    const full = ensureFourWeeks(groups);
    const rows = Array.from(full.values()).sort((a,b)=>{
      if(a.gestor === b.gestor){
        const na=Number(a.semana), nb=Number(b.semana);
        return (isFinite(na)&&isFinite(nb)) ? na-nb : String(a.semana).localeCompare(String(b.semana));
      }
      return a.gestor.localeCompare(b.gestor,'es',{numeric:true});
    });

    const totalPlan = rows.reduce((s,r)=>s+r.plan,0);
    const totalDone = rows.reduce((s,r)=>s+r.done,0);
    const cov = totalPlan ? Math.round((totalDone/totalPlan)*100) : 0;
    const rwPlan = document.getElementById('rwPlan');
    const rwDone = document.getElementById('rwDone');
    const rwCov  = document.getElementById('rwCov');
    if(rwPlan) rwPlan.textContent = String(totalPlan);
    var k1=document.getElementById('kpiPlan'); if(k1) k1.textContent=String(totalPlan);
    const kpiPlan=document.getElementById('kpiPlan'); if(kpiPlan) kpiPlan.textContent=String(totalPlan);
    if(rwDone) rwDone.textContent = String(totalDone);
    var k2=document.getElementById('kpiDone'); if(k2) k2.textContent=String(totalDone);
    const kpiDone=document.getElementById('kpiDone'); if(kpiDone) kpiDone.textContent=String(totalDone);
    if(rwCov)  rwCov.textContent  = cov + '%';
    var k3=document.getElementById('kpiCov'); if(k3) k3.textContent=cov + '%';
    const kpiCov=document.getElementById('kpiCov'); if(kpiCov) kpiCov.textContent = cov + '%'; 
var k4=document.getElementById('kpiCalls'); if(k4) k4.textContent = String(window.__resumen_total_calls||0);

    renderBreakdown(rows);
    const tb = document.querySelector('#rwTbl tbody');
    if(tb){
      tb.innerHTML = '';
      rows.forEach(r=>{
        const last = r.last ? r.last.toLocaleString('es-ES') : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.gestor||''}</td>
                        <td>${r.semana||''}</td>
                        <td>${r.plan}</td>
                        <td>${r.done}</td>
                        <td>${ (r.plan? Math.round((r.done/r.plan)*100):0) }%</td>
                        <td>${ last }</td>`;
        tb.appendChild(tr);
      });
    }
  }

  function exportResumenCSV(){
    const rows = Array.from(document.querySelectorAll('#rwTbl tbody tr')).map(tr=>{
      return Array.from(tr.children).map(td=>('"' + td.textContent.replace(/"/g,'""') + '"')).join(',');
    });
    const headers = ['Gestor','Semana','A realizar','Realizadas','% Cobertura','√öltima llamada'].map(h=>`"${h}"`).join(',');
    const csv = [headers].concat(rows).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'resumen_semanal.csv';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 200);
  }

  window.__resumen = window.__resumen || {}; window.__resumen.render = renderResumen;
  function wireResumen(){
    ['rwSemana','rwVendedor','rwGestor'].forEach(id=>{
      const el=document.getElementById(id);
      if(el && !el.__wired){ el.addEventListener('change', renderResumen); el.__wired=true; }
    });
    const exp=document.getElementById('rwExport');
    if(exp && !exp.__wired){ exp.addEventListener('click', exportResumenCSV); exp.__wired=true; }
    document.addEventListener('click', function(ev){
      if(ev.target.closest('#btnReporteResumen')){
        setTimeout(()=>{ buildResumenFilters(); renderResumen(); }, 60);
      }
    }, true);
  }

  function ensureReady(){
    let tries=0;
    const iv = setInterval(()=>{
      tries++;
      wireResumen();
      if(buildResumenFilters()){
        renderResumen();
        clearInterval(iv);
      }
      if(tries>120) clearInterval(iv);
    }, 100);
  }

  document.addEventListener('DOMContentLoaded', ensureReady);
})();
</script>

<script id="safe-resumen-observers">
(function(){
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  function optionsText(sel){ return Array.from(sel.options).map(o=>o.textContent.trim()).filter(Boolean); }

  // Defensive derivation if STATE.joined isn't ready: read current table of clientes filtrados
  function deriveFromTable(){
    const tb = document.querySelector('#tbl tbody');
    const vend = new Set(), gest = new Set(), sems = new Set();
    if(tb){
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const tds = tr.children;
        if(tds && tds.length>=7){
          // columns: Cod, Cliente, Semana, D√≠a, Vendedor, Gestor, Empresa
          const semana = (tds[2].textContent||'').trim();
          const vendedor = (tds[4].textContent||'').trim();
          const gestor = (tds[5].textContent||'').trim();
          if(semana) sems.add(semana);
          if(vendedor) vend.add(vendedor);
          if(gestor) gest.add(gestor);
        }
      });
    }
    return {
      semanas: Array.from(sems).sort((a,b)=>String(a).localeCompare(String(b),'es',{numeric:true})),
      vendedores: Array.from(vend).sort((a,b)=>String(a).localeCompare(String(b),'es',{numeric:true})),
      gestores: Array.from(gest).sort((a,b)=>String(a).localeCompare(String(b),'es',{numeric:true}))
    };
  }

  function fillSelect(id, values, first){
    const el = document.getElementById(id);
    if(!el) return;
    const opts = [`<option value="">${first}</option>`].concat(values.map(v=>`<option value="${String(v)}">${String(v)}</option>`));
    el.innerHTML = opts.join('');
  }

  function rebuildResumenFromState(){
    try{
      const S = (window.STATE && Array.isArray(window.STATE.joined)) ? window.STATE.joined : [];
      if(S.length){
        const uniq = (arr)=> Array.from(new Set(arr.filter(x=>x!=null && x!==''))).sort((a,b)=>{
          const na=Number(a), nb=Number(b);
          if(isFinite(na)&&isFinite(nb)) return na-nb;
          return String(a).localeCompare(String(b),'es',{numeric:true});
        });
        const semanas = uniq(S.map(x=> String(x.semana||'').trim()).filter(Boolean));
        const vendedores = uniq(S.map(x=> x.vendedor));
        const gestores = uniq(S.map(x=> x.gestor));
        fillSelect('rwSemana', semanas.length? semanas : ['1','2','3','4'], 'Todas');
        fillSelect('rwVendedor', vendedores, 'Todos');
        fillSelect('rwGestor', gestores, 'Todos');
        return true;
      }
    }catch(e){}
    return false;
  }

  function rebuildResumenFromUI(){
    const fv = document.getElementById('fVendedor');
    const fg = document.getElementById('fGestor');
    const fs = document.getElementById('fSemana');
    if(fv && fg){
      const v = optionsText(fv).filter(t=>t.toLowerCase()!=='todos');
      const g = optionsText(fg).filter(t=>t.toLowerCase()!=='todos');
      const s = fs ? optionsText(fs).filter(t=>t.toLowerCase()!=='todas') : [];
      if(v.length || g.length || s.length){
        if(s.length) fillSelect('rwSemana', s, 'Todas');
        if(v.length) fillSelect('rwVendedor', v, 'Todos');
        if(g.length) fillSelect('rwGestor', g, 'Todos');
        return true;
      }
    }
    // last fallback: derive from #tbl
    const deriv = deriveFromTable();
    if(deriv.vendedores.length || deriv.gestores.length || deriv.semanas.length){
      if(deriv.semanas.length) fillSelect('rwSemana', deriv.semanas, 'Todas');
      if(deriv.vendedores.length) fillSelect('rwVendedor', deriv.vendedores, 'Todos');
      if(deriv.gestores.length) fillSelect('rwGestor', deriv.gestores, 'Todos');
      return true;
    }
    return false;
  }

  function rebuildResumen(){
    if(!rebuildResumenFromState()){
      rebuildResumenFromUI();
    }
    // Re-render KPI si est√° disponible
    if(window.__resumen && window.__resumen.render){
      try{ window.__resumen.render(); }catch(e){}
    } else {
      // Compatibilidad: trigger el c√°lculo si el script del KPI est√° cargado
      const evt = new Event('change');
      ['rwSemana','rwVendedor','rwGestor'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.dispatchEvent(evt);
      });
    }
  }

  // Observa cuando los filtros principales se llenan (es se√±al de que STATE.joined ya existe)
  function observeMainFilters(){
    const fv = document.getElementById('fVendedor');
    const fg = document.getElementById('fGestor');
    if(!fv || !fg) return;
    const obs = new MutationObserver((muts)=>{
      // si aparecen nuevas opciones, reconstruir
      const hasV = fv.options.length>1;
      const hasG = fg.options.length>1;
      if(hasV || hasG){
        rebuildResumen();
      }
    });
    obs.observe(fv, {childList:true});
    obs.observe(fg, {childList:true});
  }

  document.addEventListener('DOMContentLoaded', function(){
    observeMainFilters();
    // Cuando se abre el Resumen con cualquier #btnReporteResumen, reconstruir
    document.addEventListener('click', function(ev){
      if(ev.target.closest('#btnReporteResumen')){
        setTimeout(rebuildResumen, 80);
      }
    }, true);
  });
})();
</script>


<script id="kpi-fix-resumen">
(function(){
  // --- small helpers (non-invasive) ---
  const $ = (s, r=document)=>r.querySelector(s);
  const $$= (s, r=document)=>Array.from(r.querySelectorAll(s));
  function normName(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase(); }
  function val(id){ const el=document.getElementById(id); return el? el.value : ''; }
  function toDate(x){ if(!x) return null; const d=new Date(x); return isNaN(d)? null : d; }
  function get(obj,keys){
    for(const k of keys){ if(obj && obj[k]!=null && obj[k]!=='') return obj[k]; }
    const flat={}; for(const k in obj){ flat[k.toLowerCase().replace(/\s|_/g,'')] = obj[k]; }
    for(const k of keys){ const nk=k.toLowerCase().replace(/\s|_/g,''); if(flat[nk]!=null && flat[nk] !== '') return flat[nk]; }
    return '';
  }
  function mapPlanWeek(w){
    const n = Number(String(w||'').replace(/[^0-9]/g,''));
    if(Number.isFinite(n) && n>=1){ return n<=4 ? String(n) : String(((n-1)%4)+1); }
    return String(w||'');
  }
  function getCallWeek(rec){
    const s = get(rec, ['Semana', 'N Semana', 'N¬∞ Semana', 'N_Semana', 'semana']);
    if(s) return String(s).trim();
    const d = toDate(get(rec, ['Fecha/Hora','Fecha','fecha','FechaHora','fecha_hora']));
    if(d){
      const first = new Date(d.getFullYear(), d.getMonth(), 1).getDay(); // 0=Dom..6=Sab
      const firstIso = (first===0?7:first);
      const week = Math.ceil( (d.getDate() + firstIso - 1) / 7 );
      return String(Math.min(4, Math.max(1, week)));
    }
    return '';
  }
  function getCallVend(rec){ return get(rec, ['Vendedor','vendedor']); }
  function getCallGes (rec){ return get(rec, ['gestor_servicio','Gestor','gestor']); }
  function getCallFecha(rec){ return toDate(get(rec, ['Fecha/Hora','Fecha','fecha','FechaHora','fecha_hora'])); }

  // ensure 1..4 weeks per gestor
  function ensureFourWeeks(groups){
    const gestores = new Set();
    (groups instanceof Map ? Array.from(groups.values()) : groups).forEach(g=>gestores.add(g.gestor||''));
    const out = new Map();
    const key = (ges, sem)=>(ges||'')+'__'+String(sem);
    gestores.forEach(ges=>{ [1,2,3,4].forEach(sem=> out.set(key(ges,sem), {gestor:ges||'', semana:String(sem), plan:0, done:0, last:null}) ); });
    (groups instanceof Map ? Array.from(groups.values()) : groups).forEach(g=>{
      const k = key(g.gestor||'', g.semana);
      if(!out.has(k)) out.set(k,{gestor:g.gestor||'', semana:String(g.semana||''), plan:0, done:0, last:null});
      const tgt = out.get(k);
      tgt.plan += g.plan||0; tgt.done += g.done||0; if(g.last && (!tgt.last || g.last>tgt.last)) tgt.last=g.last;
    });
    return out;
  }

  function renderResumen(){
    const STATE = window.STATE || {};
    const cal   = Array.isArray(STATE.calendario)? STATE.calendario : [];
    const calls = Array.isArray(STATE.calls) ? STATE.calls : [];

    // current filters
    const fSem  = val('rwSemana');
    const fVend = val('rwVendedor');
    const fGes  = val('rwGestor');
    const fVendN = normName(fVend);
    const fGesN  = normName(fGes);

    const groups = new Map();
    const key=(g,s)=> normName(g)+'__'+String(s||'');
    const agg=(g,s)=>{ const k=key(g,s); if(!groups.has(k)) groups.set(k,{gestor:g||'', semana:String(s||''), plan:0, done:0, last:null}); return groups.get(k); };

    // PLAN desde Calendario
    cal.forEach(r=>{
      const wk = mapPlanWeek(r['N Semana']||r['N_Semana']||r['NSemana']||r['SEMANA']||r['Semana']||r['semana']||'');
      const vend = r['vendedor']||r['Vendedor']||r['VENDEDOR']||'';
      const ges  = r['gestor_servicio']||r['Gestor']||r['GESTOR_SERVICIO']||r['Gestor cartera']||r['gestor_cartera']||r['gcartera']||'';
      if(fSem && String(wk)!==String(fSem)) return;
      if(fVend && normName(vend)!==fVendN)   return;
      if(fGes && normName(ges)!==fGesN)      return;
      agg(ges, wk).plan += 1;
    });

    // REALIZADAS desde llamadas
    calls.forEach(c=>{
      const wk   = getCallWeek(c) || '';
      const vend = getCallVend(c) || '';
      const ges  = getCallGes(c)  || '';
      if(fSem && String(wk)!==String(fSem)) return;
      if(fVend && normName(vend)!==fVendN)   return;
      if(fGes && normName(ges)!==fGesN)      return;
      const g = agg(ges, wk);
      g.done += 1;
      const d = getCallFecha(c);
      if(d && (!g.last || d>g.last)) g.last = d;
    });

    // garantizar 4 semanas por gestor
    const full = ensureFourWeeks(groups);
    const rows = Array.from(full.values()).sort((a,b)=>{
      return a.gestor===b.gestor
        ? (Number(a.semana)||0)-(Number(b.semana)||0)
        : String(a.gestor).localeCompare(String(b.gestor), 'es', {numeric:true});
    });

    // Totales y KPI
    const totalPlan = rows.reduce((s,r)=>s+r.plan,0);
    const totalDone = rows.reduce((s,r)=>s+r.done,0);
    const cov = totalPlan ? Math.round((totalDone/totalPlan)*100) : 0;

    const rwPlan = $('#rwPlan'), rwDone=$('#rwDone'), rwCov=$('#rwCov');
    if(rwPlan) rwPlan.textContent = String(totalPlan);
    if(rwDone) rwDone.textContent = String(totalDone);
    if(rwCov)  rwCov.textContent  = cov + '%';

    const k1=$('#kpiPlan'), k2=$('#kpiDone'), k3=$('#kpiCov');
    if(k1) k1.textContent = String(totalPlan);
    if(k2) k2.textContent = String(totalDone);
    if(k3) k3.textContent = cov + '%';

    // Render tabla
    const tb = $('#rwTbl tbody');
    if(tb){
      tb.innerHTML='';
      rows.forEach(r=>{
        const last = r.last ? r.last.toLocaleString('es-ES') : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.gestor||''}</td>
                        <td>${r.semana||''}</td>
                        <td>${r.plan}</td>
                        <td>${r.done}</td>
                        <td>${r.plan? Math.round((r.done/r.plan)*100) : 0}%</td>
                        <td>${last}</td>`;
        tb.appendChild(tr);
      });
    }
  }

  // Wire up once
  function wire(){
    ['rwSemana','rwVendedor','rwGestor'].forEach(id=>{
      const el = document.getElementById(id);
      if(el && !el.__kpi_wired){
        el.__kpi_wired = true;
        el.addEventListener('change', renderResumen);
      }
    });
    // when the overlay opens (if body adds a class elsewhere), attempt re-render
    document.addEventListener('click', function(ev){
      if(ev.target && (ev.target.id === 'btnReporteResumen' || ev.target.closest && ev.target.closest('#btnReporteResumen'))){
        setTimeout(renderResumen, 150);
      }
    }, true);
    // initial
    setTimeout(renderResumen, 350);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', wire);
  } else {
    wire();
  }
})();

// ======== RESUMEN KPI LOGIC (append-only) ========
(function(){
  const RZ = {};
  RZ.stripAccents = s => (s??'').toString().normalize('NFD').replace(/[ÃÄ-\u036f]/g,'');
  RZ.normName = s => RZ.stripAccents(String(s||'')).trim().toLowerCase();
  RZ.normKey = function(row, keys){
    for(const k of keys){ if(row && row[k]!=null && row[k]!== '') return row[k]; }
    if(!row) return '';
    const m={}; for(const k in row){ m[k.toLowerCase().replace(/\s|_/g,'')] = row[k]; }
    for(const k of keys){ const nk=k.toLowerCase().replace(/\s|_/g,''); if(nk in m) return m[nk]; }
    return '';
  };
  RZ.parseDateLoose = function(v){
    if(!v) return null;
    const s = String(v).trim().replace('T',' ');
    let d = new Date(s);
    if(!isNaN(d)) return d;
    const m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){
      const dd=+m[1], mm=(+m[2])-1, yy=(m[3].length===2?2000:+m[3]), hh=+(m[4]||0), mi=+(m[5]||0), ss=+(m[6]||0);
      d = new Date(yy,mm,dd,hh,mi,ss);
      if(!isNaN(d)) return d;
    }
    return null;
  };
  RZ.weekOfMonth14 = function(d){ if(!(d instanceof Date)||isNaN(d)) return null; const day=d.getDate(); return day<=7?1: day<=14?2: day<=21?3:4; };
  RZ.mapSemana4 = function(n){ const num=Number(String(n).trim()); if(Number.isFinite(num)){ if(num>=1&&num<=4) return num; return ((num-1)%4)+1; } return null; };
  RZ.getSemanaFromRow = function(row){
    const exp = RZ.normKey(row, ['Semana','SEMANA','semana','N Semana','N_Semana','NSEMANA','nsemana']);
    if(exp!=='' && exp!=null){ const m=RZ.mapSemana4(exp); if(m!=null) return m; }
    const fh = RZ.normKey(row, ['FechaHora','Fecha y hora','Fecha y Hora','Fecha','fecha','FECHA','fecha_hora','Fecha/Hora','fechaHora']);
    const d = RZ.parseDateLoose(fh);
    return RZ.weekOfMonth14(d);
  };

  function ST(){ try{return window.STATE||{};}catch(e){return {};} }
  function q(id){ return document.getElementById(id); }

  function fillResumenFilters(){
    const st=ST();
    const vend=new Set(), ges=new Set();
    const cal=Array.isArray(st.calendario)?st.calendario:[];
    cal.forEach(r=>{
      const v=RZ.normKey(r,['vendedor','Vendedor','VENDEDOR']);
      const g=RZ.normKey(r,['gestor_servicio','Gestor','GESTOR_SERVICIO']);
      if(String(v).trim()) vend.add(String(v));
      if(String(g).trim()) ges.add(String(g));
    });
    const calls=Array.isArray(st.calls)?st.calls:[];
    calls.forEach(r=>{
      const v=RZ.normKey(r,['Vendedor','vendedor','VENDEDOR']);
      const g=RZ.normKey(r,['gestor','Gestor','GESTOR','gestor_servicio','GESTOR_SERVICIO']);
      if(String(v).trim()) vend.add(String(v));
      if(String(g).trim()) ges.add(String(g));
    });
    const sV=q('rwVendedor'), sG=q('rwGestor');
    if(sV){
      const cur=sV.value;
      sV.innerHTML='<option value="">Todos</option>'+Array.from(vend).sort((a,b)=>a.localeCompare(b,'es',{numeric:true})).map(x=>`<option value="${x}">${x}</option>`).join('');
      if(vend.has(cur)) sV.value=cur;
    }
    if(sG){
      const cur=sG.value;
      sG.innerHTML='<option value="">Todos</option>'+Array.from(ges).sort((a,b)=>a.localeCompare(b,'es',{numeric:true})).map(x=>`<option value="${x}">${x}</option>`).join('');
      if(ges.has(cur)) sG.value=cur;
    }
  }


  
function computeResumenAggregates(){
  // Filtros
  const fSem = document.getElementById('rwSemana')?.value || '';
  const fVend = (document.getElementById('rwVendedor')?.value || '').toString().trim().toLowerCase();
  const fGest = (document.getElementById('rwGestor')?.value || '').toString().trim().toLowerCase();

  // Normalizadores
  const N = s => (s==null?'':String(s)).trim();
  const L = s => N(s).toLowerCase();
  const W = s => {
    const t=N(s);
    // if already 1..4 just return
    if(['1','2','3','4'].includes(t)) return t;
    // fallback: derive from ISO date yyyy-mm-dd
    const m = t.match(/(\d{4})-(\d{2})-(\d{2})/);
    if(m){ const d=parseInt(m[3],10); return d<=7?'1':d<=14?'2':d<=21?'3':'4'; }
    return '';
  };

  // Datos
  const calRaw = (window.ST?.().calendario || window.ST?.().Calendario || []);
  const callsRaw = (window.ST?.().calls || window.ST?.().Calls || []);

  // PLAN (itinerario): contar filas de Calendario con Condicion="En Ruta"
  // Campos tolerantes a may√∫sculas. Semana se toma del campo "SEMANA" (1-4)
  const cal = calRaw.map(r => ({
    semana: W(r['SEMANA'] ?? r['Semana'] ?? r['N Semana'] ?? r['N_Semana'] ?? r['semana']),
    vendedor: L(r['vendedor'] ?? r['Vendedor'] ?? r['VENDEDOR']),
    gestor: L(r['gestor_servicio'] ?? r['Gestor'] ?? r['GESTOR_SERVICIO']),
    condicion: L(r['Condicion'] ?? r['CONDICION'] ?? r['condicion']),
    cod: N(r['Cod Empresa'] ?? r['COD EMPRESA'] ?? r['cod'] ?? r['Cod'])
  })).filter(r => r.condicion === 'en ruta');  // solo "En Ruta"

  // DONE (llamadas): desde Reporte
  const calls = callsRaw.map(r => ({
    semana: W(r['semana'] ?? r['N¬∞ Semana'] ?? r['N Semana'] ?? r['Semana'] ?? r['fecha/hora'] ?? r['Fecha/Hora']),
    vendedor: L(r['vendedor'] ?? r['Vendedor'] ?? r['VENDEDOR']),
    gestor: L(r['gestor'] ?? r['gestor_servicio'] ?? r['Gestor'] ?? r['GESTOR_SERVICIO']),
    fecha: N(r['fecha/hora'] ?? r['Fecha/Hora'] ?? r['Fecha'] ?? r['datetime']),
  }));

  // Determinar conjunto de gestores (seg√∫n filtro)
  const gestores = Array.from(new Set(cal.map(r=>r.gestor).filter(Boolean).concat(calls.map(r=>r.gestor).filter(Boolean))))
    .filter(g => !fGest || g===fGest);

  // Armar siempre las 4 semanas
  const semanasBase = ['1','2','3','4'];
  const rows = [];

  gestores.forEach(gest => {
    semanasBase.forEach(sem => {
      if(fSem && sem !== fSem) return;

      // aplicar filtro vendedor opcional
      const predVend = (v) => !fVend || v===fVend;

      const plan = cal.filter(r => r.gestor===gest && r.semana===sem && predVend(r.vendedor)).length;

      const done = calls.filter(r => r.gestor===gest && r.semana===sem && predVend(r.vendedor)).length;

      // √∫ltima llamada del par gestor/semana (si existe)
      const last = calls.filter(r => r.gestor===gest && r.semana===sem && predVend(r.vendedor))
                        .map(r => r.fecha).sort().slice(-1)[0] || '';

      const cov = plan>0 ? Math.round((done/plan)*100) : 0;
      rows.push({ gestor: gest.toUpperCase(), semana: sem, plan, done, cov, last });
    });
  });

  // Ordenar por gestor y semana asc
  rows.sort((a,b)=> (a.gestor.localeCompare(b.gestor) || (parseInt(a.semana)-parseInt(b.semana))));

  // Totales
  const totalPlan = rows.reduce((a,r)=>a+r.plan,0);
  const totalDone = rows.reduce((a,r)=>a+r.done,0);
  const totalCov  = totalPlan>0 ? Math.round((totalDone/totalPlan)*100) : 0;

  return { rows, totalPlan, totalDone, totalCov };
}

    });

    // Totals
    const totalPlan = rows.reduce((a,r)=>a+r.plan,0);
    const totalDone = rows.reduce((a,r)=>a+r.done,0);
    const totalCov  = totalPlan>0 ? Math.round((totalDone/totalPlan)*100) : 0;

    return { rows, totalPlan, totalDone, totalCov };
  }


  function renderResumenKpisAndChips(agg){
    const plan = String(agg.totalPlan);
    const done = String(agg.totalDone);
    const cov  = String(agg.totalCov)+'%';
    const ids = { kpiPlan:'kpiPlan', kpiDone:'kpiDone', kpiCov:'kpiCov', rwPlan:'rwPlan', rwDone:'rwDone', rwCov:'rwCov' };
    for(const [k,id] of Object.entries(ids)){
      const el = q(id);
      if(el) el.textContent = (k==='kpiCov'||k==='rwCov')? cov : (k.endsWith('Plan')||k==='rwPlan'? plan : (k.endsWith('Done')||k==='rwDone'? done : cov));
    }
    const info = q('rwInfo');
    if(info){
      const fS = q('rwSemana')?.value || 'Todas';
      const fV = q('rwVendedor')?.value || 'Todos';
      const fG = q('rwGestor')?.value || 'Todos';
      info.textContent = `Semana: ${fS||'Todas'} ¬∑ Vendedor: ${fV||'Todos'} ¬∑ Gestor: ${fG||'Todos'}`;
    }
  }

  function renderResumenTable(agg){
    const tb = q('rwTbl')?.querySelector('tbody');
    if(!tb) return;
    tb.innerHTML='';
    agg.rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.gestor}</td><td>${r.semana}</td><td>${r.plan}</td><td>${r.done}</td><td>${r.cov}%</td><td>${r.last}</td>`;
      tb.appendChild(tr);
    });
  }

  function exportResumenCSV(agg){
    const lines = [['Gestor','Semana','A realizar','Realizadas','% Cobertura','√öltima llamada']]
      .concat(agg.rows.map(r=>[r.gestor,r.semana,r.plan,r.done,`${r.cov}%`,r.last]));
    const csv = lines.map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='resumen_semanal.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  function recomputeResumen(){
    fillResumenFilters();
    const agg = computeResumenAggregates();
    renderResumenKpisAndChips(agg);
    renderResumenTable(agg);
    return agg;
  }

  function hookResumenEvents(){
    const ids = ['rwSemana','rwVendedor','rwGestor'];
    ids.forEach(id=>{ const el=q(id); if(el){ el.addEventListener('change', ()=>recomputeResumen()); }});
    const btnExp = q('rwExport'); if(btnExp){ btnExp.addEventListener('click', ()=>{ const agg=recomputeResumen(); exportResumenCSV(agg); }); }
    // When the overlay is shown (body.show-resumen), recompute once
    const obs = new MutationObserver(()=>{
      if(document.body.classList.contains('show-resumen')){
        setTimeout(()=>recomputeResumen(), 30);
      }
    });
    obs.observe(document.body,{attributes:true,attributeFilter:['class']});
    // Also compute on DOM ready for safety
    document.addEventListener('DOMContentLoaded', ()=>{ /* lazy */ });
  }

  // Initialize hooks immediately (safe even if elements not yet in DOM)
  try{ hookResumenEvents(); }catch(e){ console.warn('Resumen hook error', e); }
})(); // ===== end RESUMEN KPI LOGIC =====


// ======== RESUMEN KPI (Master Clean) ========
(function(){
  const RZ = {};
  RZ.stripAccents = s => (s??'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  RZ.normName = s => RZ.stripAccents(String(s||'')).trim().toLowerCase();
  RZ.normKey = function(r, keys){
    for(const k of keys){ if(r && r[k]!=null && r[k]!== '') return r[k]; }
    if(!r) return '';
    const m={}; for(const k in r){ m[k.toLowerCase().replace(/\s|_/g,'')] = r[k]; }
    for(const k of keys){ const nk=k.toLowerCase().replace(/\s|_/g,''); if(nk in m) return m[nk]; }
    return '';
  };
  RZ.parseDateLoose = function(v){
    if(!v) return null;
    const s = String(v).trim().replace('T',' ');
    let d = new Date(s);
    if(!isNaN(d)) return d;
    const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
    if(m){ d=new Date((m[3].length===2?2000:+m[3]), (+m[2])-1, +m[1], +(m[4]||0), +(m[5]||0), +(m[6]||0)); if(!isNaN(d)) return d; }
    return null;
  };
  RZ.weekOfMonth14 = d => (d instanceof Date && !isNaN(d)) ? (d.getDate()<=7?1:d.getDate()<=14?2:d.getDate()<=21?3:4) : null;
  RZ.mapSemana4 = n => { const x = Number(String(n).trim()); return Number.isFinite(x)? (x>=1 && x<=4 ? x : ((x-1)%4)+1) : null; };
  RZ.getSemanaFromRow = function(r){
    const e = RZ.normKey(r, ['Semana','SEMANA','semana','N Semana','N_Semana','NSEMANA','nsemana']);
    if(e!=='' && e!=null){ const m=RZ.mapSemana4(e); if(m!=null) return m; }
    const fh = RZ.normKey(r, ['FechaHora','Fecha y hora','Fecha y Hora','Fecha','fecha','FECHA','fecha_hora','Fecha/Hora','fechaHora']);
    return RZ.weekOfMonth14(RZ.parseDateLoose(fh));
  };
  function ST(){ try{return window.STATE||{};}catch(e){return {};} }
  function q(id){ return document.getElementById(id); }

  function fillResumenFilters(){
    const st=ST();
    const cal = Array.isArray(st.calendario)?st.calendario:(Array.isArray(st.Calendario)?st.Calendario:[]);
    const calls = Array.isArray(st.calls)?st.calls:(Array.isArray(st.Calls)?st.Calls:[]);
    const vend=new Set(), ges=new Set();
    [...cal, ...calls].forEach(r=>{
      const v = RZ.normKey(r,['vendedor','Vendedor','VENDEDOR']);
      const g = RZ.normKey(r,['gestor_servicio','Gestor','GESTOR_SERVICIO','gestor','GESTOR']);
      if(String(v).trim()) vend.add(String(v));
      if(String(g).trim()) ges.add(String(g));
    });
    const sV=q('rwVendedor'), sG=q('rwGestor');
    if(sV){ const cur=sV.value; sV.innerHTML='<option value=\"\">Todos</option>'+Array.from(vend).sort((a,b)=>a.localeCompare(b,'es',{numeric:true})).map(x=>`<option value=\"${x}\">${x}</option>`).join(''); if(vend.has(cur)) sV.value=cur; }
    if(sG){ const cur=sG.value; sG.innerHTML='<option value=\"\">Todos</option>'+Array.from(ges).sort((a,b)=>a.localeCompare(b,'es',{numeric:true})).map(x=>`<option value=\"${x}\">${x}</option>`).join(''); if(ges.has(cur)) sG.value=cur; }
  }

  
function computeResumenAggregates(){
  // Filtros
  const fSem = document.getElementById('rwSemana')?.value || '';
  const fVend = (document.getElementById('rwVendedor')?.value || '').toString().trim().toLowerCase();
  const fGest = (document.getElementById('rwGestor')?.value || '').toString().trim().toLowerCase();

  // Normalizadores
  const N = s => (s==null?'':String(s)).trim();
  const L = s => N(s).toLowerCase();
  const W = s => {
    const t=N(s);
    // if already 1..4 just return
    if(['1','2','3','4'].includes(t)) return t;
    // fallback: derive from ISO date yyyy-mm-dd
    const m = t.match(/(\d{4})-(\d{2})-(\d{2})/);
    if(m){ const d=parseInt(m[3],10); return d<=7?'1':d<=14?'2':d<=21?'3':'4'; }
    return '';
  };

  // Datos
  const calRaw = (window.ST?.().calendario || window.ST?.().Calendario || []);
  const callsRaw = (window.ST?.().calls || window.ST?.().Calls || []);

  // PLAN (itinerario): contar filas de Calendario con Condicion="En Ruta"
  // Campos tolerantes a may√∫sculas. Semana se toma del campo "SEMANA" (1-4)
  const cal = calRaw.map(r => ({
    semana: W(r['SEMANA'] ?? r['Semana'] ?? r['N Semana'] ?? r['N_Semana'] ?? r['semana']),
    vendedor: L(r['vendedor'] ?? r['Vendedor'] ?? r['VENDEDOR']),
    gestor: L(r['gestor_servicio'] ?? r['Gestor'] ?? r['GESTOR_SERVICIO']),
    condicion: L(r['Condicion'] ?? r['CONDICION'] ?? r['condicion']),
    cod: N(r['Cod Empresa'] ?? r['COD EMPRESA'] ?? r['cod'] ?? r['Cod'])
  })).filter(r => r.condicion === 'en ruta');  // solo "En Ruta"

  // DONE (llamadas): desde Reporte
  const calls = callsRaw.map(r => ({
    semana: W(r['semana'] ?? r['N¬∞ Semana'] ?? r['N Semana'] ?? r['Semana'] ?? r['fecha/hora'] ?? r['Fecha/Hora']),
    vendedor: L(r['vendedor'] ?? r['Vendedor'] ?? r['VENDEDOR']),
    gestor: L(r['gestor'] ?? r['gestor_servicio'] ?? r['Gestor'] ?? r['GESTOR_SERVICIO']),
    fecha: N(r['fecha/hora'] ?? r['Fecha/Hora'] ?? r['Fecha'] ?? r['datetime']),
  }));

  // Determinar conjunto de gestores (seg√∫n filtro)
  const gestores = Array.from(new Set(cal.map(r=>r.gestor).filter(Boolean).concat(calls.map(r=>r.gestor).filter(Boolean))))
    .filter(g => !fGest || g===fGest);

  // Armar siempre las 4 semanas
  const semanasBase = ['1','2','3','4'];
  const rows = [];

  gestores.forEach(gest => {
    semanasBase.forEach(sem => {
      if(fSem && sem !== fSem) return;

      // aplicar filtro vendedor opcional
      const predVend = (v) => !fVend || v===fVend;

      const plan = cal.filter(r => r.gestor===gest && r.semana===sem && predVend(r.vendedor)).length;

      const done = calls.filter(r => r.gestor===gest && r.semana===sem && predVend(r.vendedor)).length;

      // √∫ltima llamada del par gestor/semana (si existe)
      const last = calls.filter(r => r.gestor===gest && r.semana===sem && predVend(r.vendedor))
                        .map(r => r.fecha).sort().slice(-1)[0] || '';

      const cov = plan>0 ? Math.round((done/plan)*100) : 0;
      rows.push({ gestor: gest.toUpperCase(), semana: sem, plan, done, cov, last });
    });
  });

  // Ordenar por gestor y semana asc
  rows.sort((a,b)=> (a.gestor.localeCompare(b.gestor) || (parseInt(a.semana)-parseInt(b.semana))));

  // Totales
  const totalPlan = rows.reduce((a,r)=>a+r.plan,0);
  const totalDone = rows.reduce((a,r)=>a+r.done,0);
  const totalCov  = totalPlan>0 ? Math.round((totalDone/totalPlan)*100) : 0;

  return { rows, totalPlan, totalDone, totalCov };
}

    });
    const totalPlan=rows.reduce((a,r)=>a+r.plan,0), totalDone=rows.reduce((a,r)=>a+r.done,0);
    return {rows, totalPlan, totalDone, totalCov: totalPlan>0? Math.round((totalDone/totalPlan)*100) : 0};
  }

  function renderResumenKpisAndChips(a){
    const ids = {kpiPlan:a.totalPlan, kpiDone:a.totalDone, kpiCov:a.totalCov+'%', rwPlan:a.totalPlan, rwDone:a.totalDone, rwCov:a.totalCov+'%'};
    Object.entries(ids).forEach(([id,val])=>{ const el=q(id); if(el) el.textContent=String(val); });
    const info=q('rwInfo'); if(info){ const s=q('rwSemana')?.value||'Todas', v=q('rwVendedor')?.value||'Todos', g=q('rwGestor')?.value||'Todos'; info.textContent=`Semana: ${s||'Todas'} ¬∑ Vendedor: ${v||'Todos'} ¬∑ Gestor: ${g||'Todos'}`; }
  }
  function renderResumenTable(a){
    const tb=q('rwTbl')?.querySelector('tbody'); if(!tb) return; tb.innerHTML='';
    a.rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.gestor}</td><td>${r.semana}</td><td>${r.plan}</td><td>${r.done}</td><td>${r.cov}%</td><td>${r.last}</td>`; tb.appendChild(tr); });
  }
  function recomputeResumen(){ fillResumenFilters(); const a=computeResumenAggregates(); renderResumenKpisAndChips(a); renderResumenTable(a); return a; }
  function visible(el){ return !!(el && (el.offsetWidth || el.offsetHeight || el.getClientRects().length)); }
  function hook(){ ['rwSemana','rwVendedor','rwGestor'].forEach(id=>{ const el=q(id); if(el){ el.addEventListener('change', ()=>recomputeResumen()); }});
    const scr=q('screenResumenSem'); const ob=new MutationObserver(()=>{ if(visible(scr)) setTimeout(recomputeResumen,30); });
    if(scr) ob.observe(scr,{attributes:true,attributeFilter:['class','style']});
    const ob2=new MutationObserver(()=>{ if(document.body.classList.contains('show-resumen')) setTimeout(recomputeResumen,30); });
    ob2.observe(document.body,{attributes:true,attributeFilter:['class']});
    document.addEventListener('DOMContentLoaded', ()=> setTimeout(()=>{ if(visible(scr)) recomputeResumen(); }, 60));
    // watcher estado
    let last={c:-1,d:-1}; setInterval(()=>{ try{ const st=ST(); const cal=(st.calendario||st.Calendario||[]), calls=(st.calls||st.Calls||[]); const c=Array.isArray(cal)?cal.length:0, d=Array.isArray(calls)?calls.length:0; if(c!==last.c||d!==last.d){ last={c,d}; if(visible(scr)||document.body.classList.contains('show-resumen')) recomputeResumen(); } }catch(e){} }, 600);
  }
  try{ hook(); }catch(e){ console.warn('Resumen hook error', e); }
})(); 
// ======== GOOGLE SHEETS CSV LOADER (explicit mapping) ========
(function(){
  // URLs provistas por el usuario
  const CALENDARIO_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1016315198&single=true&output=csv";
  const CALLS_URL_1   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv";
  const CALLS_URL_2   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv";

  function csvToObjects(t){
    const rows=[]; let i=0,cur='',inq=false,row=[]; const pushC=()=>{row.push(cur);cur='';}, pushR=()=>{rows.push(row);row=[];};
    while(i<t.length){ const c=t[i]; if(inq){ if(c==='\"'){ if(t[i+1]==='\"'){cur+='\"'; i++;} else inq=false; } else cur+=c; } else {
      if(c==='\"') inq=true; else if(c===',') pushC(); else if(c==='\\n'){ pushC(); pushR(); } else if(c==='\\r'){} else cur+=c; } i++; }
    if(cur.length>0 || row.length>0){ pushC(); pushR(); }
    const header=(rows.shift()||[]).map(h=>String(h||'').trim()); 
    return rows.filter(r=>r.length && r.some(x=>String(x).trim()!=='')).map(r=>{ const o={}; header.forEach((h,idx)=>o[h]=r[idx]); return o; });
  }
  async function load(url){ const res=await fetch(url,{cache:'no-store'}); const txt=await res.text(); return csvToObjects(txt); }
  async function hydrate(){
    try{
      const [cal, calls1, calls2] = await Promise.all([load(CALENDARIO_URL), load(CALLS_URL_1), load(CALLS_URL_2)]);
      const st = (window.STATE = (window.STATE||{}));
      st.calendario = cal; st.Calendario = cal;
      const calls = [...calls1, ...calls2];
      st.calls = calls; st.Calls = calls;
      // recompute si Resumen visible
      if(typeof Event==='function'){ document.dispatchEvent(new Event('state:ready')); }
      if(typeof window.tryAutoRecompute==='function'){ setTimeout(window.tryAutoRecompute, 20); }
    }catch(e){ console.error('Error cargando sheets:', e); }
  }
  document.addEventListener('DOMContentLoaded', hydrate);
  document.addEventListener('click', ()=> setTimeout(hydrate, 50)); // por si navegas a Resumen luego
})();

</script>

<script id="kpi-resumen-clean-v1">
// === KPI Resumen (Semanal) ‚Äî limpio y autocontenido ===
(function(){
  const $  = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

  function ST(){ return (window.STATE||window.__STATE||{}); }
  function getCalendario(){ const st=ST(); return Array.isArray(st.calendario)? st.calendario : (Array.isArray(st.Calendario)? st.Calendario : []); }
  function getCalls(){ const st=ST(); return Array.isArray(st.calls)? st.calls : (Array.isArray(st.Calls)? st.Calls : []); }

  function get(obj, keys){
    for(const k of keys){ if(obj && obj[k]!=null && obj[k]!=='') return obj[k]; }
    const flat={}; for(const k in obj){ flat[k.toLowerCase().replace(/\s|_/g,'')]=obj[k]; }
    for(const k of keys){ const nk=k.toLowerCase().replace(/\s|_/g,''); if(flat[nk]!=null && flat[nk]!=='') return flat[nk]; }
    return '';
  }
  function norm(s){ return (s??'').toString().trim(); }
  function toDate(x){
    if(!x) return null;
    try{
      const d=new Date(x); if(!isNaN(d)) return d;
      const s=String(x).trim();
      const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
      if(m){ const dd=+m[1], mm=+m[2]-1, yy=+m[3]<100?2000+(+m[3]):+m[3], hh=m[4]?+m[4]:0, mi=m[5]?+m[5]:0; return new Date(yy,mm,dd,hh,mi); }
    }catch(e){}
    return null;
  }
  function mapWeek(w){
    const n = parseInt(String(w).replace(/\D/g,''), 10);
    if(!isFinite(n)) return String(w||'');
    if(n<=4 && n>0) return String(n);
    if(n>4) return String(((n-1)%4)+1);
    return String(w||'');
  }
  function csvEscape(v){ const s=String(v??''); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s; }

  function uniqueSorted(arr){
    return Array.from(new Set(arr.filter(x=>x!=null && x!=='')))
      .sort((a,b)=>{
        const na=Number(a), nb=Number(b);
        if(isFinite(na)&&isFinite(nb)) return na-nb;
        return String(a).localeCompare(String(b),'es',{numeric:true});
      });
  }

  function fillResumenFilters(){
    const cal = getCalendario().map(r=>({
      semana: mapWeek(get(r, ['N Semana','Semana','SEMANA','semana','NSemana','N_Semana'])),
      vendedor: norm(get(r,['Vendedor','VENDEDOR','vendedor'])),
      gestor: norm(get(r,['gestor_servicio','Gestor','GESTOR_SERVICIO']))
    }));
    const calls = getCalls().map(r=>({
      semana: String(r.semana||''),
      vendedor: norm(r.vendedor||''),
      gestor: norm(r.gestor||r.gestor_servicio||'')
    }));
    const semanas = uniqueSorted([...(cal.map(x=>x.semana).filter(Boolean)), ...(calls.map(x=>x.semana).filter(Boolean))]);
    const vendedores = uniqueSorted([...(cal.map(x=>x.vendedor)), ...(calls.map(x=>x.vendedor))]);
    const gestores = uniqueSorted([...(cal.map(x=>x.gestor)), ...(calls.map(x=>x.gestor))]);

    const selW = $('#rwSemana'); if(selW && selW.children.length<=1){ selW.innerHTML = '<option value=\"\">Todas</option>'+ (semanas.length? semanas: ['1','2','3','4']).map(v=>`<option>${v}</option>`).join(''); }
    const selV = $('#rwVendedor'); if(selV && selV.children.length<=1){ selV.innerHTML = '<option value=\"\">Todos</option>'+ vendedores.map(v=>`<option>${v}</option>`).join(''); }
    const selG = $('#rwGestor'); if(selG && selG.children.length<=1){ selG.innerHTML = '<option value=\"\">Todos</option>'+ gestores.map(v=>`<option>${v}</option>`).join(''); }
  }

  
function computeResumenAggregates(){
  // Filtros
  const fSem = document.getElementById('rwSemana')?.value || '';
  const fVend = (document.getElementById('rwVendedor')?.value || '').toString().trim().toLowerCase();
  const fGest = (document.getElementById('rwGestor')?.value || '').toString().trim().toLowerCase();

  // Normalizadores
  const N = s => (s==null?'':String(s)).trim();
  const L = s => N(s).toLowerCase();
  const W = s => {
    const t=N(s);
    // if already 1..4 just return
    if(['1','2','3','4'].includes(t)) return t;
    // fallback: derive from ISO date yyyy-mm-dd
    const m = t.match(/(\d{4})-(\d{2})-(\d{2})/);
    if(m){ const d=parseInt(m[3],10); return d<=7?'1':d<=14?'2':d<=21?'3':'4'; }
    return '';
  };

  // Datos
  const calRaw = (window.ST?.().calendario || window.ST?.().Calendario || []);
  const callsRaw = (window.ST?.().calls || window.ST?.().Calls || []);

  // PLAN (itinerario): contar filas de Calendario con Condicion="En Ruta"
  // Campos tolerantes a may√∫sculas. Semana se toma del campo "SEMANA" (1-4)
  const cal = calRaw.map(r => ({
    semana: W(r['SEMANA'] ?? r['Semana'] ?? r['N Semana'] ?? r['N_Semana'] ?? r['semana']),
    vendedor: L(r['vendedor'] ?? r['Vendedor'] ?? r['VENDEDOR']),
    gestor: L(r['gestor_servicio'] ?? r['Gestor'] ?? r['GESTOR_SERVICIO']),
    condicion: L(r['Condicion'] ?? r['CONDICION'] ?? r['condicion']),
    cod: N(r['Cod Empresa'] ?? r['COD EMPRESA'] ?? r['cod'] ?? r['Cod'])
  })).filter(r => r.condicion === 'en ruta');  // solo "En Ruta"

  // DONE (llamadas): desde Reporte
  const calls = callsRaw.map(r => ({
    semana: W(r['semana'] ?? r['N¬∞ Semana'] ?? r['N Semana'] ?? r['Semana'] ?? r['fecha/hora'] ?? r['Fecha/Hora']),
    vendedor: L(r['vendedor'] ?? r['Vendedor'] ?? r['VENDEDOR']),
    gestor: L(r['gestor'] ?? r['gestor_servicio'] ?? r['Gestor'] ?? r['GESTOR_SERVICIO']),
    fecha: N(r['fecha/hora'] ?? r['Fecha/Hora'] ?? r['Fecha'] ?? r['datetime']),
  }));

  // Determinar conjunto de gestores (seg√∫n filtro)
  const gestores = Array.from(new Set(cal.map(r=>r.gestor).filter(Boolean).concat(calls.map(r=>r.gestor).filter(Boolean))))
    .filter(g => !fGest || g===fGest);

  // Armar siempre las 4 semanas
  const semanasBase = ['1','2','3','4'];
  const rows = [];

  gestores.forEach(gest => {
    semanasBase.forEach(sem => {
      if(fSem && sem !== fSem) return;

      // aplicar filtro vendedor opcional
      const predVend = (v) => !fVend || v===fVend;

      const plan = cal.filter(r => r.gestor===gest && r.semana===sem && predVend(r.vendedor)).length;

      const done = calls.filter(r => r.gestor===gest && r.semana===sem && predVend(r.vendedor)).length;

      // √∫ltima llamada del par gestor/semana (si existe)
      const last = calls.filter(r => r.gestor===gest && r.semana===sem && predVend(r.vendedor))
                        .map(r => r.fecha).sort().slice(-1)[0] || '';

      const cov = plan>0 ? Math.round((done/plan)*100) : 0;
      rows.push({ gestor: gest.toUpperCase(), semana: sem, plan, done, cov, last });
    });
  });

  // Ordenar por gestor y semana asc
  rows.sort((a,b)=> (a.gestor.localeCompare(b.gestor) || (parseInt(a.semana)-parseInt(b.semana))));

  // Totales
  const totalPlan = rows.reduce((a,r)=>a+r.plan,0);
  const totalDone = rows.reduce((a,r)=>a+r.done,0);
  const totalCov  = totalPlan>0 ? Math.round((totalDone/totalPlan)*100) : 0;

  return { rows, totalPlan, totalDone, totalCov };
}


  function renderResumenKpisAndChips(agg){
    const ids = {kpiPlan:agg.totalPlan, kpiDone:agg.totalDone, kpiCov:agg.totalCov+'%', rwPlan:agg.totalPlan, rwDone:agg.totalDone, rwCov:agg.totalCov+'%'};
    Object.entries(ids).forEach(([id,val])=>{ const el=$( '#'+id.replace(/^#/,'') ) || document.getElementById(id); if(el) el.textContent=String(val); });
    const info = $('#rwInfo'); if(info){
      const s=$('#rwSemana')?.value||'Todas', v=$('#rwVendedor')?.value||'Todos', g=$('#rwGestor')?.value||'Todos';
      info.textContent=`Semana: ${s||'Todas'} ¬∑ Vendedor: ${v||'Todos'} ¬∑ Gestor: ${g||'Todos'}`;
    }
  }
  function renderResumenTable(agg){
    const tb = $('#rwTbl')?.querySelector('tbody');
    if(!tb) return;
    tb.innerHTML='';
    const frag=document.createDocumentFragment();
    agg.rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.gestor}</td><td>${r.semana}</td><td>${r.plan}</td><td>${r.done}</td><td>${r.cov}%</td><td>${r.last}</td>`;
      frag.appendChild(tr);
    });
    tb.appendChild(frag);
  }

  function exportResumenCSV(agg){
    const lines = [['Gestor','Semana','A realizar','Realizadas','% Cobertura','√öltima llamada']]
      .concat(agg.rows.map(r=>[r.gestor,r.semana,r.plan,r.done,`${r.cov}%`,r.last]));
    const csv = lines.map(row=>row.map(csvEscape).join(',')).join('\\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='resumen_semanal.csv'; a.click(); URL.revokeObjectURL(url);
  }

  function recomputeResumen(){ fillResumenFilters(); const agg=computeResumenAggregates(); renderResumenKpisAndChips(agg); renderResumenTable(agg); return agg; }

  function wire(){
    // Recompute on filter changes
    ['rwSemana','rwVendedor','rwGestor'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('change', ()=>recomputeResumen());
    });
    // Export
    const exp=document.getElementById('rwExport'); if(exp) exp.addEventListener('click', ()=>{ const agg=recomputeResumen(); exportResumenCSV(agg); });
    // When overlay visible (body.show-resumen), recompute
    const obs = new MutationObserver(()=>{ if(document.body.classList.contains('show-resumen')) setTimeout(recomputeResumen,30); });
    obs.observe(document.body,{attributes:true,attributeFilter:['class']});
    // Safe initial compute
    document.addEventListener('DOMContentLoaded', ()=> setTimeout(()=>{ if(document.body.classList.contains('show-resumen') || document.getElementById('screenResumenSem')?.style.display!=='none'){ recomputeResumen(); } }, 80));
  }

  try{ wire(); }catch(e){ console.warn('KPI resumen clean wire err', e); }
})();
</script>


<!-- ======= INTEGRACI√ìN KPI SEMANAL ======= -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  /* Overlay */
  #rsOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);display:none;align-items:flex-start;justify-content:center;overflow:auto;z-index:9999}
  #rsPanel{margin:28px 10px;width:1200px;max-width:95vw}
  .rs-card{background:#fff;border-radius:14px;box-shadow:0 10px 24px rgba(2,6,23,.08);padding:14px}
  .rs-muted{color:#64748b}
  .rs-title{font-size:18px;font-weight:800}
  .rs-grid{display:grid;gap:10px}
  @media(min-width:900px){ .rs-grid.cols-4{grid-template-columns:repeat(4,1fr)} .rs-grid.cols-3{grid-template-columns:repeat(3,1fr)} }
  .rs-pill{display:inline-flex;align-items:center;gap:6px;background:#e2e8f0;border-radius:999px;padding:6px 10px;font-size:12px}
  .rs-kpi{font-size:30px;font-weight:900}
  .rs-tab{padding:6px 10px;border-radius:8px;background:#e2e8f0}
  .rs-tab.active{background:#2563eb;color:#fff}
  table.rs-table{width:100%;border-collapse:collapse}
  table.rs-table th, table.rs-table td{padding:10px;border-bottom:1px solid #eef2f7;font-size:14px;text-align:left}
  table.rs-table th{font-size:12px;letter-spacing:.02em;text-transform:uppercase;color:#64748b}
</style>

<div id="rsOverlay">
  <div id="rsPanel">
    <div class="rs-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="rs-title">üìû Reporte de llamadas ‚Äî <span class="rs-muted">Resumen (Semanal)</span></div>
        <div style="display:flex;gap:6px">
          <span id="rsChips" class="rs-muted" style="align-self:center;font-size:12px"></span><span id="rsDiag" class="rs-muted" style="align-self:center;font-size:12px;margin-left:8px;"></span>
          <button id="rsExport" class="rs-pill">Exportar Excel</button>
          <button id="rsClose" class="rs-pill">Cerrar</button>
        </div>
      </div>

      <div class="rs-grid cols-4" style="margin-top:10px">
        <div class="rs-card">
          <div class="rs-muted" style="font-size:12px">Semana</div>
          <select id="rsSemana" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:10px">
            <option value="Todas">Todas</option>
            <option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </div>
        <div class="rs-card">
          <div class="rs-muted" style="font-size:12px">Vendedor</div>
          <select id="rsVendSel" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:10px"></select>
        </div>
        <div class="rs-card">
          <div class="rs-muted" style="font-size:12px">Gestor</div>
          <select id="rsGestSel" style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:10px"></select>
        </div>
        <div class="rs-card">
          <div class="rs-muted" style="font-size:12px">Acciones</div>
          <div style="display:flex;gap:8px">
            <button id="rsSync" class="rs-pill">Sincronizar</button>
          </div>
        </div>
      </div>

      <div class="rs-grid cols-3" style="margin-top:10px">
        <div class="rs-card"><div class="rs-muted">A realizar (itinerarios)</div><div id="rsK1" class="rs-kpi">0</div></div>
        <div class="rs-card"><div class="rs-muted">Realizadas (llamadas)</div><div id="rsK2" class="rs-kpi">0</div></div>
        <div class="rs-card"><div class="rs-muted">% Cobertura</div><div id="rsK3" class="rs-kpi">0%</div></div>
      </div>

      <div class="rs-card" style="margin-top:10px">
        <div style="display:flex;gap:8px"><button id="rsTabPend" class="rs-tab active">Pendientes (Agenda)</button><button id="rsTabReal" class="rs-tab">Realizadas (Historial)</button></div>
        <div style="overflow:auto;margin-top:10px">
          <table class="rs-table" id="rsTblDet">
            <thead><tr>
              <th>Cod Empresa</th><th>Cliente</th><th>Semana</th><th>D√≠a</th><th>Vendedor</th><th>Gestor</th><th style="text-align:right">A realizar</th>
            </tr></thead>
            <tbody id="rsTbdDet"><tr><td colspan="7" style="text-align:center;color:#64748b">Cargando‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="rs-card" style="margin-top:10px">
        <div style="overflow:auto">
          <table class="rs-table" id="rsTblRes">
            <thead><tr>
              <th>Gestor</th><th>Semana</th><th style="text-align:right">A realizar</th><th style="text-align:right">Realizadas</th><th style="text-align:right">% Cobertura</th><th style="text-align:right">√öltima llamada</th>
            </tr></thead>
            <tbody id="rsTbdRes"><tr><td colspan="6" style="text-align:center;color:#64748b">Cargando‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Auto-config login: modo cloud + usuarios ===== */
try{
  localStorage.setItem('cfg.mode','cloud');
  localStorage.setItem('cfg.users','https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv');
}catch(e){}

/* ===== Helpers ===== */
const RS_AGENDA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv"; // Calendario
const RS_norm = s => (s??"").toString().trim();
const RS_acc  = s => RS_norm(s).normalize('NFD').replace(/\\p{Diacritic}/gu,'').toLowerCase();
function RS_parseCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{download:true,header:true,skipEmptyLines:true,
      complete:(r)=>resolve(r.data.map(x=>Object.fromEntries(Object.entries(x).map(([k,v])=>[k.trim(), typeof v==='string'? v.trim(): v])))),
      error:reject});
  });
}
function RS_getSemana(r){
  const ks=["SEMANA","N¬∞ Semana","N Semana","Semana","N_Semana"];
  for(const k of ks){ if(r[k]!==undefined && RS_norm(r[k])!==""){ const n=parseInt(r[k],10); return isNaN(n)? RS_norm(r[k]): String(n);} }
  return "";
}
function RS_weekFromDate(s){
  if(!s) return "";
  const m = (s.match(/(\\d{4})-(\\d{2})-(\\d{2})/)||[]);
  if(m.length<4) return "";
  const d = parseInt(m[3],10);
  if(d<=7) return "1"; if(d<=14) return "2"; if(d<=21) return "3"; return "4";
}

/* ===== Estado ===== */
let RS_agenda=[], RS_hist=[], RS_tab='pend', RS_vendorSel='(todos)', RS_gestorSel='(todos)';

/* ===== Leer Reporte (tabla y filtros) ===== */
function RS_enhanceReporteOnce(){
  // Agrega bot√≥n "Resumen (Semanal)" y columna "N¬∞ Semana", y convierte filtros a selects
  const modal = document.querySelector('[role="dialog"], .modal');
  if(!modal) return false;

  // Bot√≥n Resumen si no existe
  if(!modal.querySelector('#btnReporteResumen')){
    const toolbar = modal.querySelector('button, .toolbar')?.parentElement || modal;
    const btn = document.createElement('button'); btn.id='btnReporteResumen'; btn.textContent='Reporte (Resumen)';
    btn.className='btn btn-secondary'; btn.style.marginLeft='8px';
    if(toolbar.firstElementChild) toolbar.insertBefore(btn, toolbar.firstElementChild.nextSibling);
    btn.addEventListener('click', ()=>{
      document.getElementById('rsOverlay').style.display='flex';
      RS_bootResumen();
    });
  }

  const table = modal.querySelector('table'); if(!table) return true;
  const thead = table.tHead, tbody = table.tBodies[0]; if(!thead||!tbody) return true;

  // √çndices
  const headers = Array.from(thead.querySelectorAll('th')).map(th => (th.textContent||'').trim().toLowerCase());
  const idx = { fecha: headers.indexOf('fecha/hora'), vendedor: headers.indexOf('vendedor'), gestor: headers.indexOf('gestor') };

  // Columna N¬∞ Semana
  if(!headers.some(h=>h.includes('semana'))){
    const th = document.createElement('th'); th.textContent='N¬∞ Semana';
    if(idx.gestor>=0){ thead.rows[0].insertBefore(th, thead.rows[0].children[idx.gestor+1]||null); } else { thead.rows[0].appendChild(th); }
    for(const tr of Array.from(tbody.rows)){
      const td = document.createElement('td');
      const s = idx.fecha>=0? (tr.children[idx.fecha]?.textContent||'').trim() : '';
      td.textContent = RS_weekFromDate(s);
      if(idx.gestor>=0){ tr.insertBefore(td, tr.children[idx.gestor+1]||null);} else { tr.appendChild(td);}
    }
  }

  // Convertir Gestor/Vendedor a selects con valores de la tabla
  const vendVals = idx.vendedor>=0? Array.from(tbody.rows).map(r => RS_norm(r.children[idx.vendedor]?.textContent)).filter(Boolean) : [];
  const gestVals = idx.gestor>=0?   Array.from(tbody.rows).map(r => RS_norm(r.children[idx.gestor]?.textContent)).filter(Boolean) : [];

  function toSelect(inputLike, options){
    if(!inputLike) return null;
    if(inputLike.tagName?.toLowerCase()==='select'){ inputLike.innerHTML=''; }
    let sel = inputLike;
    if(inputLike.tagName?.toLowerCase()!=='select'){
      sel = document.createElement('select');
      sel.className = inputLike.className; sel.style.cssText = inputLike.style.cssText; sel.id = inputLike.id; sel.name = inputLike.name;
      inputLike.replaceWith(sel);
    }
    const uniq = Array.from(new Set(['(todos)', ...options.sort()]));
    sel.innerHTML = uniq.map(v=>`<option>${v}</option>`).join('');
    return sel;
  }

  // Encontrar controles por el label anterior
  const vendControl = Array.from(modal.querySelectorAll('label')).find(l => (l.textContent||'').toLowerCase().includes('vendedor'));
  const gestControl = Array.from(modal.querySelectorAll('label')).find(l => (l.textContent||'').toLowerCase().includes('gestor'));
  const vendInput = vendControl ? vendControl.parentElement.querySelector('input,select') : null;
  const gestInput = gestControl ? gestControl.parentElement.querySelector('input,select') : null;

  const vendSel = toSelect(vendInput, vendVals);
  const gestSel = toSelect(gestInput, gestVals);

  function apply(){
    RS_vendorSel = RS_norm(vendSel?.value || '(todos)');
    RS_gestorSel = RS_norm(gestSel?.value || '(todos)');
    // Aplicar en la tabla del reporte (ocultar filas que no aplican)
    const vnorm = RS_acc(RS_vendorSel), gnorm = RS_acc(RS_gestorSel);
    for(const tr of Array.from(tbody.rows)){
      const vt = idx.vendedor>=0? RS_acc(tr.children[idx.vendedor]?.textContent):'';
      const gt = idx.gestor>=0? RS_acc(tr.children[idx.gestor]?.textContent):'';
      const okV = (RS_vendorSel==='(todos)') || (vt===vnorm);
      const okG = (RS_gestorSel==='(todos)') || (gt===gnorm);
      tr.style.display = (okV && okG)? '' : 'none';
    }
  }
  vendSel && (vendSel.onchange = apply);
  gestSel && (gestSel.onchange = apply);
  apply();
  return true;
}

function RS_readReporte(){
  const modal = document.querySelector('[role="dialog"], .modal');
  const table = modal ? modal.querySelector('table') : null;
  const thead = table ? table.tHead : null;
  const tbody = table ? table.tBodies[0] : null;
  if(!thead || !tbody){ RS_hist=[]; return; }

  const headers = Array.from(thead.querySelectorAll('th')).map(th => (th.textContent||'').trim().toLowerCase());
  const idx = { fecha: headers.indexOf('fecha/hora'), cliente: headers.indexOf('cliente'), cod: headers.indexOf('cod'), vendedor: headers.indexOf('vendedor'), gestor: headers.indexOf('gestor'), semana: headers.findIndex(h=>h.includes('semana')) };

  RS_hist = [];
  for(const tr of Array.from(tbody.rows)){
    if(tr.style.display==='none') continue;
    const h = {
      cod: RS_norm(idx.cod>=0 ? tr.children[idx.cod]?.textContent : ""),
      cliente: RS_norm(idx.cliente>=0 ? tr.children[idx.cliente]?.textContent : ""),
      vendedor: RS_norm(idx.vendedor>=0 ? tr.children[idx.vendedor]?.textContent : ""),
      gestor: RS_norm(idx.gestor>=0 ? tr.children[idx.gestor]?.textContent : ""),
      fecha: RS_norm(idx.fecha>=0 ? tr.children[idx.fecha]?.textContent : ""),
      semana: idx.semana>=0 ? RS_norm(tr.children[idx.semana]?.textContent) : RS_weekFromDate(RS_norm(idx.fecha>=0 ? tr.children[idx.fecha]?.textContent : ""))
    };
    h.vendedor_norm = RS_acc(h.vendedor); h.gestor_norm = RS_acc(h.gestor);
    RS_hist.push(h);
  }

  document.getElementById('rsVendTag').textContent = RS_vendorSel || '(todos)';
  document.getElementById('rsGestTag').textContent = RS_gestorSel || '(todos)';
}

async function RS_loadAgenda(){
  const ag = await RS_parseCSV(RS_AGENDA_URL);
  RS_agenda = ag.map(r=>({
    cod: RS_norm(r["Cod Empresa"] ?? r["Cod"] ?? r["codigo"] ?? r["codigo_empresa"]),
    cliente: RS_norm(r["RazonSocial"] ?? r["Cliente"]),
    semana: String(RS_getSemana(r)||""),
    dia: RS_norm(r["DIA"] ?? r["D√≠a"] ?? r["Dia"]),
    vendedor: RS_norm(r["vendedor"] ?? r["Vendedor"]),
    gestor: RS_norm(r["gestor_servicio"] ?? r["Gestor"]),
    condicion: RS_norm(r["Condicion"] ?? r["Condici√≥n"] ?? r["CONDICION"]),
    vendedor_norm: RS_acc(r["vendedor"] ?? r["Vendedor"]),
    gestor_norm: RS_acc(r["gestor_servicio"] ?? r["Gestor"]),
    condicion_norm: RS_acc(r["Condicion"] ?? r["Condici√≥n"] ?? r["CONDICION"]),
  })).filter(r=>r.cod);
}

function RS_filters(){ return {semana: document.getElementById('rsSemana').value}; }
function RS_applyAgenda(rows){
  const {semana} = RS_filters();
  const gest = RS_acc(RS_gestorSel);
  return rows.filter(r=>{
    if(semana!=="Todas" && String(r.semana)!==String(semana)) return false;
    // Ignoramos Vendedor para el plan (A realizar)
    if(RS_gestorSel!="(todos)" && r.gestor_norm!==gest) return false;
    return true;
  });
}
function RS_applyHist(rows){
  const {semana} = RS_filters();
  const vend = RS_acc(RS_vendorSel), gest = RS_acc(RS_gestorSel);
  return rows.filter(r=>{
    if(semana!=="Todas" && String(r.semana)!==String(semana)) return false;
    if(RS_vendorSel!=="(todos)" && r.vendedor_norm!==vend) return false;
    if(RS_gestorSel!=="(todos)" && r.gestor_norm!==gest) return false;
    return true;
  });
}

function RS_render(){
  const diagTotal = RS_agenda.length; const agendaRuta = RS_agenda.filter(a=>a.condicion_norm.includes('ruta'));
  const agendaF = RS_applyAgenda(agendaRuta);
  // Dedup A realizar por Cod+Semana
  const seen = new Set(); const plan = [];
  for(const a of agendaF){ const k = `${a.cod}__${a.semana}`; if(!seen.has(k)){ seen.add(k); plan.push(a);} }
  const hechas = RS_applyHist(RS_hist);

  document.getElementById('rsChips').textContent = `Plan: ${plan.length} filas ‚Ä¢ Llamadas: ${hechas.length}`;
  document.getElementById('rsDiag').textContent = `(Calendario: ${diagTotal} ‚Ä¢ En Ruta: ${agendaRuta.length} ‚Ä¢ Post-filtros: ${agendaF.length})`;

  // KPIs
  const k1 = plan.length, k2 = hechas.length, k3 = k1>0? Math.round(k2*100/k1):0;
  document.getElementById('rsK1').textContent = k1.toLocaleString();
  document.getElementById('rsK2').textContent = k2.toLocaleString();
  document.getElementById('rsK3').textContent = k3 + '%';

  // Detalle
  const key = r => `${r.cod}__${r.semana}`;
  const mapHechas = new Map(hechas.map(r=>[key(r),r]));
  const pendientes = plan.filter(a=>!mapHechas.has(key(a)));
  const curTab = document.getElementById('rsTabPend').classList.contains('active') ? 'pend' : 'real';
  const rows = curTab==='pend' ? pendientes : hechas.map(r=>({cod:r.cod,cliente:r.cliente,semana:r.semana,dia:'',vendedor:r.vendedor,gestor:r.gestor,fecha:r.fecha}));
  document.getElementById('rsTbdDet').innerHTML = rows.length? rows.map(r=>`
    <tr><td>${r.cod}</td><td>${r.cliente||''}</td><td>${r.semana||''}</td><td>${r.dia||''}</td><td>${r.vendedor||''}</td><td>${r.gestor||''}</td><td style="text-align:right">${curTab==='pend'?1:0}</td></tr>`).join('')
    : `<tr><td colspan="7" style="text-align:center;color:#64748b">Sin datos</td></tr>`;

  // Resumen inferior (siempre mostrar semanas 1..4)
  // Determinar gestors a mostrar
  const gestors = (function(){
    if(RS_gestorSel && RS_gestorSel !== '(todos)') return [RS_gestorSel];
    const gFromAgenda = Array.from(new Set(plan.map(r=>r.gestor).filter(Boolean)));
    const gFromHist   = Array.from(new Set(hechas.map(r=>r.gestor).filter(Boolean)));
    const all = Array.from(new Set([...gFromAgenda, ...gFromHist]));
    return all.length? all : ['(sin)'];
  })();
  const weeks = ['1','2','3','4'];

  const map = new Map();
  // Presembrar 1..4 por gestor
  for(const g of gestors){
    for(const w of weeks){
      const k = `${g}__${w}`;
      if(!map.has(k)) map.set(k,{gestor:g, semana:w, plan:0, done:0, last:null});
    }
  }
  function add(x,isPlan){
    const g = x.gestor || '(sin)';
    const w = String(x.semana || '');
    if(!w) return;
    const k = `${g}__${w}`;
    if(!map.has(k)) map.set(k,{gestor:g, semana:w, plan:0, done:0, last:null});
    const obj = map.get(k);
    if(isPlan) obj.plan++; else obj.done++;
    if(x.fecha){ if(!obj.last || x.fecha>obj.last) obj.last = x.fecha; }
  }
  for(const a of plan) add(a,true);
  for(const h of hechas) add(h,false);

  const arr = Array.from(map.values()).sort((a,b)=> a.gestor===b.gestor? String(a.semana).localeCompare(String(b.semana)) : a.gestor.localeCompare(b.gestor));
  document.getElementById('rsTbdRes').innerHTML = arr.length? arr.map(r=>{
    const cov = r.plan>0? Math.round(r.done*100/r.plan):0;
    return `<tr><td>${r.gestor}</td><td>${r.semana}</td><td style="text-align:right">${r.plan}</td><td style="text-align:right">${r.done}</td><td style="text-align:right">${cov}%</td><td style="text-align:right">${r.last||'-'}</td></tr>`;
  }).join('') : `<tr><td colspan="6" style="text-align:center;color:#64748b">Sin datos</td></tr>`;
}

/* ===== Boot ===== */
async function RS_bootResumen(){
  // Lee filtros/tabla del Reporte
  RS_enhanceReporteOnce();
  RS_readReporte();
  // Carga calendario
  if(RS_agenda.length===0) await RS_loadAgenda();
  RS_populateVG();
  // Render
  RS_render();
}

(function observeModal(){
  // Observa para enganchar mejoras del Reporte autom√°ticamente
  const obs = new MutationObserver(()=>{ RS_enhanceReporteOnce(); });
  obs.observe(document.documentElement,{childList:true,subtree:true});
})();


// Populate Vendedor/Gestor selects using Calendario values and default to Reporte's selection
function RS_populateVG(){
  const vendSel = document.getElementById('rsVendSel');
  const gestSel = document.getElementById('rsGestSel');

  const vVals = Array.from(new Set(RS_agenda.map(r=>r.vendedor).filter(Boolean))).sort();
  const gVals = Array.from(new Set(RS_agenda.map(r=>r.gestor).filter(Boolean))).sort();

  vendSel.innerHTML = ['(todos)', ...vVals].map(v=>`<option>${v}</option>`).join('');
  gestSel.innerHTML = ['(todos)', ...gVals].map(v=>`<option>${v}</option>`).join('');

  // defaults from Reporte (if available)
  if(RS_vendorSel && vVals.includes(RS_vendorSel)) vendSel.value = RS_vendorSel; else vendSel.value='(todos)';
  if(RS_gestorSel && gVals.includes(RS_gestorSel)) gestSel.value = RS_gestorSel; else gestSel.value='(todos)';

  vendSel.onchange = ()=>{ RS_vendorSel = vendSel.value; RS_render(); };
  gestSel.onchange = ()=>{ RS_gestorSel = gestSel.value; RS_render(); };
}

// Eventos overlay
document.getElementById('rsClose').onclick = ()=>{ document.getElementById('rsOverlay').style.display='none'; };
document.getElementById('rsExport').onclick = ()=>{
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById('rsTblDet')), 'Detalle');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.table_to_sheet(document.getElementById('rsTblRes')), 'Resumen');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['KPI','Valor'],
    ['A realizar (itinerarios)', document.getElementById('rsK1').textContent],
    ['Realizadas (llamadas)', document.getElementById('rsK2').textContent],
    ['% Cobertura', document.getElementById('rsK3').textContent],
  ]), 'KPIs');
  XLSX.writeFile(wb, 'reporte_llamadas_resumen.xlsx');
};
document.getElementById('rsSemana').onchange = RS_render;
document.getElementById('rsTabPend').onclick = (e)=>{ e.target.classList.add('active'); document.getElementById('rsTabReal').classList.remove('active'); RS_render(); };
document.getElementById('rsTabReal').onclick = (e)=>{ e.target.classList.add('active'); document.getElementById('rsTabPend').classList.remove('active'); RS_render(); };
</script>


<script>
// Mostrar banner de estado (carga de Usuarios y Calendario) para entornos como GitHub Pages
(function statusBanner(){
  const bar = document.createElement('div');
  bar.id = 'rsStatus';
  bar.style.cssText = 'position:fixed;right:10px;bottom:10px;background:#111827;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;opacity:.9;z-index:99999';
  bar.textContent = 'Iniciando‚Ä¶';
  document.body.appendChild(bar);
  function set(t){ if(bar) bar.textContent = t; }
  window.__setRSStatus = set;

  // Pre-flight: intenta leer hoja de USUARIOS; si falla (CORS/red), habilita DEMO autom√°ticamente
  const usersUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv';
  fetch(usersUrl, {mode:'cors'})
    .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
    .then(()=>{ localStorage.setItem('cfg.mode','cloud'); localStorage.setItem('cfg.users',usersUrl); set('Usuarios: online ‚Ä¢ modo cloud'); 
      setTimeout(()=>{ bar.remove(); }, 2500);
    })
    .catch(()=>{
      // fallback demo
      localStorage.setItem('cfg.mode','local');
      set('No se pudo cargar Usuarios ‚Üí modo demo'); 
      setTimeout(()=>{ bar.remove(); }, 3500);
    });
})();
</script>


<script>
// === GW PATCH: Reporte ‚Üí agregar N Semana y exportar a Excel ===
(function(){
  // Botones extra
  function ensureExcelButtons(){
    const csvBtn = document.getElementById('repExport');
    if(csvBtn && !document.getElementById('repExportXLSX')){
      const xbtn = document.createElement('button');
      xbtn.id = 'repExportXLSX';
      xbtn.className = 'btn';
      xbtn.textContent = '‚¨á Exportar Excel';
      csvBtn.parentElement.appendChild(xbtn);
      xbtn.addEventListener('click', exportReporteXLSX);
    }
    // Forzar que "Exportar Resumen" sea Excel
    const sumBtn = document.getElementById('repSumExport');
    if(sumBtn && !sumBtn.__patched){
      sumBtn.__patched = true;
      sumBtn.addEventListener('click', function(ev){
        ev.preventDefault();
        exportResumenXLSX();
      }, {capture:true});
    }
  }

  // Guardamos las filas del detalle para exportaci√≥n
  window.__repRows__ = [];

  // Re-implementamos renderReporte para incluir N Semana
  const _old_repFilters = window.repFilters;
  const _norm = window.norm || (s=>String(s||'').toLowerCase().trim());
  function parseDateTime(s){ try{ return s ? new Date(s) : null; } catch(_){ return null; } }

  window.renderReporte = function(){
    try{
      ensureExcelButtons();
      const all = (window.loadAllCallRecords ? window.loadAllCallRecords() : []);
      const F = _old_repFilters ? _old_repFilters() : {desde:'',hasta:'',vend:'',gest:'',res:''};
      const ds = F.desde ? new Date(F.desde+'T00:00:00') : null;
      const hs = F.hasta ? new Date(F.hasta+'T23:59:59') : null;
      const vend = _norm(F.vend||''), gest = _norm(F.gest||''), res = F.res || '';

      const rows = all.filter(r=>{
        let ok = true;
        const d = parseDateTime(r.fecha_hora);
        if(ds && d && d < ds) ok = false;
        if(hs && d && d > hs) ok = false;
        if(vend && _norm(r.vendedor) !== vend) ok = false;
        if(gest && _norm(r.gestor_servicio) !== gest) ok = false;
        if(res && String(r.resultado) !== String(res)) ok = false;
        return ok;
      });

      // Asegurar TH 'N Semana' en tabla detalle
      const thead = document.querySelector('#repTbl thead tr');
      if(thead && ![...thead.children].some(th => /n\s*semana/i.test(th.textContent))){
        const th = document.createElement('th'); th.textContent = 'N Semana';
        // Insertar despu√©s de 'Cod'
        const heads = [...thead.children].map(th=>th.textContent.trim().toLowerCase());
        const idxCod = heads.indexOf('cod');
        if(idxCod>-1 && thead.children[idxCod]){
          thead.insertBefore(th, thead.children[idxCod+1]);
        }else{
          thead.appendChild(th);
        }
      }

      const tb = document.querySelector('#repTbl tbody');
      if(tb){ tb.innerHTML = ''; }
      const out = [];
      rows.forEach(r=>{
        const cita = (r.cita_tipo && r.cita_tipo!=='sin_cita') ? (r.cita_tipo + ' ' + (r.cita_fecha||'') + (r.cita_hora? (' ' + r.cita_hora) : '')) : '';
        const row = {
          'Fecha/Hora': r.fecha_hora||'',
          'Cliente': r.cliente||'',
          'Cod': r.cod_empresa||'',
          'N Semana': r.semana||'',
          'Vendedor': r.vendedor||'',
          'Gestor': r.gestor_servicio||'',
          'Resultado': r.resultado||'',
          'Duraci√≥n': r.duracion_seg||'',
          'Obs': r.observaciones||'',
          'Provincia': r.provincia||'',
          'Tel1': r.telefono1||'',
          'Cel': r.celular||'',
          'Cita': cita,
          'Estatus cita': r.estatus_visita || ''
        };
        out.push(row);
        if(tb){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>'+row['Fecha/Hora']+'</td><td>'+row['Cliente']+'</td><td>'+row['Cod']+'</td><td>'+row['N Semana']+'</td>' +
                         '<td>'+row['Vendedor']+'</td><td>'+row['Gestor']+'</td><td>'+row['Resultado']+'</td>'+
                         '<td>'+row['Duraci√≥n']+'</td><td>'+row['Obs']+'</td><td>'+row['Provincia']+'</td>'+
                         '<td>'+row['Tel1']+'</td><td>'+row['Cel']+'</td><td>'+row['Cita']+'</td><td>'+row['Estatus cita']+'</td>';
          tb.appendChild(tr);
        }
      });
      window.__repRows__ = out;
    }catch(e){ console.error('renderReporte (patched) error', e); }
  };

  function toXLSX(rows, sheetName, fileName){
    try{
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, sheetName||'Datos');
      XLSX.writeFile(wb, fileName || ('reporte_'+new Date().toISOString().slice(0,10)+'.xlsx'));
    }catch(e){ console.error('XLSX export error', e); alert('No se pudo exportar a Excel'); }
  }

  function exportReporteXLSX(){
    const rows = window.__repRows__ || [];
    if(!rows.length){ alert('No hay filas en el detalle para exportar.'); return; }
    toXLSX(rows, 'Detalle', 'reporte_llamadas_detalle.xlsx');
  }
  window.exportReporteXLSX = exportReporteXLSX;

  function exportResumenXLSX(){
    try{
      const tb = document.querySelector('#repSumTbl');
      const thead = tb.querySelectorAll('thead th');
      const header = Array.from(thead).map(th => th.textContent.trim());
      const data = Array.from(tb.querySelectorAll('tbody tr')).map(tr => {
        const cells = Array.from(tr.children).map(td => td.textContent.trim());
        const obj = {}; header.forEach((h,i)=> obj[h] = cells[i] || ''); return obj;
      });
      if(!data.length){ alert('No hay filas en el resumen para exportar.'); return; }
      toXLSX(data, 'Resumen', 'reporte_llamadas_resumen.xlsx');
    }catch(e){ console.error(e); alert('No se pudo exportar el resumen'); }
  }
  window.exportResumenXLSX = exportResumenXLSX;

  document.addEventListener('DOMContentLoaded', ensureExcelButtons);
})();
</script>


<script>
// === GW PATCH: Vendedor/Gestor como listas desplegables funcionales en Reporte ===
(function(){
  function uniq(a){ return Array.from(new Set(a.filter(Boolean).map(s=> String(s).trim()))); }
  function buildSelectFromInput(id){
    const el = document.getElementById(id);
    if(!el) return null;
    let sel;
    if(el.tagName.toLowerCase()==='select'){ sel = el; sel.innerHTML = ''; }
    else{
      sel = document.createElement('select');
      sel.id = id;
      sel.className = el.className || '';
      el.parentElement.replaceChild(sel, el);
    }
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = '(todos)';
    sel.appendChild(opt);
    return sel;
  }
  function ensureRepDropdowns(){
    try{
      const all = (window.loadAllCallRecords ? window.loadAllCallRecords() : []);
      const vendList = uniq(all.map(r=> r.vendedor)).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
      const gestList = uniq(all.map(r=> r.gestor_servicio)).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));

      const sVend = buildSelectFromInput('repVendedor');
      const sGest = buildSelectFromInput('repGestor');

      if(sVend && !sVend.__filled){
        vendList.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sVend.appendChild(o); });
        sVend.__filled = true;
      }
      if(sGest && !sGest.__filled){
        gestList.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; sGest.appendChild(o); });
        sGest.__filled = true;
      }

      [sVend,sGest].forEach(el=> el && !el.__bound && (el.__bound=true, el.addEventListener('change', ()=>{
        try{ window.renderReporte && window.renderReporte(); }catch(e){}
      })));

    }catch(e){ console.error('rep dropdowns', e); }
  }

  // Llamar al abrir el reporte y al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', ensureRepDropdowns);
  const _openReporte = window.openReporte;
  window.openReporte = function(){ try{ ensureRepDropdowns(); }catch(_){ } if(_openReporte) return _openReporte(); };
})();
</script>


<script>
// === GW PATCH v2: Vendedor/Gestor desde Calendario (STATE.joined) ===
(function(){
  function uniq(a){ return Array.from(new Set(a.filter(Boolean).map(s=> String(s).trim()))); }
  function norm(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }

  function buildSelectFromInput(id){
    const el = document.getElementById(id);
    if(!el) return null;
    let sel;
    if(el.tagName.toLowerCase()==='select'){ sel = el; sel.innerHTML = ''; }
    else{
      sel = document.createElement('select');
      sel.id = id;
      sel.className = el.className || '';
      el.parentElement.replaceChild(sel, el);
    }
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = '(todos)';
    sel.appendChild(opt);
    return sel;
  }

  function valuesFromCalendario(){
    try{
      const joined = (window.STATE && Array.isArray(window.STATE.joined)) ? window.STATE.joined : [];
      const vend = uniq(joined.map(r=> r.vendedor).filter(v=>norm(v)!=='por asignar')).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
      const gest = uniq(joined.map(r=> r.gestor).filter(g=>norm(g)!=='por asignar')).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
      return {vend, gest};
    }catch(e){ console.error('vals cal', e); return {vend:[], gest:[]}; }
  }

  function ensureRepDropdownsFromCal(){
    const {vend, gest} = valuesFromCalendario();
    const sVend = buildSelectFromInput('repVendedor');
    const sGest = buildSelectFromInput('repGestor');
    if(sVend && !sVend.__filled){
      vend.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sVend.appendChild(o); });
      sVend.__filled = true;
    }
    if(sGest && !sGest.__filled){
      gest.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; sGest.appendChild(o); });
      sGest.__filled = true;
    }
    [sVend,sGest].forEach(el=> el && !el.__bound && (el.__bound=true, el.addEventListener('change', ()=>{
      try{ window.renderReporte && window.renderReporte(); }catch(e){}
    })));
  }

  // Llamar cuando ya est√© cargado STATE.joined
  const _openReporte = window.openReporte;
  window.openReporte = function(){ try{ ensureRepDropdownsFromCal(); }catch(_){ } if(_openReporte) return _openReporte(); };

  document.addEventListener('DOMContentLoaded', function(){
    // Si STATE ya est√°, rellenar; si no, esperar un poco
    if(window.STATE && Array.isArray(STATE.joined) && STATE.joined.length){
      ensureRepDropdownsFromCal();
    }else{
      setTimeout(ensureRepDropdownsFromCal, 800);
    }
  });
})();
</script>


<script>
// === GW PATCH v3: Dropdowns robustos (Calendario con fallback a llamadas) ===
(function(){
  function uniq(a){ return Array.from(new Set(a.filter(Boolean).map(s=> String(s).trim()))); }
  function norm(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }

  function ensureSelect(id){
    const el = document.getElementById(id);
    if(!el) return null;
    if(el.tagName.toLowerCase()==='select') return el;
    const sel = document.createElement('select');
    sel.id = id;
    sel.className = el.className || '';
    el.parentElement.replaceChild(sel, el);
    return sel;
  }
  function resetOptions(sel){
    if(!sel) return;
    sel.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = '(todos)';
    sel.appendChild(opt);
  }
  function getValuesFromCalendarOrCalls(){
    let vend = [], gest = [];
    try{
      const joined = (window.STATE && Array.isArray(STATE.joined)) ? STATE.joined : [];
      if(joined && joined.length){
        vend = uniq(joined.map(r=> r.vendedor).filter(v=> v && norm(v)!=='por asignar'))
               .sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
        gest = uniq(joined.map(r=> r.gestor).filter(g=> g && norm(g)!=='por asignar'))
               .sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
      }
      if((vend.length===0 || gest.length===0) && typeof window.loadAllCallRecords==='function'){
        const all = loadAllCallRecords();
        if(vend.length===0) vend = uniq(all.map(r=> r.vendedor)).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
        if(gest.length===0) gest = uniq(all.map(r=> r.gestor_servicio||r.gestor)).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
      }
    }catch(e){ console.error('getValuesFromCalendarOrCalls', e); }
    return {vend, gest};
  }
  function fillDropdowns(){
    const sVend = ensureSelect('repVendedor');
    const sGest = ensureSelect('repGestor');
    if(!sVend && !sGest) return;
    resetOptions(sVend); resetOptions(sGest);
    const {vend, gest} = getValuesFromCalendarOrCalls();
    vend.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sVend && sVend.appendChild(o); });
    gest.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; sGest && sGest.appendChild(o); });
    [sVend,sGest].forEach(el=> el && el.addEventListener('change', ()=>{ try{ window.renderReporte && window.renderReporte(); }catch(_){ } }));
  }

  // Re-llenar SIEMPRE al abrir el reporte (por si los datos llegaron tarde)
  const _openReporte = window.openReporte;
  window.openReporte = function(){ try{ fillDropdowns(); }catch(_){ } if(_openReporte) return _openReporte(); };

  // Y tambi√©n al cargar (con retry si a√∫n no hay STATE.joined)
  function tryFill(retries){
    fillDropdowns();
    if(retries>0 && (!window.STATE || !STATE.joined || STATE.joined.length===0)){
      setTimeout(()=>tryFill(retries-1), 400);
    }
  }
  document.addEventListener('DOMContentLoaded', ()=> tryFill(5));
})();
</script>


<script>
// === GW PATCH v4: Poblar selects dentro de renderReporte (calendario primero, fallback llamadas) ===
(function(){
  function uniq(a){ return Array.from(new Set(a.filter(Boolean).map(s=> String(s).trim()))); }
  function norm(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }

  function ensureSelect(id){
    const el = document.getElementById(id);
    if(!el) return null;
    if(el.tagName.toLowerCase()==='select') return el;
    const sel = document.createElement('select');
    sel.id = id;
    sel.className = el.className || '';
    el.parentElement.replaceChild(sel, el);
    return sel;
  }
  function resetAndFill(id, values){
    const sel = ensureSelect(id);
    if(!sel) return;
    const cur = sel.value;
    sel.innerHTML = '';
    const o0 = document.createElement('option'); o0.value=''; o0.textContent='(todos)'; sel.appendChild(o0);
    values.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    // restaurar si a√∫n existe
    if(values.includes(cur)) sel.value = cur;
  }
  function getValuesCalendario(){
    const joined = (window.STATE && Array.isArray(STATE.joined)) ? STATE.joined : [];
    const vend = uniq(joined.map(x=> x.vendedor).filter(v=> v && norm(v)!=='por asignar')).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
    const gest = uniq(joined.map(x=> x.gestor).filter(g=> g && norm(g)!=='por asignar')).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
    return {vend, gest};
  }
  function getValuesLlamadas(){
    try{
      const all = (typeof window.loadAllCallRecords==='function') ? loadAllCallRecords() : [];
      const vend = uniq(all.map(r=> r.vendedor)).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
      const gest = uniq(all.map(r=> r.gestor_servicio || r.gestor)).sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
      return {vend, gest};
    }catch(_){ return {vend:[], gest:[]}; }
  }
  function fillFromSources(){
    let {vend, gest} = getValuesCalendario();
    if(vend.length===0 || gest.length===0){
      const fb = getValuesLlamadas();
      if(vend.length===0) vend = fb.vend;
      if(gest.length===0) gest = fb.gest;
    }
    resetAndFill('repVendedor', vend);
    resetAndFill('repGestor', gest);
    ['repVendedor','repGestor'].forEach(id=>{
      const el = document.getElementById(id);
      if(el && !el.__bound){
        el.__bound = true;
        el.addEventListener('change', ()=> { try{ window.renderReporte && window.renderReporte(); }catch(_){} });
      }
    });
  }

  const _renderReporte = window.renderReporte;
  window.renderReporte = function(){
    fillFromSources();           // poblar selects antes de filtrar
    if(_renderReporte) _renderReporte();
    // por si se abre sin STATE listo, intenta de nuevo tras un peque√±o delay
    if(!window.STATE || !STATE.joined || STATE.joined.length===0){
      setTimeout(fillFromSources, 500);
    }
  };
})();
</script>


<script>
// === GW PATCH: N¬∞ Semana obligatorio + Cita (Tipo/Fecha/Hora) obligatorios ===
(function(){
  function setSemanaOptionsDefault() {
    var s = document.getElementById('callSemana');
    if(!s) return;
    // Re-crear opciones: Seleccionar, 1,2,3,4
    s.innerHTML = '';
    var opts = [
      {v:'', t:'Seleccionar'},
      {v:'1', t:'1'}, {v:'2', t:'2'}, {v:'3', t:'3'}, {v:'4', t:'4'}
    ];
    opts.forEach(function(o){
      var op = document.createElement('option');
      op.value = o.v; op.textContent = o.t;
      s.appendChild(op);
    });
    s.value = ''; // default
  }

  // Al abrir el modal, dejar "Seleccionar"
  var _openCallModal = window.openCallModal;
  window.openCallModal = function(){
    if(_openCallModal) _openCallModal();
    try{ setSemanaOptionsDefault(); }catch(e){}
    try{
      // ajustar etiqueta de duraci√≥n a (min) si est√° disponible
      var d = document.getElementById('callDuracion');
      if(d){
        var lbl = d.parentElement.querySelector('label');
        if(lbl) lbl.textContent = 'Duraci√≥n (min)';
        if(!d.min) d.min = '0';
        if(!d.step) d.step = '1';
      }
    }catch(e){}
  };

  // Helpers de validaci√≥n
  function markInvalid(el, on){
    if(!el) return;
    el.style.borderColor = on ? '#e53935' : '';
  }
  function validSemana(){ 
    var v = (document.getElementById('callSemana')||{}).value || '';
    return ['1','2','3','4'].includes(String(v));
  }
  function validCitaTipo(){ 
    var v = (document.getElementById('callCitaTipo')||{}).value || '';
    return v && v !== 'sin_cita';
  }
  function validCitaFecha(){ 
    var v = (document.getElementById('callCitaFecha')||{}).value || '';
    return !!v;
  }
  function validCitaHora(){ 
    var v = (document.getElementById('callCitaHora')||{}).value || '';
    return !!v;
  }

  // Hook guardar para validar primero
  var _save = window.saveCallRecord;
  window.saveCallRecord = function(){
    var ok = true, falta = [];
    var s = document.getElementById('callSemana');
    var t = document.getElementById('callCitaTipo');
    var f = document.getElementById('callCitaFecha');
    var h = document.getElementById('callCitaHora');

    if(!validSemana()){ ok=false; falta.push('N¬∞ Semana'); markInvalid(s, true); } else { markInvalid(s, false); }
    if(!validCitaTipo()){ ok=false; falta.push('Tipo de cita'); markInvalid(t, true); } else { markInvalid(t, false); }
    if(!validCitaFecha()){ ok=false; falta.push('Fecha de cita'); markInvalid(f, true); } else { markInvalid(f, false); }
    if(!validCitaHora()){ ok=false; falta.push('Hora de cita'); markInvalid(h, true); } else { markInvalid(h, false); }

    if(!ok){
      alert('Completa los campos obligatorios:\n‚Ä¢ ' + falta.join('\n‚Ä¢ '));
      return;
    }

    // Si la l√≥gica original espera duraci√≥n en SEGUNDOS, convertir (min -> seg) sin alterar el valor visible
    var d = document.getElementById('callDuracion');
    var old = null;
    if(d){
      old = d.value;
      var mins = Number(d.value || 0);
      if(!isNaN(mins)) d.value = String(Math.round(mins * 60));
    }
    try { if(_save) return _save(); }
    finally { if(d && old!=null) d.value = old; }
  };

  // Al cargar (por si el modal ya est√° montado en DOM)
  document.addEventListener('DOMContentLoaded', function(){
    try{ setSemanaOptionsDefault(); }catch(_){}
  });
})();
</script>


<!-- Fallback de login seguro: si no hay doLogin(), permite demo/1234 en modo local -->
<script>
(function() {
  function attach() {
    var b = document.getElementById('btnLogin');
    if (!b || b.__fixed) return;
    b.__fixed = true;
    b.addEventListener('click', function(ev){
      try { ev.preventDefault(); } catch(e) {}
      if (typeof window.doLogin === 'function') {
        return window.doLogin();
      }
      var u = (document.getElementById('loginUser')||{}).value||'';
      var p = (document.getElementById('loginPass')||{}).value||'';
      if (!u) u = 'demo';
      if (p === '1234' || (u==='demo' && !p)) {
        try{
          var lg = document.getElementById('login'); if(lg) lg.style.display='none';
          var ap = document.getElementById('app'); if(ap) ap.classList.remove('hidden');
        }catch(e){ console.warn(e); }
      } else {
        alert('Usuario o contrase√±a inv√°lidos. Tip: demo / 1234');
      }
    }, true);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attach);
  } else {
    attach();
  }
})();
</script>

<!-- FIX: Centrado RD + render inmediato Leaflet (sin cambiar UI) -->
<script>
(function() {
  const RD = [18.7357, -70.1627];
  const RD_ZOOM = 7;
  function tuneMap(m) {
    try {
      if (!m) return;
      // Centrar en RD una sola vez si a√∫n est√° en [0,0] o si no hay capas
      const c = m.getCenter ? m.getCenter() : null;
      if (c && Math.abs(c.lat) < 0.01 && Math.abs(c.lng) < 0.01) {
        m.setView(RD, RD_ZOOM, {animate: false});
      } else {
        // Si ya tiene algo, respeta zoom pero recentra a RD una √∫nica vez (suavemente)
        if (!m.__rdCentered) {
          m.setView(RD, m.getZoom ? m.getZoom() : RD_ZOOM, {animate: false});
          m.__rdCentered = true;
        }
      }
      // Forzar c√°lculo de tama√±o para evitar "mapa azul"
      setTimeout(()=>{ try{ m.invalidateSize(true); }catch(e){} }, 50);
      setTimeout(()=>{ try{ m.invalidateSize(true); }catch(e){} }, 300);
      setTimeout(()=>{ try{ m.invalidateSize(true); }catch(e){} }, 1200);
      window.addEventListener('resize', ()=> { try{ m.invalidateSize(true); }catch(e){} });
    } catch(e){ /* noop */ }
  }

  function applyToExisting() {
    if (!window.L || !L.Map) return;
    // Buscar contenedores Leaflet y detectar instancia a trav√©s de eventos
    const containers = document.querySelectorAll('.leaflet-container');
    containers.forEach(el => {
      if (el.__tuned) return;
      el.__tuned = true;
      // Heur√≠stica: escuchar primer evento para obtener el mapa
      const onAny = function(ev) {
        try {
          const m = ev?.target || ev?.sourceTarget || ev?.target?.target;
          if (m && m.invalidateSize && m.setView) {
            tuneMap(m);
            el.removeEventListener('click', onAny, true);
            el.removeEventListener('mousemove', onAny, true);
          }
        } catch(e){}
      };
      el.addEventListener('click', onAny, true);
      el.addEventListener('mousemove', onAny, true);
      // Tambi√©n intenta forzar invalidateSize si existe _leaflet_id
      try {
        const ev = new Event('mousemove', {bubbles:true, cancelable:true});
        el.dispatchEvent(ev);
      } catch(e){}
    });
  }

  function monkeyPatch() {
    if (!window.L || !L.Map) return;
    if (L.Map.__rdPatched) return;
    L.Map.__rdPatched = true;
    const _init = L.Map.prototype.initialize;
    L.Map.prototype.initialize = function(id, options) {
      _init.call(this, id, options);
      // Centrado e invalidate en cuanto el mapa exista
      setTimeout(() => tuneMap(this), 0);
    };
  }

  function init() {
    if (window.L && L.Map) {
      monkeyPatch();
      applyToExisting();
    } else {
      // Reintentar hasta que Leaflet cargue
      let tries = 0;
      const t = setInterval(() => {
        tries++;
        if (window.L && L.Map) {
          clearInterval(t);
          monkeyPatch();
          applyToExisting();
        }
        if (tries > 60) clearInterval(t);
      }, 250);
    }
  }

  document.addEventListener('DOMContentLoaded', init);
  window.addEventListener('load', () => setTimeout(applyToExisting, 100));
})();
</script>


<script>
(function(){
  function toggleDisplay(el){ if(!el) return; el.style.display = (el.style.display==='none' ? '' : 'none'); }
  document.addEventListener('click', function(ev){
    if(ev.target && ev.target.id==='dlpToggle'){
      var wrap=document.getElementById('dlpTableWrap')||document.querySelector('.dlp-card');
      toggleDisplay(wrap);
      ev.target.textContent = (wrap && wrap.style.display==='none') ? 'Mostrar' : 'Ocultar';
    }
    if(ev.target && ev.target.id==='rwToggle'){
      var k=document.getElementById('rwKpis');
      var tb=document.getElementById('rwTbl') ? document.getElementById('rwTbl').closest('.card')||document.getElementById('rwTbl') : null;
      var br=document.getElementById('rwBreakdown');
      toggleDisplay(k); toggleDisplay(tb); toggleDisplay(br);
      ev.target.textContent = (k && k.style.display==='none') ? 'Mostrar' : 'Ocultar';
    }
  }, true);
})();
</script>

</body>
</html>

<script>
// -- Sem√°foro: fuente √∫nica de "realizadas" (reporte si existe; si no, todas las llamadas)
(function(){
  function _collectFromReporte(){
    try{
      if (Array.isArray(window.__repRows__) && window.__repRows__.length){
        return new Set(window.__repRows__.map(o => (o['Cliente']||'').toString().trim().toLowerCase()));
      }
    }catch(_){}
    return null;
  }
  function _collectFromCalls(){
    try{
      const all = (window.loadAllCallRecords ? window.loadAllCallRecords() : []);
      return new Set(all.map(r => (r.cliente||'').toString().trim().toLowerCase()));
    }catch(_){ return new Set(); }
  }
  window.getRealizadasSet = function(){
    return _collectFromReporte() || _collectFromCalls();
  };
  // Prime on load
  document.addEventListener('DOMContentLoaded', function(){
    try{ window._REALIZADAS_CLIENTES = getRealizadasSet(); }catch(_){}
  });
  // If any component signals updates, refresh the set
  document.addEventListener('realizadas:saved', function(){ try{ window._REALIZADAS_CLIENTES = getRealizadasSet(); }catch(_){} });
  document.addEventListener('realizadas:update', function(){ try{ window._REALIZADAS_CLIENTES = getRealizadasSet(); }catch(_){} });
})();
</script>
<!-- Performance & Map-Ready Fix -->
<script>
(function(){
  function ensureTileLayer() {
    try{
      if(!(window.STATE && STATE.map)) return false;
      var hasTile=false;
      STATE.map && STATE.map.eachLayer && STATE.map.eachLayer(function(l){
        try{ if(l && l._url && (''+l._url).indexOf('tile.openstreetmap.org')>=0) hasTile=true; }catch(_){}
      });
      if(!hasTile && window.L && STATE.map){
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(STATE.map);
      }
      return true;
    }catch(e){ return false; }
  }
  function ensureMapReady(){
    try{
      if(typeof initMap==='function' && (!window.STATE || !STATE.map)) initMap();
      ensureTileLayer();
      if(window.STATE && STATE.map){
        try{ STATE.map.setView([18.735693,-70.162651],8);}catch(_){}
        try{ STATE.map.invalidateSize(); }catch(_){}
        setTimeout(function(){
          try{ STATE.map.invalidateSize(); }catch(_){}
          if(typeof applyFilters==='function'){ try{ applyFilters(); }catch(_){ } }
        },150);
      } else { setTimeout(ensureMapReady,150); }
    }catch(_){}
  }
  (function(){ if(typeof window.applyFilters==='function' && !window.__applyFiltersPatched){ var _af=window.applyFilters,t; window.applyFilters=function(){ clearTimeout(t); var a=arguments,c=this; t=setTimeout(function(){ try{ _af.apply(c,a);}catch(_){}} ,60);}; window.__applyFiltersPatched=true; }})();
  window.addEventListener('load', function(){ setTimeout(ensureMapReady,60); setTimeout(ensureMapReady,300); });
  var ap=document.getElementById('app'); if(ap && window.MutationObserver){ var mo=new MutationObserver(function(){ if(!ap.classList.contains('hidden')) ensureMapReady(); }); mo.observe(ap,{attributes:true, attributeFilter:['class']}); }
  var mapEl=document.getElementById('map'); if(mapEl && window.ResizeObserver){ var ro=new ResizeObserver(function(){ try{ if(window.STATE && STATE.map) STATE.map.invalidateSize(); }catch(_){}}); ro.observe(mapEl); }
})();
</script>
