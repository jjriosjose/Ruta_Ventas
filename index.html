<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Reporte de Llamadas â€” Resumen (Semanal)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com">
// Calendario (referencia): https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv
</script>
  <!-- Icons -->
  <link href="https://unpkg.com/lucide-static@0.321.0/font/lucide.css" rel="stylesheet">
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js">
// Calendario (referencia): https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv
</script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">
// Calendario (referencia): https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv
</script>
  <style>
    body{ background:#f8fafc;}
    .card{ background:white; border-radius:1rem; box-shadow:0 10px 20px rgba(2,6,23,.05); }
    .chip{ background:#eef2ff; color:#3730a3; padding:.35rem .6rem; border-radius:999px; font-size:.8rem; }
    .tab-btn{ padding:.5rem .9rem; border-radius:.6rem; }
    .tab-btn.active{ background:#2563eb; color:white; }
    .table th, .table td{ padding:.75rem .5rem; border-bottom:1px solid #eef2f7; font-size:.9rem;}
    .table th{ text-transform:uppercase; font-size:.75rem; letter-spacing:.02em; color:#64748b;}
    .kpi{ font-size:2rem; font-weight:800; letter-spacing:.02em;}
    .badge{display:inline-flex; align-items:center; padding:.2rem .5rem; border-radius:.5rem; font-size:.75rem;}
    .badge.green{ background:#ecfdf5; color:#065f46;}
    .badge.blue{ background:#eff6ff; color:#1e3a8a;}
    .badge.gray{ background:#f1f5f9; color:#334155;}
    .btn{ display:inline-flex; align-items:center; gap:.5rem; background:#0ea5e9; color:white; padding:.55rem .9rem; border-radius:.6rem;}
    .btn.secondary{ background:#111827; }
    .btn.minor{ background:#e2e8f0; color:#111827;}
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body class="text-slate-800">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <div class="flex items-center gap-3 mb-6">
      <span class="text-2xl">ðŸ“ž</span>
      <h1 class="text-2xl md:text-3xl font-bold">Reporte de Llamadas â€” <span class="text-slate-500">Resumen (Semanal)</span></h1>
    </div>

    <!-- Filtros -->
    <div class="grid md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4">
      <div class="card p-3">
        <label class="text-xs text-slate-500">Semana</label>
        <select id="f_semana" class="w-full mt-1 border rounded-lg p-2">
          <option value="Todas">Todas</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div class="card p-3">
        <label class="text-xs text-slate-500">Vendedor</label>
        <select id="f_vendedor" class="w-full mt-1 border rounded-lg p-2">
          <option value="Todos">Todos</option>
        </select>
      </div>
      <div class="card p-3">
        <label class="text-xs text-slate-500">Gestor</label>
        <select id="f_gestor" class="w-full mt-1 border rounded-lg p-2">
          <option value="Todos">Todos</option>
        </select>
      </div>
      <div class="card p-3 flex items-end justify-between">
        <button id="btn_export_excel" class="btn">
          <i class="lucide lucide-download"></i>
          <span>Exportar Excel</span>
        </button>
        <button id="btn_refrescar" class="btn minor">
          <i class="lucide lucide-rotate-ccw"></i>
          <span>Refrescar</span>
        </button>
      </div>
    </div>

    <!-- Detalle -->
    <div class="card p-4 mb-5">
      <div class="flex items-center justify-between">
        <h2 class="text-lg md:text-xl font-bold">Detalle de llamadas â€” Clientes</h2>
        <div class="flex gap-2">
          <button id="tab_pend" class="tab-btn active">Pendientes (Agenda)</button>
          <button id="tab_real" class="tab-btn">Realizadas (Historial)</button>
        </div>
      </div>

      <div class="overflow-x-auto mt-3">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Cod Empresa</th>
              <th>Cliente</th>
              <th>Semana</th>
              <th>DÃ­a</th>
              <th>Vendedor</th>
              <th>Gestor</th>
              <th class="text-right">A realizar</th>
            </tr>
          </thead>
          <tbody id="tbody_detalle">
            <tr><td colspan="7" class="text-center text-slate-500 py-8">Cargandoâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid md:grid-cols-3 gap-3 mb-4">
      <div class="card p-5 text-center">
        <div class="text-slate-500">A realizar (itinerarios)</div>
        <div id="kpi_realizar" class="kpi">0</div>
      </div>
      <div class="card p-5 text-center">
        <div class="text-slate-500">Realizadas (llamadas)</div>
        <div id="kpi_realizadas" class="kpi">0</div>
      </div>
      <div class="card p-5 text-center">
        <div class="text-slate-500">% Cobertura</div>
        <div id="kpi_cobertura" class="kpi">0%</div>
      </div>
    </div>

    <!-- Resumen inferior -->
    <div class="card p-4">
      <div class="overflow-x-auto">
        <table class="table w-full">
          <thead>
            <tr>
              <th>Gestor</th>
              <th>Semana</th>
              <th class="text-right">A realizar</th>
              <th class="text-right">Realizadas</th>
              <th class="text-right">% Cobertura</th>
              <th class="text-right">Ãšltima llamada</th>
            </tr>
          </thead>
          <tbody id="tbody_resumen">
            <tr><td colspan="6" class="text-center text-slate-500 py-8">Cargandoâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <p class="mt-6 text-xs text-slate-400">Configura las URLs en el bloque <strong>CONFIG</strong> del script.</p>
  </div>

<script>
/* ======================= CONFIG ======================= */
// Reemplaza estas URLs por tus publicaciones CSV de Google Sheets (Formato "CSV publicado").
// Agenda/Plan (Condicion, DIA, SEMANA, vendedor, gestor_servicio, Cod Empresa, RazonSocial, provinciaâ€¦)
const URL_AGENDA    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1016315198&single=true&output=csv";
// Historial (Fecha, Cliente, Cod, Vendedor, Gestor, Resultado, Obs, Provincia, â€¦, NÂ° Semana)
const URL_HISTORIAL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv";

/* ========= Helpers ========== */
const norm = s => (s ?? "").toString().trim();
const normAcc = s => norm(s).normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
const lower = s => norm(s).toLowerCase();
const asInt = (v) => {
  const n = parseInt(v,10);
  return isNaN(n)? null : n;
};

function parseCSV(url){
  return new Promise((resolve,reject)=>{
    if(!url || url.startsWith("REEMPLAZAR")){
      resolve([]);
      return;
    }
    Papa.parse(url,{
      download:true, header:true, skipEmptyLines:true,
      complete: (res)=> resolve(res.data.map(r=>Object.fromEntries(
        Object.entries(r).map(([k,v])=>[k.trim(), typeof v==="string"? v.trim(): v ])
      ))),
      error: (err)=> reject(err)
    });
  });
}

function unique(arr){
  return [...new Set(arr.filter(Boolean))];
}

function getSemanaFromRow(row){
  // Nombres de posibles columnas
  const keys = ["SEMANA","NÂ° Semana","N Semana","N_Semana","Semana"];
  for(const k of keys){
    if(row[k]!==undefined && norm(row[k])!==""){
      const n = asInt(row[k]);
      if(n) return String(n);
      return norm(row[k]);
    }
  }
  return "";
}

/* ========= Estado ========= */
let agendaRaw = [];
let histRaw   = [];
let currentTab = "pend"; // "pend" | "real"

/* ========= Carga ========= */
async function loadData(){
  // mostrar "cargando"
  document.getElementById("tbody_detalle").innerHTML = `<tr><td colspan="7" class="text-center text-slate-500 py-8">Cargandoâ€¦</td></tr>`;
  document.getElementById("tbody_resumen").innerHTML = `<tr><td colspan="6" class="text-center text-slate-500 py-8">Cargandoâ€¦</td></tr>`;

  [agendaRaw, histRaw] = await Promise.all([parseCSV(URL_AGENDA), parseCSV(URL_HISTORIAL)]);

  // Normalizaciones mÃ­nimas
  agendaRaw = agendaRaw.map(r=>([
    cod: norm(r["Cod Empresa"] ?? r["Cod"] ?? r["codigo"] ?? r["codigo_empresa"]),
    cliente: norm(r["RazonSocial"] ?? r["Cliente"]),
    semana: String(getSemanaFromRow(r) || ""),
    dia: norm(r["DIA"] ?? r["DÃ­a"] ?? r["Dia"]),
    vendedor: norm(r["vendedor"] ?? r["Vendedor"]),
    gestor: norm(r["gestor_servicio"] ?? r["Gestor"]),
    condicion: norm(r["Condicion"] ?? r["CondiciÃ³n"] ?? r["CONDICION"])
  })).filter(r => r.cod);

  histRaw = histRaw.map(r=>({
    cod: norm(r["Cod Empresa"] ?? r["Cod"] ?? r["codigo"]),
    cliente: norm(r["Cliente"] ?? r["RazonSocial"]),
    semana: String(getSemanaFromRow(r) || ""),
    vendedor: norm(r["Vendedor"] ?? r["vendedor"]),
    gestor: norm(r["Gestor"] ?? r["gestor_servicio"] ?? r["gestor"]),
    fecha: norm(r["Fecha/Hora"] ?? r["Fecha"] ?? r["fecha"]),
    resultado: norm(r["Resultado"] ?? r["resultado"]),
    vendedor_norm: normAcc(r["Vendedor"] ?? r["vendedor"]),
    gestor_norm: normAcc(r["Gestor"] ?? r["gestor_servicio"] ?? r["gestor"])
  })).filter(r => r.cod);(r => r.cod);

  // Popular filtros
  const vends = unique([ ...agendaRaw.map(x=>x.vendedor), ...histRaw.map(x=>x.vendedor) ]).sort();
  const gests = unique([ ...agendaRaw.map(x=>x.gestor), ...histRaw.map(x=>x.gestor) ]).sort();
  fillSelect("f_vendedor", ["Todos", ...vends]);
  fillSelect("f_gestor", ["Todos", ...gests]);

  renderAll();
}

function fillSelect(id, opts){
  const sel = document.getElementById(id);
  const old = sel.value;
  sel.innerHTML = opts.map(v=>`<option value="${v}">${v}</option>`).join("");
  if(opts.includes(old)) sel.value = old;
}

/* ========= Filtros & derivaciones ========= */
function getFilters(){
  return {
    semana: document.getElementById("f_semana").value,
    vendedor: document.getElementById("f_vendedor").value,
    gestor: document.getElementById("f_gestor").value
  };
}

function applyFilters(rows){
  const {semana, vendedor, gestor} = getFilters();
  const vend = normAcc(vendedor);
  const gest = normAcc(gestor);
  return rows.filter(r=>{
    if(semana !== "Todas" && String(r.semana)!==String(semana)) return false;
    if(vendedor !== "Todos" && r.vendedor_norm !== vend) return false;
    if(gestor !== "Todos" && r.gestor_norm !== gest) return false;
    return true;
  });
}

/* ========= Render ========= */
function renderKPIs(pendientes, realizadas){
  const totalPlan = pendientes.length + realizadas.length; // consider pending as those in agenda not matched
  // Pero KPI solicitado: A realizar (Agenda) vs Realizadas (Historial)
  const agendaFiltrada = applyFilters(agendaRaw).filter(a => a.condicion_norm.includes('ruta'));
  const seen = new Set(); const dedupAgenda = [];
  for(const a of agendaD){ const k = `${a.cod}__${a.semana}`; if(!seen.has(k)){ seen.add(k); dedupAgenda.push(a);} }
  const realizadasFiltradas = applyFilters(histRaw);

  const kpiRealizar = dedupAgenda.length;
  const kpiHechas = realizadasFiltradas.length;
  const cobertura = kpiRealizar>0 ? Math.round((kpiHechas/kpiRealizar)*100) : 0;

  document.getElementById("kpi_realizar").textContent = kpiRealizar.toLocaleString();
  document.getElementById("kpi_realizadas").textContent = kpiHechas.toLocaleString();
  document.getElementById("kpi_cobertura").textContent = cobertura + "%";
}

function renderDetalle(){
  const {semana, vendedor, gestor} = getFilters();

  // Matching por Cod + Semana
  const key = (r)=> `${r.cod}__${r.semana}`;
  const histMap = new Map(applyFilters(histRaw).map(r=>[key(r), r]));

  const agendaFiltrada = applyFilters(agendaRaw).filter(a => a.condicion_norm.includes('ruta'));
  const seenP = new Set(); const agendaD = [];
  for(const a of agendaD){ const k = `${a.cod}__${a.semana}`; if(!seenP.has(k)){ seenP.add(k); agendaD.push(a);} }
  const pendientes = [];
  for(const a of agendaD){
    if(!histMap.has(key(a))){
      pendientes.push(a);
    }
  }

  let rows = [];
  if(currentTab==="pend"){
    rows = pendientes;
  }else{
    rows = applyFilters(histRaw).map(r=>({
      cod: r.cod, cliente:r.cliente, semana:r.semana, dia:"", vendedor:r.vendedor, gestor:r.gestor, condicion:"Realizada"
    }));
  }

  const tbody = document.getElementById("tbody_detalle");
  if(rows.length===0){
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-slate-500 py-8">Sin datos para los filtros seleccionados.</td></tr>`;
  }else{
    tbody.innerHTML = rows.map(r=>`
      <tr>
        <td>${r.cod}</td>
        <td>${r.cliente}</td>
        <td>${r.semana || ""}</td>
        <td>${r.dia || ""}</td>
        <td>${r.vendedor || ""}</td>
        <td>${r.gestor || ""}</td>
        <td class="text-right">${currentTab==="pend" ? 1 : 0}</td>
      </tr>
    `).join("");
  }

  renderKPIs(pendientes, applyFilters(histRaw));
}

function renderResumenInferior(){
  const {semana, vendedor, gestor} = getFilters();

  // Agrupar por Gestor + Semana
  const agenda = applyFilters(agendaRaw).filter(a => a.condicion_norm.includes('ruta'));
  const seenR = new Set(); const agendaD = [];
  for(const a of agenda){ const k = `${a.cod}__${a.semana}`; if(!seenR.has(k)){ seenR.add(k); agendaD.push(a);} }
  const realizadas = applyFilters(histRaw);

  const key = (g,s)=>`${g}__${s}`;
  const map = new Map();

  for(const a of agendaD){
    const k = key(a.gestor, a.semana);
    if(!map.has(k)) map.set(k, {gestor:a.gestor||"(sin gestor)", semana:a.semana||"", realizar:0, hechas:0, last:null});
    map.get(k).realizar++;
  }
  for(const h of realizadas){
    const k = key(h.gestor, h.semana);
    if(!map.has(k)) map.set(k, {gestor:h.gestor||"(sin gestor)", semana:h.semana||"", realizar:0, hechas:0, last:null});
    map.get(k).hechas++;
    const dt = h.fecha;
    if(dt){
      const cur = map.get(k).last;
      if(!cur || dt>cur) map.get(k).last = dt;
    }
  }

  const rows = Array.from(map.values()).sort((a,b)=>{
    if(a.gestor===b.gestor) return String(a.semana).localeCompare(String(b.semana));
    return a.gestor.localeCompare(b.gestor);
  });

  const tbody = document.getElementById("tbody_resumen");
  if(rows.length===0){
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-slate-500 py-8">Sin datos para los filtros seleccionados.</td></tr>`;
  }else{
    tbody.innerHTML = rows.map(r=>{
      const cov = r.realizar>0? Math.round((r.hechas/r.realizar)*100):0;
      return `
        <tr>
          <td>${r.gestor}</td>
          <td>${r.semana || ""}</td>
          <td class="text-right">${r.realizar}</td>
          <td class="text-right">${r.hechas}</td>
          <td class="text-right">${cov}%</td>
          <td class="text-right">${r.last || "-"}</td>
        </tr>
      `;
    }).join("");
  }
}

function renderAll(){
  renderDetalle();
  renderResumenInferior();
}

/* ========= Export Excel ========= */
function exportExcel(){
  // Exporta lo que se ve en la tabla de detalle (pendientes o realizadas), y agrega hoja Resumen + KPIs.
  const wb = XLSX.utils.book_new();

  // Detalle
  const table = document.querySelector("#tbody_detalle").closest("table");
  const ws1 = XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb, ws1, currentTab==="pend"?"Pendientes":"Realizadas");

  // Resumen
  const table2 = document.querySelector("#tbody_resumen").closest("table");
  const ws2 = XLSX.utils.table_to_sheet(table2);
  XLSX.utils.book_append_sheet(wb, ws2, "Resumen");

  // KPIs
  const k1 = document.getElementById("kpi_realizar").textContent;
  const k2 = document.getElementById("kpi_realizadas").textContent;
  const k3 = document.getElementById("kpi_cobertura").textContent;
  const ws3 = XLSX.utils.aoa_to_sheet([
    ["KPI","Valor"],
    ["A realizar (itinerarios)", k1],
    ["Realizadas (llamadas)", k2],
    ["% Cobertura", k3],
  ]);
  XLSX.utils.book_append_sheet(wb, ws3, "KPIs");

  const fn = `reporte_llamadas_semana.xlsx`;
  XLSX.writeFile(wb, fn);
}

/* ========= Eventos ========= */
document.getElementById("f_semana").addEventListener("change", renderAll);
document.getElementById("f_vendedor").addEventListener("change", renderAll);
document.getElementById("f_gestor").addEventListener("change", renderAll);

document.getElementById("btn_export_excel").addEventListener("click", exportExcel);
document.getElementById("btn_refrescar").addEventListener("click", loadData);

document.getElementById("tab_pend").addEventListener("click", ()=>{
  currentTab="pend";
  document.getElementById("tab_pend").classList.add("active");
  document.getElementById("tab_real").classList.remove("active");
  renderAll();
});
document.getElementById("tab_real").addEventListener("click", ()=>{
  currentTab="real";
  document.getElementById("tab_real").classList.add("active");
  document.getElementById("tab_pend").classList.remove("active");
  renderAll();
});

// Init
loadData();

// Calendario (referencia): https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv
</script>
</body>
</html>
