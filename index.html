<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Llamadas ‚Äî Home</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--border:#e6e8ee;--text:#0f172a;--muted:#64748b;--accent:#0ea5e9;--warn:#ef4444;--ok:#10b981}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
    .wrap{max-width:1240px;margin:auto;padding:12px}
    h1{margin:0;font-size:22px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;font-size:12px}
    .chip.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .btn{border:1px solid var(--border);padding:9px 12px;border-radius:10px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.warn{background:#ef4444;border-color:#ef4444;color:#fff}
    .btn.small{padding:6px 10px;border-radius:8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,.04)}
    label{font-size:12px;font-weight:800;color:#111}
    input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
    thead th{font-size:12px;font-weight:800}
    #map{height:380px;border-radius:12px;overflow:hidden}
    dialog{border:none;border-radius:16px;max-width:980px;width:92%}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row" style="align-items:center;gap:12px">
          <div style="width:40px;height:40px;border-radius:8px;background:#fff url('https://dummyimage.com/64x64/ff0000/ffffff&text=K') center/cover no-repeat;border:1px solid var(--border)"></div>
          <h1>Gesti√≥n de Llamadas</h1>
          <span class="chip">LLAMADAS v7.5.6</span>
          <span class="chip">Single-File</span>
        </div>
        <div class="toolbar">
          <button class="btn small" id="btnAgenda">üìÖ Agenda</button>
          <button class="btn small" id="btnRegistrar">üìù Registrar llamada</button>
          <button class="btn small" id="btnReporte">üìä Reporte</button>
          <button class="btn small" id="btnReporteRes">üìà Reporte (Resumen)</button>
          <button class="btn small" id="btnVerFicha">üëÅÔ∏è Ver ficha</button>
          <button class="btn small" id="btnNuevoCliente">‚ûï Nuevo cliente</button>
          <button class="btn small" id="btnExportCSV">‚á© Exportar CSV</button>
          <button class="btn small warn" id="btnRestaurar">‚ü≤ Restaurar</button>
          <button class="btn small" id="btnConfig">‚öôÔ∏è Configurar</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="toolbar">
        <button class="btn small" id="btnFiltros">‚ñ¶ Filtros</button>
        <button class="btn small" id="btnLegend">üîé Mostrar leyenda</button>
        <span class="chip" id="statClientes">Clientes: 0</span>
        <span class="chip" id="statCoord">Con coordenadas: 0</span>
        <span class="chip" id="statFiltrados">Filtrados: 0</span>
      </div>

      <!-- Filtros -->
      <div id="filtros" class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>Semana</label>
          <select id="fSemana">
            <option value="">Todas</option>
            <option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </div>
        <div style="flex:1">
          <label>D√≠a</label>
          <select id="fDia">
            <option>Todos</option>
            <option>Lunes</option><option>Martes</option><option>Mi√©rcoles</option><option>Jueves</option><option>Viernes</option><option>S√°bado</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Vendedor</label>
          <select id="fVendedor"><option value="">Todos</option></select>
        </div>
        <div style="flex:1">
          <label>Gestor</label>
          <select id="fGestor"><option value="">Todos</option></select>
        </div>
        <div style="flex:1">
          <label>Empresa</label>
          <select id="fEmpresa"><option value="">Todas</option></select>
        </div>
        <div style="flex:1">
          <label>Buscar</label>
          <input id="fBuscar" placeholder="Nombre o c√≥digo...">
        </div>
        <div style="flex:1">
          <label>Cliente</label>
          <select id="fCliente"><option value="">-- Seleccione --</option></select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="card" style="flex:1;min-width:380px">
          <div id="map"></div>
        </div>
        <div class="card" style="flex:1;min-width:340px">
          <h3 style="margin:0 0 8px 0">Clientes filtrados</h3>
          <table id="tblClientes">
            <thead><tr><th>Cod</th><th>Cliente</th><th>Semana</th><th>D√≠a</th><th>Vendedor</th><th>Gestor</th><th>Empresa</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: Registrar llamada -->
  <dialog id="dlgReg">
    <form method="dialog">
      <div class="card" style="box-shadow:none;border:none">
        <h3 style="margin-top:0">Registrar llamada</h3>
        <div class="row">
          <div style="flex:2">
            <label>Cliente</label>
            <input id="mCliente" placeholder="Cliente">
          </div>
          <div style="flex:1">
            <label>Cod Empresa</label>
            <input id="mCod" placeholder="C√≥digo">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Vendedor</label>
            <input id="mVendedor" placeholder="Vendedor">
          </div>
          <div style="flex:1">
            <label>gestor_servicio</label>
            <input id="mGestor" placeholder="Gestor">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Fecha y hora</label>
            <input id="mFechaHora" type="datetime-local">
          </div>
          <div style="flex:1">
            <label>N¬∞ Semana</label>
            <select id="mSemana" required>
              <option value="">(Seleccione...)</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Resultado</label>
            <select id="mResultado">
              <option>Exitosa</option>
              <option>Gesti√≥n de pedido recibido</option>
              <option>No Contesta</option>
              <option>No Compr√≥</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Duraci√≥n (seg.)</label>
            <input id="mDuracion" type="number" min="0" value="0">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Observaciones</label>
            <input id="mObs" placeholder="Notas de la llamada...">
          </div>
        </div>
        <div class="row" style="margin-top:10px;justify-content:flex-end;gap:8px">
          <button id="btnCancel" class="btn">Cancelar</button>
          <button id="btnSave" class="btn primary">Guardar</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- MODAL: Reporte (Detalle) -->
  <dialog id="dlgRep">
    <div class="card" style="box-shadow:none;border:none">
      <h3 style="margin-top:0">Reporte ‚Äî Detalle</h3>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="btnExportCSVDet" class="btn small">‚á© Exportar CSV</button>
        <button id="btnExportXLSXDet" class="btn small">‚á© Exportar Excel</button>
        <button id="btnCerrarRep" class="btn small">Cerrar</button>
      </div>
      <div style="margin-top:10px;overflow:auto;max-height:60vh">
        <table id="repTbl">
          <thead>
            <tr>
              <th>Fecha/Hora</th>
              <th>Cliente</th>
              <th>Cod</th>
              <th>Vendedor</th>
              <th>Gestor</th>
              <th>N Semana</th>
              <th>Resultado</th>
              <th>Duraci√≥n</th>
              <th>Obs</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </dialog>

  <script>
    const SHEETS = {
      clientes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1016315198&single=true&output=csv'
    };

    const STATE = { calls:[], clientes:[] };
    try{ ['calls','historial','history','llamadas'].forEach(k=>{ localStorage.removeItem(k); sessionStorage.removeItem(k); }); }catch(e){}

    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const csvToRows = (csv)=>csv.split(/\r?\n/).map(r=>r.split(',')).filter(r=>r.length>1 || (r.length===1 && r[0].trim()!==''));
    const uniq = a=>Array.from(new Set(a.filter(Boolean)));
    function fmt(dt){ if(!dt) return ''; const d = new Date(dt); if(isNaN(d)) return dt; const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

    let map, layer;
    function initMap(){
      map = L.map('map').setView([18.7357,-70.1627],7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
      layer = L.layerGroup().addTo(map);
    }
    function renderMap(){
      if(!map) return;
      layer.clearLayers();
      const hdr = STATE.clientes[0]||[];
      const idxLat = hdr.findIndex(h=>String(h).toLowerCase().includes('lat'));
      const idxLon = hdr.findIndex(h=>String(h).toLowerCase().includes('lon'));
      const idxNom = hdr.findIndex(h=>/cliente|nombre/i.test(String(h)));
      const idxVend= hdr.findIndex(h=>/vendedor/i.test(String(h)));
      STATE.clientes.slice(1).forEach(r=>{
        const lat = parseFloat(r[idxLat]);
        const lon = parseFloat(r[idxLon]);
        if(!isNaN(lat) && !isNaN(lon)){
          const name = r[idxNom] || 'Cliente';
          const vend = r[idxVend]||'';
          L.circleMarker([lat,lon],{radius:6,weight:2,color:'#0ea5e9',fillColor:'#0ea5e9',fillOpacity:.7}).addTo(layer).bindPopup(`<b>${name}</b><br>${vend}`);
        }
      });
    }

    function fillCombos(){
      const hdr = STATE.clientes[0]||[];
      const idxVend= hdr.findIndex(h=>/vendedor/i.test(String(h)));
      const idxGes = hdr.findIndex(h=>/gestor/i.test(String(h)));
      const idxEmp = hdr.findIndex(h=>/empresa/i.test(String(h)));
      const idxCli = hdr.findIndex(h=>/cliente|nombre/i.test(String(h)));
      const vend = uniq(STATE.clientes.slice(1).map(r=>r[idxVend]||'').map(s=>s.trim())).sort();
      const gest = uniq(STATE.clientes.slice(1).map(r=>r[idxGes]||'').map(s=>s.trim())).sort();
      const emp  = uniq(STATE.clientes.slice(1).map(r=>r[idxEmp]||'').map(s=>s.trim())).sort();
      $('#fVendedor').innerHTML = '<option value="">Todos</option>'+vend.map(v=>`<option>${v}</option>`).join('');
      $('#fGestor').innerHTML   = '<option value="">Todos</option>'+gest.map(v=>`<option>${v}</option>`).join('');
      $('#fEmpresa').innerHTML  = '<option value="">Todas</option>'+emp.map(v=>`<option>${v}</option>`).join('');
      $('#fCliente').innerHTML  = '<option value="">-- Seleccione --</option>'+STATE.clientes.slice(1).map(r=>`<option>${r[idxCli]||''}</option>`).join('');
    }

    function applyFiltersClientes(rows){
      const vend= $('#fVendedor').value.trim().toLowerCase();
      const ges = $('#fGestor').value.trim().toLowerCase();
      const emp = $('#fEmpresa').value.trim().toLowerCase();
      const bus = $('#fBuscar').value.trim().toLowerCase();
      const cli = $('#fCliente').value.trim().toLowerCase();
      const hdr = STATE.clientes[0]||[];
      const idxNom = hdr.findIndex(h=>/cliente|nombre/i.test(String(h)));
      const idxVend= hdr.findIndex(h=>/vendedor/i.test(String(h)));
      const idxGes = hdr.findIndex(h=>/gestor/i.test(String(h)));
      const idxEmp = hdr.findIndex(h=>/empresa/i.test(String(h)));
      const idxCod = hdr.findIndex(h=>/cod/i.test(String(h)));
      return rows.slice(1).filter(r=>{
        const nombre=(r[idxNom]||'').toLowerCase();
        const cod=(r[idxCod]||'').toLowerCase();
        const v=(r[idxVend]||'').toLowerCase();
        const g=(r[idxGes]||'').toLowerCase();
        const e=(r[idxEmp]||'').toLowerCase();
        if(vend && v!==vend) return false;
        if(ges && g!==ges) return false;
        if(emp && e!==emp) return false;
        if(cli && nombre!==cli) return false;
        if(bus && !(nombre.includes(bus)||cod.includes(bus))) return false;
        return true;
      });
    }
    function renderClientesTabla(){
      const tbody = $('#tblClientes tbody');
      const hdr = STATE.clientes[0]||[];
      const idxNom = hdr.findIndex(h=>/cliente|nombre/i.test(String(h)));
      const idxVend= hdr.findIndex(h=>/vendedor/i.test(String(h)));
      const idxGes = hdr.findIndex(h=>/gestor/i.test(String(h)));
      const idxEmp = hdr.findIndex(h=>/empresa/i.test(String(h)));
      const idxCod = hdr.findIndex(h=>/cod/i.test(String(h)));
      const filtered = applyFiltersClientes(STATE.clientes);
      $('#statClientes').textContent = 'Clientes: '+Math.max(STATE.clientes.length-1,0);
      $('#statCoord').textContent = 'Con coordenadas: '+0;
      $('#statFiltrados').textContent = 'Filtrados: '+filtered.length;
      tbody.innerHTML = filtered.map(r=>`
        <tr>
          <td>${r[idxCod]||''}</td>
          <td>${r[idxNom]||''}</td>
          <td>${'Por asignar'}</td>
          <td>${'Por asignar'}</td>
          <td>${r[idxVend]||''}</td>
          <td>${r[idxGes]||''}</td>
          <td>${r[idxEmp]||''}</td>
        </tr>
      `).join('');
    }

    function renderReporte(){
      const tb = $('#repTbl tbody');
      tb.innerHTML = STATE.calls.map(r=>`
        <tr>
          <td>${fmt(r.fechaHora)}</td>
          <td>${r.cliente||''}</td>
          <td>${r.codigo||''}</td>
          <td>${r.vendedor||''}</td>
          <td>${r.gestor||''}</td>
          <td>${r.semana||''}</td>
          <td>${r.resultado||''}</td>
          <td>${r.duracion||''}</td>
          <td>${r.obs||''}</td>
        </tr>
      `).join('');
    }

    // Export Detalle
    $('#btnExportCSVDet').addEventListener('click', ()=>{
      const tbl = document.getElementById('repTbl');
      const out=[];
      out.push(Array.from(tbl.querySelectorAll('thead th')).map(th=>`"${th.textContent.replace(/"/g,'""')}"`).join(','));
      Array.from(tbl.querySelectorAll('tbody tr')).forEach(tr=>{
        out.push(Array.from(tr.children).map(td=>`"${td.textContent.replace(/"/g,'""')}"`).join(','));
      });
      const blob = new Blob([out.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='Detalle_Llamadas.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 400);
    });
    $('#btnExportXLSXDet').addEventListener('click', ()=>{
      const tbl = document.getElementById('repTbl');
      const aoa=[];
      aoa.push(Array.from(tbl.querySelectorAll('thead th')).map(th=>th.textContent.trim()));
      Array.from(tbl.querySelectorAll('tbody tr')).forEach(tr=>{
        aoa.push(Array.from(tr.children).map(td=>td.textContent.trim()));
      });
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Detalle');
      XLSX.writeFile(wb, 'Detalle_Llamadas.xlsx');
    });

    // Topbar events
    $('#btnRegistrar').addEventListener('click', ()=>{
      ['mCliente','mCod','mVendedor','mGestor','mFechaHora','mResultado','mDuracion','mObs'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(el.type==='number') el.value='0'; else el.value='';
      });
      document.getElementById('mSemana').value='';
      document.getElementById('dlgReg').showModal();
    });
    $('#btnCancel').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('dlgReg').close(); });
    $('#btnSave').addEventListener('click', (e)=>{
      e.preventDefault();
      const semana = document.getElementById('mSemana').value;
      if(!['1','2','3','4'].includes(semana)){ alert('Seleccione el N¬∞ Semana (1..4)'); return; }
      const rec = {
        fechaHora: document.getElementById('mFechaHora').value || new Date().toISOString(),
        cliente: document.getElementById('mCliente').value,
        codigo: document.getElementById('mCod').value,
        vendedor: document.getElementById('mVendedor').value,
        gestor: document.getElementById('mGestor').value,
        semana: semana,
        resultado: document.getElementById('mResultado').value,
        duracion: document.getElementById('mDuracion').value,
        obs: document.getElementById('mObs').value
      };
      STATE.calls.push(rec);
      document.getElementById('dlgReg').close();
      renderReporte();
    });
    $('#btnReporte').addEventListener('click', ()=>{ renderReporte(); document.getElementById('dlgRep').showModal(); });
    $('#btnCerrarRep').addEventListener('click', ()=>document.getElementById('dlgRep').close());

    // Placeholders
    $('#btnAgenda').addEventListener('click', ()=>alert('Agenda: pendiente de conectar'));
    $('#btnReporteRes').addEventListener('click', ()=>alert('Reporte Resumen: pendiente de conectar'));
    $('#btnVerFicha').addEventListener('click', ()=>alert('Ver ficha: pendiente de conectar'));
    $('#btnNuevoCliente').addEventListener('click', ()=>alert('Nuevo cliente: pendiente de conectar'));
    $('#btnConfig').addEventListener('click', ()=>alert('Configurar: pendiente de conectar'));
    $('#btnRestaurar').addEventListener('click', ()=>{ if(confirm('¬øRestaurar estado?')){ STATE.calls=[]; renderReporte(); alert('Listo.'); } });

    // Export CSV clientes
    $('#btnExportCSV').addEventListener('click', ()=>{
      const tbl = document.getElementById('tblClientes');
      const out=[];
      out.push(Array.from(tbl.querySelectorAll('thead th')).map(th=>`"${th.textContent.replace(/"/g,'""')}"`).join(','));
      Array.from(tbl.querySelectorAll('tbody tr')).forEach(tr=>{
        out.push(Array.from(tr.children).map(td=>`"${td.textContent.replace(/"/g,'""')}"`).join(','));
      });
      const blob = new Blob([out.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='Clientes_filtrados.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 400);
    });

    ['fSemana','fDia','fVendedor','fGestor','fEmpresa','fBuscar','fCliente'].forEach(id=>{
      document.getElementById(id).addEventListener('input', ()=>{ renderClientesTabla(); renderMap(); });
      document.getElementById(id).addEventListener('change', ()=>{ renderClientesTabla(); renderMap(); });
    });
    document.getElementById('btnFiltros').addEventListener('click', ()=>{
      const f = document.getElementById('filtros'); f.style.display = (f.style.display==='none'?'grid':'none'); f.style.gridTemplateColumns='repeat(6, minmax(160px, 1fr))';
    });

    async function fetchCSV(url){ const t = await fetch(url).then(r=>r.text()).catch(()=> ''); return t ? csvToRows(t) : []; }
    async function boot(){
      initMap();
      STATE.clientes = await fetchCSV(SHEETS.clientes);
      const hdr = STATE.clientes[0]||[];
      fillCombos();
      renderClientesTabla();
      renderMap();
    }
    boot();
  </script>
</body>
</html>
