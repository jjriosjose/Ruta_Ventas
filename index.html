<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gestión de Llamadas — Itinerario FIX</title>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<style>
  :root{--bg:#0d1b2a;--panel:#132a3e;--card:#16324a;--text:#e5e5e5;--muted:#b8c1cc;--accent:#00c38a;--chip:#244b64;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1623,#0f2234 40%,#071520);color:var(--text);font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid #1e3a52;background:#0c1f31;position:sticky;top:0;z-index:10}
  header h1{font-size:18px;margin:0;font-weight:600}
  .badge{background:#11324a;padding:2px 8px;border-radius:999px;font-size:12px;color:#9ad5ff;border:1px solid #204d6b}
  .container{padding:20px;max-width:1400px;margin:0 auto}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .panel{background:var(--panel);border:1px solid #1f3b55;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .panel .hd{padding:14px 16px;border-bottom:1px solid #214863;display:flex;align-items:center;gap:10px}
  .panel .hd h3{margin:0;font-size:15px;font-weight:600;color:#bfe3ff}
  .panel .bd{padding:12px 14px}
  .filters{display:grid;grid-template-columns: repeat(6, minmax(0,1fr)); gap:10px}
  label{display:flex;flex-direction:column;font-size:12px;color:#a9c7db;gap:6px}
  select,input[type="text"]{background:#0e2234;border:1px solid #254f6b;color:var(--text);border-radius:10px;padding:10px 10px;outline:none}
  select:focus,input:focus{border-color:#3ea5ff;box-shadow:0 0 0 3px rgba(62,165,255,.2)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:var(--chip);border:1px solid #2d5673;color:#bfe3ff;border-radius:999px;padding:4px 10px;font-size:12px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-bottom:1px solid #203f58}
  .table th{font-size:12px;color:#a9c7db;text-align:left}
  .table tbody tr:hover{background:#142b41}
  #map{height:540px;border-radius:12px;border:1px solid #1f3b55;box-shadow:inset 0 0 0 1px rgba(255,255,255,.03)}
  .login{max-width:600px;margin:70px auto;padding:22px;background:#0d2236;border:1px solid #1f3b55;border-radius:16px}
  .login h2{margin:0 0 8px}
  .row-2{display:grid;grid-template-columns:2fr 1fr;gap:14px}
  .btn{background:linear-gradient(180deg,#1dbf8b,#12a576);border:1px solid #0f8b62;color:white;border-radius:10px;padding:12px 14px;cursor:pointer;font-weight:600}
  .btn:active{transform:translateY(1px)}
  .pill{background:#0b2a3e;padding:6px 10px;border-radius:999px;border:1px solid #1d4e6d;color:#88caff}
  .muted{color:#9db3c3}
  .foot{padding:10px 20px;color:#7aa5bf;font-size:12px;text-align:right}
  .hidden{display:none !important}
</style>
</head>
<body>
<header>
  <svg width="22" height="22" viewBox="0 0 24 24" fill="#74c0fc"><path d="M12 3l9 4.5-9 4.5-9-4.5L12 3zm0 7.8l9 4.5V21l-9-4.5L3 21v-5.7l9-4.5z"/></svg>
  <h1>Gestión de Llamadas — <span style="color:#9ad5ff">Itinerario FIX</span></h1>
  <span class="badge">v7.6.x</span>
</header>

<div id="loginView" class="container">
  <div class="login">
    <h2>Ingreso</h2>
    <p class="muted">Usa <b>demo / 1234</b> para entrar en modo local. Luego podrás configurar URLs si lo deseas.</p>
    <div class="row-2">
      <label>Usuario
        <input id="loginUser" type="text" placeholder="demo" value="demo">
      </label>
      <label>Contraseña
        <input id="loginPass" type="password" placeholder="1234" value="1234">
      </label>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
      <button id="btnLogin" class="btn">Entrar</button>
      <span class="pill">Modo: local (CSV públicos)</span>
    </div>
  </div>
</div>

<div id="app" class="container hidden">
  <div class="panel">
    <div class="hd"><h3>Filtros</h3></div>
    <div class="bd">
      <div class="filters">
        <label>Semana
          <select id="fSemana">
            <option value="">Todas</option>
            <option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </label>
        <label>Día
          <select id="fDia">
            <option value="">Todos</option>
            <option>LUNES</option><option>MARTES</option><option>MIERCOLES</option><option>JUEVES</option><option>VIERNES</option>
          </select>
        </label>
        <label>Vendedor
          <select id="fVendedor"><option value="">Todos</option></select>
        </label>
        <label>Gestor
          <select id="fGestor"><option value="">Todos</option></select>
        </label>
        <label>Empresa
          <select id="fEmpresa"><option value="">Todas</option></select>
        </label>
        <label>Buscar
          <input id="fBuscar" type="text" placeholder="Nombre o código...">
        </label>
      </div>
      <div class="chips" id="stats"></div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="panel">
      <div class="hd"><h3>Mapa</h3></div>
      <div class="bd">
        <div id="map"></div>
      </div>
    </div>
    <div class="panel">
      <div class="hd"><h3>Clientes filtrados</h3></div>
      <div class="bd" style="overflow:auto;max-height:540px">
        <table class="table" id="tbl">
          <thead>
            <tr><th>Cod</th><th>Cliente</th><th>Semana</th><th>Día</th><th>Vendedor</th><th>Gestor</th><th>Empresa</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="foot">Centro inicial del mapa: República Dominicana. Pines por vendedor. “Por asignar” si no existe fila en Calendario.</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ======================= CONFIG URLs (tus hojas) =======================
const URL_CLIENTES   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1016315198&single=true&output=csv";
const URL_USUARIOS   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv";
const URL_CALENDARIO = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=223681507&single=true&output=csv";

// ======================= LOGIN =======================
document.getElementById('btnLogin').addEventListener('click', () => {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if ((u || 'demo') && (p === '1234')) {
    document.getElementById('loginView').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    boot();
  } else {
    alert('Usuario o contraseña inválidos. Tip: demo / 1234');
  }
});

// ======================= Helpers =======================
const norm = s => (s ?? '').toString().trim().toLowerCase();

function csvToObjects(text) {
  const lines = text.replace(/\r/g,'').split('\n').filter(x => x.trim().length);
  if (!lines.length) return [];
  const head = lines.shift().split(',').map(h => h.trim());
  return lines.map(line => {
    const cols = [];
    let cur = '', inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"' && line[i+1] === '"') { cur+='"'; i++; continue; }
      if (ch === '"'){ inQ=!inQ; continue; }
      if (ch === ',' && !inQ){ cols.push(cur); cur=''; continue; }
      cur+=ch;
    }
    cols.push(cur);
    const o = {};
    head.forEach((h,idx) => o[h]=cols[idx]??'');
    return o;
  });
}

function val(o, keys, def='') {
  for (const k of keys) {
    if (o[k] != null && o[k] !== '') return o[k];
  }
  return def;
}

// ======================= Data global =======================
let clientesRaw=[], calendarioRaw=[], registros=[], map, markersLayer;
let vendedoresSet = new Set(), gestoresSet = new Set(), empresasSet=new Set();

// ======================= Boot =======================
async function boot(){
  try{
    const [cTxt,uTxt,caTxt] = await Promise.all([
      fetch(URL_CLIENTES).then(r=>r.text()),
      fetch(URL_USUARIOS).then(r=>r.text()),
      fetch(URL_CALENDARIO).then(r=>r.text())
    ]);
    clientesRaw   = csvToObjects(cTxt);
    calendarioRaw = csvToObjects(caTxt);
    buildMerge();
    buildFilters();
    initMap();
    refresh();
  } catch(e){
    console.error(e);
    alert('No se pudieron cargar las hojas. Revisa los enlaces.');
  }
}

// ======================= Merge Calendario + Clientes =======================
function keyFromClient(c){
  return norm(val(c, ['Cod Empresa','cod','codigo','Código','Empresa','empresa']));
}
function keyFromCal(r){
  return norm(val(r, ['Cod Empresa','cod','codigo','Código']));
}

function asFloat(v){ const n = parseFloat(String(v).replace(',','.')); return isFinite(n) ? n : null; }

function buildMerge(){
  // index calendario
  const calIndex = {};
  for(const r of calendarioRaw){
    const k = keyFromCal(r);
    if(!k) continue;
    calIndex[k] = {
      semana: String(val(r,['SEMANA','semana'])).trim(),
      dia:     String(val(r,['DIA','dia'])).trim(),
      vendedor: String(val(r,['vendedor','VENDEDOR'])).trim(),
      gestor:   String(val(r,['gestor_servicio','gestor','GESTOR'])).trim(),
      empresa:  String(val(r,['RazonSocial','Cliente','empresa'])).trim()
    };
  }

  vendedoresSet.clear(); gestoresSet.clear(); empresasSet.clear();
  const out=[];
  for(const c of clientesRaw){
    const k = keyFromClient(c);
    const base = {
      cod: val(c,['Cod Empresa','cod','codigo','Código']),
      cliente: val(c,['Cliente','RazonSocial','nombre','NOMBRE']),
      empresa: val(c,['Empresa','EMPRESA','RazonSocial','Cliente']),
      lat: asFloat(val(c,['lat','Lat','LAT','latitude'])),
      lng: asFloat(val(c,['lng','Lon','LON','longitude']))
    };
    const cal = calIndex[k];
    if (cal){
      const reg = {
        ...base,
        semana: cal.semana || 'SIN DATO',
        dia: cal.dia || 'SIN DATO',
        vendedor: cal.vendedor || 'NO ASIGNADO',
        gestor: cal.gestor || 'NO ASIGNADO',
        estado: 'ASIGNADO'
      };
      out.push(reg);
      vendedoresSet.add(reg.vendedor);
      gestoresSet.add(reg.gestor);
      if (reg.empresa) empresasSet.add(reg.empresa);
    } else {
      const reg = {
        ...base,
        semana: 'Por asignar',
        dia: 'Por asignar',
        vendedor: val(c,['vendedor','VENDEDOR']) || 'NO ASIGNADO',
        gestor:   val(c,['gestor_servicio','gestor','GESTOR']) || 'NO ASIGNADO',
        estado: 'NO_ASIGNADO'
      };
      out.push(reg);
      if (reg.vendedor) vendedoresSet.add(reg.vendedor);
      if (reg.gestor) gestoresSet.add(reg.gestor);
      if (reg.empresa) empresasSet.add(reg.empresa);
    }
  }
  registros = out;
}

// ======================= UI: Filters =======================
function buildFilters(){
  const fVendedor = document.getElementById('fVendedor');
  const fGestor = document.getElementById('fGestor');
  const fEmpresa = document.getElementById('fEmpresa');
  for(const v of Array.from(vendedoresSet).sort()){
    if(!v || v==='NO ASIGNADO') continue;
    const opt = document.createElement('option'); opt.textContent=v; fVendedor.appendChild(opt);
  }
  for(const g of Array.from(gestoresSet).sort()){
    if(!g || g==='NO ASIGNADO') continue;
    const opt = document.createElement('option'); opt.textContent=g; fGestor.appendChild(opt);
  }
  for(const e of Array.from(empresasSet).sort()){
    const opt = document.createElement('option'); opt.textContent=e; fEmpresa.appendChild(opt);
  }

  ['fSemana','fDia','fVendedor','fGestor','fEmpresa','fBuscar'].forEach(id => {
    document.getElementById(id).addEventListener('input', refresh);
    document.getElementById(id).addEventListener('change', refresh);
  });
}

function getFilters(){
  return {
    semana: document.getElementById('fSemana').value,
    dia: document.getElementById('fDia').value,
    vendedor: document.getElementById('fVendedor').value,
    gestor: document.getElementById('fGestor').value,
    empresa: document.getElementById('fEmpresa').value,
    buscar: document.getElementById('fBuscar').value.trim().toLowerCase()
  };
}

function applyFilters(arr, f){
  return arr.filter(r => {
    if (f.semana && (r.semana !== f.semana)) return false;
    if (f.dia && (r.dia !== f.dia)) return false;
    if (f.vendedor && (r.vendedor !== f.vendedor)) return false;
    if (f.gestor && (r.gestor !== f.gestor)) return false;
    if (f.empresa && (r.empresa !== f.empresa)) return false;
    if (f.buscar){
      const s = (r.cod+' '+r.cliente+' '+(r.empresa||'')+' '+r.vendedor+' '+r.gestor).toLowerCase();
      if (!s.includes(f.buscar)) return false;
    }
    return true;
  });
}

// ======================= Map =======================
function initMap(){
  map = L.map('map', {scrollWheelZoom:true, zoomControl:true});
  map.setView([18.7357, -70.1627], 8); // RD
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

function colorFor(vendedor){
  if (!vendedor || vendedor==='NO ASIGNADO') return '#9aa3ad';
  const hash = Array.from(vendedor).reduce((a,ch)=> (a*31+ch.charCodeAt(0))>>>0 , 7);
  const hues = [190,210,230,260,280,300,150,170,200];
  const h = hues[hash % hues.length];
  return `hsl(${h} 85% 55%)`;
}

function putMarkers(list){
  markersLayer.clearLayers();
  const bounds=[];
  list.forEach(r => {
    if (r.lat==null || r.lng==null) return;
    const color = colorFor(r.vendedor);
    const icon = L.divIcon({
      html:`<div style="width:18px;height:18px;border-radius:50%;background:${color};border:2px solid #0a1a27;box-shadow:0 0 0 2px rgba(255,255,255,.15)"></div>`,
      className:'', iconSize:[18,18]
    });
    const m = L.marker([r.lat, r.lng], {icon}).bindPopup(`<b>${r.cliente}</b><br>Cod: ${r.cod}<br>Vendedor: ${r.vendedor}<br>Gestor: ${r.gestor}<br>Semana: ${r.semana} · Día: ${r.dia}`);
    markersLayer.addLayer(m);
    bounds.push([r.lat,r.lng]);
  });
  if (bounds.length){
    const b = L.latLngBounds(bounds);
    map.fitBounds(b.pad(0.2), {animate:true});
  } else {
    map.setView([18.7357, -70.1627], 8);
  }
}

// ======================= Render =======================
function refresh(){
  const f = getFilters();
  const list = applyFilters(registros, f);
  // stats
  document.getElementById('stats').innerHTML = `
    <span class="chip">Total: ${registros.length}</span>
    <span class="chip">Filtrados: ${list.length}</span>
    <span class="chip">Con coordenadas: ${list.filter(x=>x.lat!=null && x.lng!=null).length}</span>
  `;

  // table
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML='';
  list.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.cod||''}</td><td>${r.cliente||''}</td><td>${r.semana}</td><td>${r.dia}</td><td>${r.vendedor}</td><td>${r.gestor}</td><td>${r.empresa||''}</td>`;
    tbody.appendChild(tr);
  });

  putMarkers(list);
}
</script>
</body>
</html>
