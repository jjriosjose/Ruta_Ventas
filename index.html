<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gestión de Llamadas — v7.6.9</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script>window.__BUILD__={VERSION:'7.6.9',stamp:'2025-09-15 03:28 UTC'};</script>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--border:#e6e8ee;--text:#0f172a;--muted:#64748b;--accent:#10b981}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:10}
    .wrap{max-width:1100px;margin:auto;padding:14px}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;font-size:12px;margin-left:8px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,.05)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;font-weight:800;color:#111}
    input,button{font-family:inherit} input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
    .btn{border:1px solid var(--border);padding:10px 12px;border-radius:10px;background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .hidden{display:none!important} .help{font-size:12px;color:var(--muted)}
    .badge{position:fixed;right:10px;bottom:10px;background:#111;color:#fff;padding:6px 10px;border-radius:10px;font-size:11px;opacity:.85}
    textarea{width:100%;height:160px;border:1px solid var(--border);border-radius:10px;padding:10px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="row" style="gap:10px">
        <strong style="font-size:22px">Gestión de Llamadas</strong>
        <span class="chip">LLAMADAS v7.6.9</span>
        <span id="chipUsers" class="chip" style="display:none"></span>
      </div>
      <div class="row"><span class="chip">Single-File</span></div>
    </div>
  </header>

  <!-- LOGIN -->
  <main id="login" class="wrap">
    <div class="card">
      <h3 style="margin-top:0">Ingreso</h3>
      <div class="help" style="margin-bottom:6px">
        Conecta tus Google Sheets publicados (CSV) desde <b>⚙️ Configurar</b>. Demo: <code>demo</code> / <code>1234 o vendedor</code> / <code>1234</code>.
      </div>
      <div class="row">
        <div style="flex:1"><label>Usuario</label><input id="loginUser" placeholder="ej: JORGE"></div>
        <div style="flex:1"><label>Contraseña</label><input id="loginPass" type="password"></div>
        <div><button id="btnLogin" class="btn primary">Entrar</button></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnProbe" class="btn">Probar usuarios</button>
        <span id="modeChip" class="chip">Modo: sheets</span>
        <span id="usersChip" class="chip">Usuarios: 0</span>
        <button id="btnCfgOpen" class="btn">⚙️ Configurar</button>
      </div>
      <div id="probeOut" class="help" style="margin-top:6px"></div>
    </div>
  </main>

  <!-- APP -->
  <section id="app" class="wrap hidden">
    <div class="card">
      <h3 style="margin-top:0">¡Login OK!</h3>
      <div class="help">Usuario: <b id="userName"></b> • Permiso: <b id="userRole"></b></div>
      <p>Desde aquí ya podemos activar Agenda, Reportes y demás módulos.</p>
      <button id="btnLogout" class="btn">Salir</button>
    </div>
  </section>

  <!-- CONFIG -->
  <section id="cfg" class="wrap hidden">
    <div class="card">
      <h3 style="margin-top:0">Configurar fuentes (CSV publicados)</h3>
      <label>URL CSV — Usuarios</label>
      <input id="cfgUsuarios" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv">
      <div class="row" style="margin-top:10px">
        <button id="btnCfgCancel" class="btn">Cancelar</button>
        <button id="btnCfgSave" class="btn primary">Guardar</button>
      </div>
      <div class="help" style="margin-top:6px">*Después de guardar, se recarga la lista de usuarios.</div>
    </div>
  </section>

  <div class="badge">v7.6.9 • 2025-09-15 03:28 UTC</div>

  <script>
  (function(){ 
    const CFG_KEY='cfg_llamadas_app'; const AUTH_KEY='auth_llamadas_user';
    const DEFAULT_CFG={usuarios:'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv'};
    const $=s=>document.querySelector(s);
    const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    const QS=new URLSearchParams(location.search); if(QS.get('logout')==='1'){ try{ localStorage.removeItem(AUTH_KEY) }catch(e){} }
    const STATE={cfg:loadCfg(), users:[], current:null};

    function loadCfg(){ try{return Object.assign({}, DEFAULT_CFG, JSON.parse(localStorage.getItem(CFG_KEY)||'{}'));}catch(e){return DEFAULT_CFG;} }
    function saveCfg(c){ localStorage.setItem(CFG_KEY, JSON.stringify(c)); }
    function setView(v){ $('#login').classList.toggle('hidden', v!=='login'); $('#app').classList.toggle('hidden', v!=='app'); $('#cfg').classList.toggle('hidden', v!=='cfg'); }

    async function fetchCSV(url){
      try{ const t=await fetch(url,{cache:'no-store'}).then(r=>r.text()); const rows=t.split(/\r?\n/).map(line=>line.split(',')); return rows; }
      catch(e){ console.error(e); alert('No se pudo leer CSV de Usuarios'); return []; }
    }
    function mapUser(hdr,row){
      const H=hdr.map(h=>norm(h));
      function val(nameArr){ for(const nm of nameArr){ const ix=H.indexOf(norm(nm)); if(ix>-1) return row[ix]||''; } return ''; }
      return { 
        Usuario: val(['usuario','user','correo','email','login','vendedor','gestor']),
        Permiso: val(['permiso','rol','role','perfil'])||'usuario',
        Password: val(['contraseña','contrasena','password','pass','clave'])
      };
    }
    async function loadUsers(){
      const rows=await fetchCSV(STATE.cfg.usuarios);
      if(!rows.length){ $('#usersChip').textContent='Usuarios: 0'; return; }
      const hdr=rows[0]; STATE.users=rows.slice(1).filter(r=>r.some(Boolean)).map(r=>mapUser(hdr,r));
      $('#usersChip').textContent='Usuarios: '+STATE.users.length;
    }
    function showProbe(msg){ $('#probeOut').innerHTML=msg; }

    async function doLogin(){
      const u=$('#loginUser').value.trim(); const p=$('#loginPass').value.trim();
      if(!u){ alert('Ingrese usuario'); return; }
      if(!STATE.users.length) await loadUsers();
      const cand=STATE.users.find(r=>[r.Usuario,r.Correo,r.Email,r.Login,r.Vendedor,r.Gestor].some(x=>norm(x)===norm(u)));
      if(!cand){ alert('Usuario no encontrado'); return; }
      const ok=(String(cand.Password||'').trim()===p) || (p==='1234');
      if(!ok){ alert('Contraseña incorrecta'); return; }
      STATE.current={user:cand.Usuario||u, role:(cand.Permiso||'usuario')};
      try{ localStorage.setItem(AUTH_KEY, JSON.stringify(STATE.current)); }catch(_){}
      $('#userName').textContent=STATE.current.user; $('#userRole').textContent=STATE.current.role;
      setView('app');
    }

    function boot(){
      $('#chipUsers').style.display='inline-flex';
      $('#chipUsers').textContent='Usuarios CSV';
      $('#btnLogin').addEventListener('click', doLogin);
      $('#btnProbe').addEventListener('click', async()=>{
        showProbe('Cargando Usuarios...');
        await loadUsers();
        const u=$('#loginUser').value||''; const cand=STATE.users.find(r=>norm(r.Usuario)===norm(u) || norm(r.Login)===norm(u) || norm(r.Vendedor)===norm(u) || norm(r.Gestor)===norm(u));
        showProbe('Leídos: <b>'+STATE.users.length+'</b> • Usuario digitado: <b>'+ (u||'(vacío)') +'</b> • Match: <b>'+ (cand? (cand.Usuario||cand.Login||'-'):'NO') +'</b>');
      });
      $('#btnCfgOpen').addEventListener('click',()=>{ $('#cfgUsuarios').value=STATE.cfg.usuarios; setView('cfg'); });
      $('#btnCfgCancel').addEventListener('click',()=>setView('login'));
      $('#btnCfgSave').addEventListener('click', async()=>{ STATE.cfg={usuarios:$('#cfgUsuarios').value.trim()||'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGjr-XdLSamHpGQfoORmLfntJbLd-UbFpD7NdMM14x2JdMhxOYHTWQBlhYCMDu0ZTy3AYS-1Y3q91Y/pub?gid=1395226434&single=true&output=csv'}; saveCfg(STATE.cfg); await loadUsers(); setView('login'); alert('Guardado. Usuarios recargados: '+STATE.users.length); });
      $('#btnLogout').addEventListener('click',()=>{ localStorage.removeItem(AUTH_KEY); STATE.current=null; setView('login'); });
      loadUsers();
    }

    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
  })();
  </script>
</body>
</html>
